<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Comprehensive Tax Calculator</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- Shared Dashboard Libraries -->
    <script src="constants.js"></script>
    <script src="state-tax-data.js"></script>
    <script src="state-manager.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <script>
        // Configure Tailwind CSS - Updated to match Moment Planner branding
        tailwind.config = {
            mode: 'jit',
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#F9F9F7',       // Light cream background (matches Moment Planner)
                        'brand-card': '#FFFFFF',     // White for panels
                        'brand-navy': '#00205B',     // Primary navy blue
                        'brand-gold': '#D4AF37',     // RBC Gold accent
                        'brand-gold-hover': '#b5952f',
                        'brand-text': '#1f2937',     // Dark gray text
                        'brand-muted': '#6b7280',    // Gray text for secondary info
                        'brand-section': '#f8fafc',  // Light gray for sections
                    },
                    fontFamily: {
                        'serif': ['Merriweather', 'serif'],
                        'sans': ['Open Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Global Overrides for Light Mode - Matching Moment Planner */
        body {
            background-color: #F9F9F7;
            color: #1f2937;
            font-family: 'Open Sans', sans-serif;
            /* Subtle background pattern matching Moment Planner */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2300205B' fill-opacity='0.02' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Custom Scrollbar to match theme */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #F9F9F7;
        }

        ::-webkit-scrollbar-thumb {
            background: #00205B;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #D4AF37;
        }

        input[type="checkbox"] {
            accent-color: #00205B;
            cursor: pointer;
            width: 1.25rem;
            height: 1.25rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 32, 91, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        /* PDF Download button pulse animation */
        @keyframes pulse-gold {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(212, 175, 55, 0);
            }
        }

        .pulse-gold:hover {
            animation: pulse-gold 1.5s infinite;
        }

        /* Ensure inputs have good contrast */
        input,
        select,
        textarea {
            background-color: white !important;
            color: #1f2937 !important;
        }

        /* Mobile responsiveness improvements */
        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column;
            }

            .mobile-full-width {
                width: 100% !important;
            }

            /* Smaller text on mobile for tables */
            table {
                font-size: 0.75rem;
            }

            table th,
            table td {
                padding: 0.5rem 0.25rem;
            }

            /* Better touch targets */
            input,
            select,
            button {
                min-height: 44px;
            }

            /* Reduce padding on mobile */
            .p-6 {
                padding: 1rem;
            }

            .px-6 {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }

        /* Smooth transitions for interactive elements */
        input:focus,
        select:focus,
        textarea:focus {
            transform: scale(1.01);
            transition: transform 0.15s ease-out;
        }

        /* Math expression hint */
        input[type="text"]::placeholder {
            font-size: 0.75rem;
            color: #9ca3af;
        }
    </style>
</head>

<body>

    <div id="root"></div>

    <script type="text/babel">
        // ** Comprehensive Effective Tax Calculator - FULL Federal & State Logic (V5.0) **
        // UPDATES: Added After-Tax 401k (Mega Backdoor) with 415(c) validation (distinguishing catch-up), Employer Match inputs, Split W2 income, Individual FICA calculation, Separated SIMPLE IRA.

        // --- Data Constants (2026) ---
        const CURRENT_TAX_YEAR = FinancialConstants.currentYear || new Date().getFullYear();

        // Federal Ordinary Income Tax Brackets - sourced from constants.js
        const FEDERAL_TAX_BRACKETS = FinancialConstants.federalBrackets;
        // Long-Term Capital Gains & Qualified Dividends Brackets - sourced from constants.js
        const LTCG_BRACKETS = FinancialConstants.capitalGainsBrackets;
        // Social Security Taxation Thresholds - sourced from constants.js
        // Note: constants.js uses {lower, upper}, this adapts to {first, second}
        const SS_TAX_THRESHOLDS = {
            single: { first: FinancialConstants.socialSecurity.taxationThresholds.single.lower, second: FinancialConstants.socialSecurity.taxationThresholds.single.upper },
            mfj: { first: FinancialConstants.socialSecurity.taxationThresholds.mfj.lower, second: FinancialConstants.socialSecurity.taxationThresholds.mfj.upper },
            mfs: { first: 0, second: 0 },
            hoh: { first: FinancialConstants.socialSecurity.taxationThresholds.single.lower, second: FinancialConstants.socialSecurity.taxationThresholds.single.upper },
        };

        // FICA & Self-Employment Constants - sourced from constants.js
        const SOCIAL_SECURITY_RATE_EMPLOYEE = FinancialConstants.fica.socialSecurityRate;
        const MEDICARE_RATE_EMPLOYEE = FinancialConstants.fica.medicareRate;
        const SOCIAL_SECURITY_WAGE_BASE = FinancialConstants.fica.socialSecurityWageBase;
        const ADDITIONAL_MEDICARE_TAX_RATE = FinancialConstants.fica.medicareAdditionalRate;
        const ADDITIONAL_MEDICARE_TAX_THRESHOLDS = FinancialConstants.fica.medicareAdditionalThreshold;

        // Net Investment Income Tax (NIIT) - sourced from constants.js
        const NIIT_RATE = FinancialConstants.niit.rate;
        const NIIT_THRESHOLDS = FinancialConstants.niit.threshold;

        // Tax Calculation Constants (magic numbers extracted)
        const MEDICAL_EXPENSE_AGI_FLOOR = 0.075; // 7.5% of AGI
        const CHARITABLE_CONTRIBUTION_AGI_LIMIT = 0.60; // 60% of AGI max
        const SE_TAX_NET_EARNINGS_FACTOR = 0.9235; // 92.35% of gross SE income
        const SE_TAX_DEDUCTION_FACTOR = 0.5; // 50% of SE tax deductible
        const SEP_IRA_CONTRIBUTION_RATE = 0.20; // 20% of net earnings
        const AMT_EXEMPTION_PHASEOUT_RATE = 0.25; // 25 cents per dollar over threshold

        // Input Validation Constants
        const MIN_BIRTH_YEAR = 1900;
        const MAX_BIRTH_YEAR = FinancialConstants.currentYear || new Date().getFullYear();
        const MEDICARE_ENROLLMENT_AGE = 65; // Age at which HSA contributions prohibited

        // Standard Deductions - sourced from constants.js
        const STANDARD_DEDUCTIONS = {
            single: FinancialConstants.standardDeduction.single,
            mfj: FinancialConstants.standardDeduction.mfj,
            mfs: FinancialConstants.standardDeduction.mfs,
            hoh: FinancialConstants.standardDeduction.hoh,
        };
        const EXISTING_ADDITIONAL_DEDUCTION_65_PLUS_SINGLE_HOH = FinancialConstants.standardDeduction.additionalSingleHOH;
        const EXISTING_ADDITIONAL_DEDUCTION_65_PLUS_MFJ_MFS = FinancialConstants.standardDeduction.additionalMFJ;

        /**
         * SALT Deduction Constants (OBBBA) - sourced from constants.js
         */
        const SALT_DEDUCTION_LIMIT = FinancialConstants.salt.limit;
        const SALT_DEDUCTION_LIMIT_MFS = FinancialConstants.salt.limitMFS;
        const SALT_PHASEDOWN_THRESHOLD = FinancialConstants.salt.phasedownThreshold;
        const SALT_PHASEDOWN_RATE = FinancialConstants.salt.phasedownRate;
        const SALT_PHASEDOWN_FLOOR = FinancialConstants.salt.phasedownFloor;

        // Student Loan Interest - sourced from constants.js
        const STUDENT_LOAN_INTEREST_MAX = FinancialConstants.education.studentLoanInterestDeduction.max;
        const STUDENT_LOAN_PHASEOUTS = {
            single: { min: FinancialConstants.education.studentLoanInterestDeduction.phaseout.single.start, max: FinancialConstants.education.studentLoanInterestDeduction.phaseout.single.end },
            mfj: { min: FinancialConstants.education.studentLoanInterestDeduction.phaseout.mfj.start, max: FinancialConstants.education.studentLoanInterestDeduction.phaseout.mfj.end },
            hoh: { min: FinancialConstants.education.studentLoanInterestDeduction.phaseout.single.start, max: FinancialConstants.education.studentLoanInterestDeduction.phaseout.single.end },
            mfs: { min: 0, max: 0 }, // MFS cannot claim this deduction
        };

        // Child Tax Credit (OBBBA) - sourced from constants.js
        const CHILD_TAX_CREDIT_AMOUNT = FinancialConstants.childTaxCredit.amount;
        const CHILD_TAX_CREDIT_PHASEOUT_MFJ = FinancialConstants.childTaxCredit.phaseoutThresholdMFJ;
        const CHILD_TAX_CREDIT_PHASEOUT_OTHER = FinancialConstants.childTaxCredit.phaseoutThresholdOther;
        const CHILD_TAX_CREDIT_PHASEOUT_RATE_PER_1000 = FinancialConstants.childTaxCredit.phaseoutRatePer1000;

        // Alternative Minimum Tax (AMT) - sourced from constants.js
        const AMT_EXEMPTION = FinancialConstants.amt.exemption;
        const AMT_EXEMPTION_PHASEOUT_THRESHOLD = FinancialConstants.amt.phaseoutThreshold;
        const AMT_RATES = [
            { rate: 0.26, max: FinancialConstants.amt.breakpoint },
            { rate: 0.28, max: Infinity },
        ];

        // Retirement & Contribution Limits - sourced from constants.js
        const CONTRIBUTION_LIMITS = {
            '401k_regular': FinancialConstants.retirementLimits.elective401k,
            '401k_catchup': FinancialConstants.retirementLimits.catchUp401k,
            '401k_catchup_60_63': FinancialConstants.retirementLimits.catchUp401kSuper,
            'ira_regular': FinancialConstants.retirementLimits.iraContribution,
            'ira_catchup': FinancialConstants.retirementLimits.iraCatchUp,
            'hsa_self_only': FinancialConstants.healthcare.hsaIndividual,
            'hsa_family': FinancialConstants.healthcare.hsaFamily,
            'hsa_catchup': FinancialConstants.healthcare.hsaCatchUp,
            'simple_regular': FinancialConstants.retirementLimits.simple,
            'simple_catchup': FinancialConstants.retirementLimits.simpleCatchUp,
        };

        // Section 415 Limits - sourced from constants.js
        const SECTION_415C_LIMIT = FinancialConstants.section415.totalDCLimit;
        const COMPENSATION_LIMIT = FinancialConstants.section415.compensationLimit;

        // IRA/Roth Phaseouts - sourced from constants.js
        const IRA_PHASEOUT_SINGLE_COVERED_BY_PLAN = { min: FinancialConstants.retirementLimits.iraDeductionPhaseout.single.start, max: FinancialConstants.retirementLimits.iraDeductionPhaseout.single.end };
        const IRA_PHASEOUT_MFJ_CONTRIBUTOR_COVERED_BY_PLAN = { min: FinancialConstants.retirementLimits.iraDeductionPhaseout.mfj_covered.start, max: FinancialConstants.retirementLimits.iraDeductionPhaseout.mfj_covered.end };
        const IRA_PHASEOUT_MFJ_NON_CONTRIBUTOR_SPOUSE_COVERED_BY_PLAN = { min: FinancialConstants.retirementLimits.iraDeductionPhaseout.mfj_spouse_covered.start, max: FinancialConstants.retirementLimits.iraDeductionPhaseout.mfj_spouse_covered.end };
        const IRA_PHASEOUT_MFS_COVERED_BY_PLAN = { min: FinancialConstants.retirementLimits.iraDeductionPhaseout.mfs.start, max: FinancialConstants.retirementLimits.iraDeductionPhaseout.mfs.end };
        const ROTH_IRA_PHASEOUT_SINGLE_HOH = { min: FinancialConstants.retirementLimits.rothPhaseout.single.start, max: FinancialConstants.retirementLimits.rothPhaseout.single.end };
        const ROTH_IRA_PHASEOUT_MFJ = { min: FinancialConstants.retirementLimits.rothPhaseout.mfj.start, max: FinancialConstants.retirementLimits.rothPhaseout.mfj.end };
        const ROTH_IRA_PHASEOUT_MFS = { min: FinancialConstants.retirementLimits.rothPhaseout.mfs.start, max: FinancialConstants.retirementLimits.rothPhaseout.mfs.end };

        // OBBBA Below-The-Line Deductions - sourced from constants.js
        const OBBBA_ADDITIONAL_DEDUCTION_65_PLUS = FinancialConstants.obbba.senior65Plus.amount;
        const OBBBA_65_PLUS_DEDUCTION_PHASEOUT_SINGLE_THRESHOLD = FinancialConstants.obbba.senior65Plus.phaseoutThresholdSingle;
        const OBBBA_65_PLUS_DEDUCTION_PHASEOUT_JOINT_THRESHOLD = FinancialConstants.obbba.senior65Plus.phaseoutThresholdMFJ;
        const OBBBA_65_PLUS_DEDUCTION_PHASEOUT_RATE = FinancialConstants.obbba.senior65Plus.phaseoutRate;
        const OBBBA_TIPS_DEDUCTION_MAX = FinancialConstants.obbba.tips.maxDeduction;
        const OBBBA_TIPS_DEDUCTION_PHASEOUT_SINGLE_HOH_THRESHOLD = FinancialConstants.obbba.tips.phaseoutThresholdSingleHOH;
        const OBBBA_TIPS_DEDUCTION_PHASEOUT_JOINT_THRESHOLD = FinancialConstants.obbba.tips.phaseoutThresholdMFJ;
        const OBBBA_TIPS_DEDUCTION_PHASEOUT_RATE = FinancialConstants.obbba.tips.phaseoutRate;
        const OBBBA_OVERTIME_DEDUCTION_MAX_SINGLE_HOH = FinancialConstants.obbba.overtime.maxSingleHOH;
        const OBBBA_OVERTIME_DEDUCTION_MAX_JOINT = FinancialConstants.obbba.overtime.maxMFJ;
        const OBBBA_OVERTIME_DEDUCTION_PHASEOUT_SINGLE_HOH_THRESHOLD = FinancialConstants.obbba.overtime.phaseoutThresholdSingleHOH;
        const OBBBA_OVERTIME_DEDUCTION_PHASEOUT_JOINT_THRESHOLD = FinancialConstants.obbba.overtime.phaseoutThresholdMFJ;
        const OBBBA_OVERTIME_DEDUCTION_PHASEOUT_RATE = FinancialConstants.obbba.overtime.phaseoutRate;
        const OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_MAX = FinancialConstants.obbba.autoLoanInterest.maxDeduction;
        const OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_PHASEOUT_SINGLE_THRESHOLD = FinancialConstants.obbba.autoLoanInterest.phaseoutThresholdSingle;
        const OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_PHASEOUT_JOINT_THRESHOLD = FinancialConstants.obbba.autoLoanInterest.phaseoutThresholdMFJ;
        const OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_PHASEOUT_RATE = FinancialConstants.obbba.autoLoanInterest.phaseoutRate;

        // Social Security Earnings Test - sourced from constants.js
        const SS_EARNINGS_LIMIT_UNDER_FRA = FinancialConstants.ssEarningsTest.underFRALimit;
        const SS_EARNINGS_LIMIT_FRA_YEAR = FinancialConstants.ssEarningsTest.fraYearLimit;
        const SS_REDUCTION_RATE_UNDER_FRA = FinancialConstants.ssEarningsTest.reductionRateUnderFRA;
        const SS_REDUCTION_RATE_FRA_YEAR = FinancialConstants.ssEarningsTest.reductionRateFRAYear;

        // IRMAA Thresholds - sourced from constants.js
        const STANDARD_PREMIUM = FinancialConstants.irmaa.standardPremium;
        const IRMAA_THRESHOLDS = FinancialConstants.irmaa.thresholds;
        // State Tax Data - sourced from state-tax-data.js
        const STATE_TAX_DATA = StateTaxData;

        // QBI Deduction Constants - sourced from constants.js
        const QBI_THRESHOLDS = FinancialConstants.qbi.thresholds;

        // Passive Activity Loss (PAL) Limitation Constants - sourced from constants.js
        const PAL_AGI_PHASEOUT = FinancialConstants.passiveActivityLoss.agiPhaseout;
        const PAL_MAX_DEDUCTION = FinancialConstants.passiveActivityLoss.maxDeduction;

        // --- React Components ---

        const Tooltip = ({ text }) => {
            const [show, setShow] = React.useState(false);
            return (
                <div className="relative inline-block ml-2">
                    <span
                        // Updated: Navy color for the icon
                        className="cursor-pointer text-brand-navy/70 hover:text-brand-navy text-lg"
                        onMouseEnter={() => setShow(true)}
                        onMouseLeave={() => setShow(false)}
                    >
                        &#9432; {/* Unicode for circled 'i' */}
                    </span>
                    {show && (
                        // Updated: White background, Navy border, Dark text
                        <div className="absolute z-50 w-64 p-3 -mt-20 -ml-32 text-sm text-gray-800 bg-white border-2 border-brand-navy rounded-lg shadow-xl">
                            {text}
                        </div>
                    )}
                </div>
            );
        };

        const MethodologyModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="bg-white p-8 rounded-xl max-w-2xl w-full border-t-4 border-brand-gold overflow-y-auto max-h-[90vh] shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                            <h2 className="text-2xl font-bold text-brand-navy font-serif">Calculation Methodology</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-brand-navy text-2xl">&times;</button>
                        </div>
                        <div className="space-y-4 text-gray-700 text-sm leading-relaxed">
                            <p><strong className="text-brand-navy">1. Gross Income Aggregation:</strong> We sum all income sources (W2, Self-Employment, Capital Gains, Dividends, etc.).</p>
                            <p><strong className="text-brand-navy">2. Adjusted Gross Income (AGI):</strong> We subtract "above-the-line" deductions (401k, HSA, 1/2 SE Tax) from Gross Income. This determines eligibility for most credits.</p>
                            <p><strong className="text-brand-navy">3. Taxable Income:</strong> We subtract either the Standard Deduction or Itemized Deductions (SALT, Mortgage Interest, Charity) and QBI from AGI.</p>
                            <p><strong className="text-brand-navy">4. Federal Tax Calculation:</strong>
                                <ul className="list-disc pl-5 mt-1 text-gray-600">
                                    <li>Ordinary Income is taxed at 2026 progressive marginal rates.</li>
                                    <li>LTCG & Qualified Dividends are taxed at preferential rates (0%, 15%, 20%).</li>
                                    <li><strong>AMT Check:</strong> We simultaneously calculate Alternative Minimum Tax. If AMT &gt; Regular Tax, the difference is added.</li>
                                </ul>
                            </p>
                            <p><strong className="text-brand-navy">5. Credits & Surtaxes:</strong> Child Tax Credit is subtracted. NIIT (3.8%) and Additional Medicare Tax (0.9%) are added.</p>
                            <p><strong className="text-brand-navy">6. State Tax:</strong> Estimated based on specific state rules applied to federal inputs.</p>
                        </div>
                        <button onClick={onClose} className="mt-6 bg-brand-navy text-white font-bold py-2 px-6 rounded hover:bg-brand-navy/90 w-full transition-colors">Close</button>
                    </div>
                </div>
            );
        };

        // =====================================================
        // 2026 KEY NUMBERS - HARD CODED FROM PDF
        // =====================================================
        const KEY_NUMBERS_2026 = {
            incomeTax: {
                single: [
                    { range: 'Up to $12,400', taxDue: '$0', rate: '10%' },
                    { range: '$12,401 to $50,400', taxDue: '$1,240.00', rate: '12%' },
                    { range: '$50,401 to $105,700', taxDue: '$5,800.00', rate: '22%' },
                    { range: '$105,701 to $201,775', taxDue: '$17,966.00', rate: '24%' },
                    { range: '$201,776 to $256,225', taxDue: '$41,024.00', rate: '32%' },
                    { range: '$256,226 to $640,600', taxDue: '$58,448.00', rate: '35%' },
                    { range: 'Over $640,600', taxDue: '$192,979.25', rate: '37%' }
                ],
                marriedFilingJointly: [
                    { range: 'Up to $24,800', taxDue: '$0', rate: '10%' },
                    { range: '$24,801 to $100,800', taxDue: '$2,480.00', rate: '12%' },
                    { range: '$100,801 to $211,400', taxDue: '$11,600.00', rate: '22%' },
                    { range: '$211,401 to $403,550', taxDue: '$35,932.00', rate: '24%' },
                    { range: '$403,551 to $512,450', taxDue: '$82,048.00', rate: '32%' },
                    { range: '$512,451 to $768,700', taxDue: '$116,896.00', rate: '35%' },
                    { range: 'Over $768,700', taxDue: '$206,583.50', rate: '37%' }
                ],
                marriedFilingSeparately: [
                    { range: 'Up to $12,400', taxDue: '$0', rate: '10%' },
                    { range: '$12,401 to $50,400', taxDue: '$1,240.00', rate: '12%' },
                    { range: '$50,401 to $105,700', taxDue: '$5,800.00', rate: '22%' },
                    { range: '$105,701 to $201,775', taxDue: '$17,966.00', rate: '24%' },
                    { range: '$201,776 to $256,225', taxDue: '$41,024.00', rate: '32%' },
                    { range: '$256,226 to $384,350', taxDue: '$58,448.00', rate: '35%' },
                    { range: 'Over $384,350', taxDue: '$103,291.75', rate: '37%' }
                ],
                headOfHousehold: [
                    { range: 'Up to $17,700', taxDue: '$0', rate: '10%' },
                    { range: '$17,701 to $67,450', taxDue: '$1,770.00', rate: '12%' },
                    { range: '$67,451 to $105,700', taxDue: '$7,740.00', rate: '22%' },
                    { range: '$105,701 to $201,750', taxDue: '$16,155.00', rate: '24%' },
                    { range: '$201,751 to $256,200', taxDue: '$39,207.00', rate: '32%' },
                    { range: '$256,201 to $640,600', taxDue: '$56,631.00', rate: '35%' },
                    { range: 'Over $640,600', taxDue: '$191,171.00', rate: '37%' }
                ]
            },
            standardDeduction: {
                single: '$16,100',
                marriedFilingJointly: '$32,200',
                marriedFilingSeparately: '$16,100',
                headOfHousehold: '$24,150',
                dependent: '$1,350*',
                dependentNote: '*Dependent standard deduction can\'t exceed the greater of $1,350 or $450 plus earned income.',
                additionalBlindOrAged: { singleOrHOH: '$2,050', marriedFilingJointlyOrSeparately: '$1,650' },
                seniorDeduction: { amount: '$6,000', note: '**Reduced by 6% of income exceeding $75,000 ($150,000 married filing jointly)' }
            },
            amt: {
                singleOrHOH: { exemption: '$90,100', phaseout: '$500,000' },
                marriedFilingJointly: { exemption: '$140,200', phaseout: '$1,000,000' },
                marriedFilingSeparately: { exemption: '$70,100', phaseout: '$500,000' },
                rates: '26% rate applies to AMT income up to $244,500 ($122,250 if married filing separately); 28% rate applies to AMT income over this amount'
            },
            educationCredits: {
                lifetimeLearning: { maxCredit: '$2,000', singlePhaseout: '$80,000 to $90,000', marriedPhaseout: '$160,000 to $180,000' },
                americanOpportunity: { maxCredit: '$2,500', singlePhaseout: '$80,000 to $90,000', marriedPhaseout: '$160,000 to $180,000' },
                educationLoanInterest: { maxDeduction: '$2,500', singlePhaseout: '$85,000 to $100,000', marriedPhaseout: '$175,000 to $205,000' },
                savingsBondExclusion: { singlePhaseout: '$101,800 to $116,800', marriedPhaseout: '$152,650 to $182,650' }
            },
            estatePlanning: {
                annualGiftTaxExclusion: '$19,000',
                noncitzenSpouseGiftExclusion: '$194,000',
                topGiftEstateGSTRate: '40%',
                giftEstateTaxExclusionAmount: '$15,000,000 + DSUEA*',
                gstTaxExemption: '$15,000,000**',
                notes: ['*Basic exclusion amount plus deceased spousal unused exclusion amount (exclusion is portable).', '**The GST tax exemption is not portable.']
            },
            retirement: {
                traditionalIRAPhaseout: { singleOrHOH: '$81,000 to $91,000', marriedJointlyCovered: '$129,000 to $149,000', marriedJointlyNotCovered: '$242,000 to $252,000', marriedFilingSeparately: 'Up to $10,000' },
                rothIRAPhaseout: { singleOrHOH: '$153,000 to $168,000', marriedFilingJointly: '$242,000 to $252,000', marriedFilingSeparately: 'Up to $10,000' },
                employerPlans: { regular401k403b457b: '$24,500', catchUp50Plus: '$8,000', catchUp60to63: '$11,250', simpleRegular: '$17,000', simpleCatchUp50Plus: '$4,000', simpleCatchUp60to63: '$5,250' },
                iraLimits: { traditionalRothCombined: '$7,500', catchUp50Plus: '$1,100' }
            },
            investmentTaxes: {
                capitalGains: {
                    single: [{ range: 'Up to $49,450', rate: '0%' }, { range: '$49,451 to $545,500', rate: '15%' }, { range: 'Over $545,500', rate: '20%' }],
                    marriedFilingJointly: [{ range: 'Up to $98,900', rate: '0%' }, { range: '$98,901 to $613,700', rate: '15%' }, { range: 'Over $613,700', rate: '20%' }],
                    marriedFilingSeparately: [{ range: 'Up to $49,450', rate: '0%' }, { range: '$49,451 to $306,850', rate: '15%' }, { range: 'Over $306,850', rate: '20%' }],
                    headOfHousehold: [{ range: 'Up to $66,200', rate: '0%' }, { range: '$66,201 to $579,600', rate: '15%' }, { range: 'Over $579,600', rate: '20%' }]
                },
                niit: { rate: '3.8%', thresholds: { single: 'Over $200,000', marriedFilingJointly: 'Over $250,000', marriedFilingSeparately: 'Over $125,000', headOfHousehold: 'Over $200,000' }, note: 'The 3.8% net investment income tax applies to the lesser of (a) net investment income or (b) MAGI exceeding the above thresholds.' }
            },
            healthCare: {
                hsa: { individualContribution: '$4,400', familyContribution: '$8,750', catchUp55Plus: '$1,000' },
                hdhp: { minDeductibleIndividual: '$1,700', minDeductibleFamily: '$3,400', maxOutOfPocketIndividual: '$8,500', maxOutOfPocketFamily: '$17,000' },
                fsa: { maxContribution: '$3,400' }
            },
            socialSecurityMedicare: { socialSecurityMaxEarnings: '$184,500', medicareMaxEarnings: 'No limit' },
            mileageRates: { business: 'TBD', medical: 'TBD', charitable: '14¢ per mile', moving: 'TBD' }
        };

        // KeyNumbersModal Component
        const KeyNumbersModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            const data = KEY_NUMBERS_2026;
            const tableStyle = "w-full text-xs border-collapse mb-4";
            const thStyle = "bg-brand-navy text-white p-2 text-left font-semibold";
            const tdStyle = "p-2 border-b border-gray-200";
            const sectionHeader = "bg-brand-navy text-white p-3 font-bold text-sm mt-4 first:mt-0";
            const subHeader = "bg-brand-gold text-brand-navy p-2 font-semibold text-xs";

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="bg-white rounded-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto shadow-2xl border-t-4 border-brand-gold" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-brand-navy text-white p-4 flex justify-between items-center z-10">
                            <div>
                                <h2 className="text-xl font-bold font-serif">2026 Key Numbers</h2>
                                <p className="text-gray-300 text-xs">Tax reference numbers at a glance</p>
                            </div>
                            <button onClick={onClose} className="text-white hover:text-brand-gold text-3xl font-light">&times;</button>
                        </div>
                        <div className="p-4 space-y-2">
                            {/* Income Tax Brackets */}
                            <div className={sectionHeader}>Income Tax (2026 Tax Rate Tables)</div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div className={subHeader}>Single</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Taxable Income</th><th className={thStyle}>Tax Due</th><th className={thStyle}>Rate</th></tr></thead>
                                        <tbody>{data.incomeTax.single.map((r, i) => <tr key={i} className={i % 2 ? 'bg-gray-50' : ''}><td className={tdStyle}>{r.range}</td><td className={tdStyle}>{r.taxDue}</td><td className={tdStyle}>{r.rate}</td></tr>)}</tbody></table>
                                </div>
                                <div>
                                    <div className={subHeader}>Married Filing Jointly</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Taxable Income</th><th className={thStyle}>Tax Due</th><th className={thStyle}>Rate</th></tr></thead>
                                        <tbody>{data.incomeTax.marriedFilingJointly.map((r, i) => <tr key={i} className={i % 2 ? 'bg-gray-50' : ''}><td className={tdStyle}>{r.range}</td><td className={tdStyle}>{r.taxDue}</td><td className={tdStyle}>{r.rate}</td></tr>)}</tbody></table>
                                </div>
                                <div>
                                    <div className={subHeader}>Married Filing Separately</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Taxable Income</th><th className={thStyle}>Tax Due</th><th className={thStyle}>Rate</th></tr></thead>
                                        <tbody>{data.incomeTax.marriedFilingSeparately.map((r, i) => <tr key={i} className={i % 2 ? 'bg-gray-50' : ''}><td className={tdStyle}>{r.range}</td><td className={tdStyle}>{r.taxDue}</td><td className={tdStyle}>{r.rate}</td></tr>)}</tbody></table>
                                </div>
                                <div>
                                    <div className={subHeader}>Head of Household</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Taxable Income</th><th className={thStyle}>Tax Due</th><th className={thStyle}>Rate</th></tr></thead>
                                        <tbody>{data.incomeTax.headOfHousehold.map((r, i) => <tr key={i} className={i % 2 ? 'bg-gray-50' : ''}><td className={tdStyle}>{r.range}</td><td className={tdStyle}>{r.taxDue}</td><td className={tdStyle}>{r.rate}</td></tr>)}</tbody></table>
                                </div>
                            </div>
                            <p className="text-xs text-gray-500 italic">*The percentage applies to each dollar of taxable income within the range until the next income threshold is reached.</p>

                            {/* Standard Deduction */}
                            <div className={sectionHeader}>Standard Deduction</div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <table className={tableStyle}><thead><tr><th className={thStyle}>Filing Status</th><th className={thStyle}>Amount</th></tr></thead>
                                    <tbody>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Single</td><td className={tdStyle}>{data.standardDeduction.single}</td></tr>
                                        <tr><td className={tdStyle}>Married Filing Jointly</td><td className={tdStyle}>{data.standardDeduction.marriedFilingJointly}</td></tr>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Married Filing Separately</td><td className={tdStyle}>{data.standardDeduction.marriedFilingSeparately}</td></tr>
                                        <tr><td className={tdStyle}>Head of Household</td><td className={tdStyle}>{data.standardDeduction.headOfHousehold}</td></tr>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Dependent</td><td className={tdStyle}>{data.standardDeduction.dependent}</td></tr>
                                    </tbody></table>
                                <div>
                                    <div className={subHeader}>Additional Deduction for Blind or Aged (65+)</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Filing Status</th><th className={thStyle}>Amount</th></tr></thead>
                                        <tbody>
                                            <tr className="bg-gray-50"><td className={tdStyle}>Single or Head of Household</td><td className={tdStyle}>{data.standardDeduction.additionalBlindOrAged.singleOrHOH}</td></tr>
                                            <tr><td className={tdStyle}>Married Filing Jointly or Separately</td><td className={tdStyle}>{data.standardDeduction.additionalBlindOrAged.marriedFilingJointlyOrSeparately}</td></tr>
                                        </tbody></table>
                                    <div className="bg-yellow-50 border-l-4 border-brand-gold p-2 mt-2 text-xs">
                                        <p className="font-semibold text-brand-navy">NEW Deduction for Seniors (65+): {data.standardDeduction.seniorDeduction.amount}</p>
                                        <p className="text-gray-600">{data.standardDeduction.seniorDeduction.note}</p>
                                    </div>
                                </div>
                            </div>

                            {/* AMT */}
                            <div className={sectionHeader}>Alternative Minimum Tax (AMT)</div>
                            <table className={tableStyle}><thead><tr><th className={thStyle}>Filing Status</th><th className={thStyle}>Max Exemption</th><th className={thStyle}>Phaseout Threshold</th></tr></thead>
                                <tbody>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Single or Head of Household</td><td className={tdStyle}>{data.amt.singleOrHOH.exemption}</td><td className={tdStyle}>{data.amt.singleOrHOH.phaseout}</td></tr>
                                    <tr><td className={tdStyle}>Married Filing Jointly</td><td className={tdStyle}>{data.amt.marriedFilingJointly.exemption}</td><td className={tdStyle}>{data.amt.marriedFilingJointly.phaseout}</td></tr>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Married Filing Separately</td><td className={tdStyle}>{data.amt.marriedFilingSeparately.exemption}</td><td className={tdStyle}>{data.amt.marriedFilingSeparately.phaseout}</td></tr>
                                </tbody></table>
                            <p className="text-xs text-gray-500 italic">{data.amt.rates}</p>

                            {/* Education Credits */}
                            <div className={sectionHeader}>Education Credits and Deductions</div>
                            <table className={tableStyle}><thead><tr><th className={thStyle}>Credit/Deduction</th><th className={thStyle}>Maximum</th><th className={thStyle}>Single/HOH Phaseout</th><th className={thStyle}>Married Phaseout</th></tr></thead>
                                <tbody>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Lifetime Learning Credit</td><td className={tdStyle}>{data.educationCredits.lifetimeLearning.maxCredit}</td><td className={tdStyle}>{data.educationCredits.lifetimeLearning.singlePhaseout}</td><td className={tdStyle}>{data.educationCredits.lifetimeLearning.marriedPhaseout}</td></tr>
                                    <tr><td className={tdStyle}>American Opportunity Credit</td><td className={tdStyle}>{data.educationCredits.americanOpportunity.maxCredit}</td><td className={tdStyle}>{data.educationCredits.americanOpportunity.singlePhaseout}</td><td className={tdStyle}>{data.educationCredits.americanOpportunity.marriedPhaseout}</td></tr>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Education Loan Interest Deduction</td><td className={tdStyle}>{data.educationCredits.educationLoanInterest.maxDeduction}</td><td className={tdStyle}>{data.educationCredits.educationLoanInterest.singlePhaseout}</td><td className={tdStyle}>{data.educationCredits.educationLoanInterest.marriedPhaseout}</td></tr>
                                    <tr><td className={tdStyle}>U.S. Savings Bond Interest Exclusion</td><td className={tdStyle}>—</td><td className={tdStyle}>{data.educationCredits.savingsBondExclusion.singlePhaseout}</td><td className={tdStyle}>{data.educationCredits.savingsBondExclusion.marriedPhaseout}</td></tr>
                                </tbody></table>

                            {/* Estate Planning */}
                            <div className={sectionHeader}>Estate Planning</div>
                            <table className={tableStyle}><thead><tr><th className={thStyle}>Item</th><th className={thStyle}>Amount</th></tr></thead>
                                <tbody>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Annual Gift Tax Exclusion</td><td className={tdStyle}>{data.estatePlanning.annualGiftTaxExclusion}</td></tr>
                                    <tr><td className={tdStyle}>Noncitizen Spouse Annual Gift Tax Exclusion</td><td className={tdStyle}>{data.estatePlanning.noncitzenSpouseGiftExclusion}</td></tr>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Top Gift, Estate, and GST Tax Rate</td><td className={tdStyle}>{data.estatePlanning.topGiftEstateGSTRate}</td></tr>
                                    <tr><td className={tdStyle}>Gift Tax and Estate Tax Applicable Exclusion Amount</td><td className={tdStyle}>{data.estatePlanning.giftEstateTaxExclusionAmount}</td></tr>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Generation-Skipping Transfer (GST) Tax Exemption</td><td className={tdStyle}>{data.estatePlanning.gstTaxExemption}</td></tr>
                                </tbody></table>
                            <p className="text-xs text-gray-500 italic">{data.estatePlanning.notes.join(' ')}</p>

                            {/* Retirement Planning */}
                            <div className={sectionHeader}>Retirement Planning</div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div className={subHeader}>Traditional IRA Deduction Phaseout (Covered by Plan)</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Filing Status</th><th className={thStyle}>Phaseout Range</th></tr></thead>
                                        <tbody>
                                            <tr className="bg-gray-50"><td className={tdStyle}>Single or HOH</td><td className={tdStyle}>{data.retirement.traditionalIRAPhaseout.singleOrHOH}</td></tr>
                                            <tr><td className={tdStyle}>MFJ - Contributor Covered</td><td className={tdStyle}>{data.retirement.traditionalIRAPhaseout.marriedJointlyCovered}</td></tr>
                                            <tr className="bg-gray-50"><td className={tdStyle}>MFJ - Spouse Covered Only</td><td className={tdStyle}>{data.retirement.traditionalIRAPhaseout.marriedJointlyNotCovered}</td></tr>
                                            <tr><td className={tdStyle}>Married Filing Separately</td><td className={tdStyle}>{data.retirement.traditionalIRAPhaseout.marriedFilingSeparately}</td></tr>
                                        </tbody></table>
                                </div>
                                <div>
                                    <div className={subHeader}>Roth IRA Contribution Phaseout</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Filing Status</th><th className={thStyle}>Phaseout Range</th></tr></thead>
                                        <tbody>
                                            <tr className="bg-gray-50"><td className={tdStyle}>Single or HOH</td><td className={tdStyle}>{data.retirement.rothIRAPhaseout.singleOrHOH}</td></tr>
                                            <tr><td className={tdStyle}>Married Filing Jointly</td><td className={tdStyle}>{data.retirement.rothIRAPhaseout.marriedFilingJointly}</td></tr>
                                            <tr className="bg-gray-50"><td className={tdStyle}>Married Filing Separately</td><td className={tdStyle}>{data.retirement.rothIRAPhaseout.marriedFilingSeparately}</td></tr>
                                        </tbody></table>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div>
                                    <div className={subHeader}>Employer Plan Contribution Limits</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Plan Type</th><th className={thStyle}>Limit</th></tr></thead>
                                        <tbody>
                                            <tr className="bg-gray-50"><td className={tdStyle}>401(k), 403(b), 457(b), SAR-SEPs</td><td className={tdStyle}>{data.retirement.employerPlans.regular401k403b457b}</td></tr>
                                            <tr><td className={tdStyle}>Catch-Up (Age 50+)</td><td className={tdStyle}>{data.retirement.employerPlans.catchUp50Plus}</td></tr>
                                            <tr className="bg-yellow-50 font-semibold"><td className={tdStyle + " text-brand-navy"}>Catch-Up (Age 60-63)</td><td className={tdStyle + " text-brand-gold"}>{data.retirement.employerPlans.catchUp60to63}</td></tr>
                                            <tr><td className={tdStyle}>SIMPLE 401(k) / IRA</td><td className={tdStyle}>{data.retirement.employerPlans.simpleRegular}</td></tr>
                                            <tr className="bg-gray-50"><td className={tdStyle}>SIMPLE Catch-Up (50+)</td><td className={tdStyle}>{data.retirement.employerPlans.simpleCatchUp50Plus}</td></tr>
                                            <tr className="bg-yellow-50 font-semibold"><td className={tdStyle + " text-brand-navy"}>SIMPLE Catch-Up (60-63)</td><td className={tdStyle + " text-brand-gold"}>{data.retirement.employerPlans.simpleCatchUp60to63}</td></tr>
                                        </tbody></table>
                                </div>
                                <div>
                                    <div className={subHeader}>IRA Contribution Limits</div>
                                    <table className={tableStyle}><thead><tr><th className={thStyle}>Type</th><th className={thStyle}>Limit</th></tr></thead>
                                        <tbody>
                                            <tr className="bg-gray-50"><td className={tdStyle}>Traditional and Roth (Combined)</td><td className={tdStyle}>{data.retirement.iraLimits.traditionalRothCombined}</td></tr>
                                            <tr><td className={tdStyle}>Catch-Up (Age 50+)</td><td className={tdStyle}>{data.retirement.iraLimits.catchUp50Plus}</td></tr>
                                        </tbody></table>
                                </div>
                            </div>

                            {/* Investment Taxes */}
                            <div className={sectionHeader}>Investment Taxes</div>
                            <div className={subHeader}>Long-Term Capital Gain & Qualified Dividend Tax</div>
                            <table className={tableStyle}><thead><tr><th className={thStyle}>Filing Status</th><th className={thStyle}>0% Rate</th><th className={thStyle}>15% Rate</th><th className={thStyle}>20% Rate</th></tr></thead>
                                <tbody>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Single</td><td className={tdStyle}>Up to $49,450</td><td className={tdStyle}>$49,451 - $545,500</td><td className={tdStyle}>Over $545,500</td></tr>
                                    <tr><td className={tdStyle}>Married Filing Jointly</td><td className={tdStyle}>Up to $98,900</td><td className={tdStyle}>$98,901 - $613,700</td><td className={tdStyle}>Over $613,700</td></tr>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Married Filing Separately</td><td className={tdStyle}>Up to $49,450</td><td className={tdStyle}>$49,451 - $306,850</td><td className={tdStyle}>Over $306,850</td></tr>
                                    <tr><td className={tdStyle}>Head of Household</td><td className={tdStyle}>Up to $66,200</td><td className={tdStyle}>$66,201 - $579,600</td><td className={tdStyle}>Over $579,600</td></tr>
                                </tbody></table>
                            <div className={subHeader}>Net Investment Income Tax (NIIT) - 3.8%</div>
                            <table className={tableStyle}><thead><tr><th className={thStyle}>Filing Status</th><th className={thStyle}>MAGI Threshold</th></tr></thead>
                                <tbody>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Single</td><td className={tdStyle}>{data.investmentTaxes.niit.thresholds.single}</td></tr>
                                    <tr><td className={tdStyle}>Married Filing Jointly</td><td className={tdStyle}>{data.investmentTaxes.niit.thresholds.marriedFilingJointly}</td></tr>
                                    <tr className="bg-gray-50"><td className={tdStyle}>Married Filing Separately</td><td className={tdStyle}>{data.investmentTaxes.niit.thresholds.marriedFilingSeparately}</td></tr>
                                    <tr><td className={tdStyle}>Head of Household</td><td className={tdStyle}>{data.investmentTaxes.niit.thresholds.headOfHousehold}</td></tr>
                                </tbody></table>
                            <p className="text-xs text-gray-500 italic">{data.investmentTaxes.niit.note}</p>

                            {/* Health Care */}
                            <div className={sectionHeader}>Health Care</div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <div className={subHeader}>HSA</div>
                                    <table className={tableStyle}><tbody>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Individual</td><td className={tdStyle}>{data.healthCare.hsa.individualContribution}</td></tr>
                                        <tr><td className={tdStyle}>Family</td><td className={tdStyle}>{data.healthCare.hsa.familyContribution}</td></tr>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Catch-Up (55+)</td><td className={tdStyle}>{data.healthCare.hsa.catchUp55Plus}</td></tr>
                                    </tbody></table>
                                </div>
                                <div>
                                    <div className={subHeader}>HDHP Requirements</div>
                                    <table className={tableStyle}><tbody>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Min Deductible (Ind)</td><td className={tdStyle}>{data.healthCare.hdhp.minDeductibleIndividual}</td></tr>
                                        <tr><td className={tdStyle}>Min Deductible (Fam)</td><td className={tdStyle}>{data.healthCare.hdhp.minDeductibleFamily}</td></tr>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Max OOP (Ind)</td><td className={tdStyle}>{data.healthCare.hdhp.maxOutOfPocketIndividual}</td></tr>
                                        <tr><td className={tdStyle}>Max OOP (Fam)</td><td className={tdStyle}>{data.healthCare.hdhp.maxOutOfPocketFamily}</td></tr>
                                    </tbody></table>
                                </div>
                                <div>
                                    <div className={subHeader}>FSA</div>
                                    <table className={tableStyle}><tbody>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Max Contribution</td><td className={tdStyle}>{data.healthCare.fsa.maxContribution}</td></tr>
                                    </tbody></table>
                                </div>
                            </div>

                            {/* Social Security / Medicare & Mileage */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div className={sectionHeader}>Social Security / Medicare</div>
                                    <table className={tableStyle}><tbody>
                                        <tr className="bg-gray-50"><td className={tdStyle}>SS Max Taxable Earnings</td><td className={tdStyle}>{data.socialSecurityMedicare.socialSecurityMaxEarnings}</td></tr>
                                        <tr><td className={tdStyle}>Medicare Max Earnings</td><td className={tdStyle}>{data.socialSecurityMedicare.medicareMaxEarnings}</td></tr>
                                    </tbody></table>
                                </div>
                                <div>
                                    <div className={sectionHeader}>Standard Mileage Rates</div>
                                    <table className={tableStyle}><tbody>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Business</td><td className={tdStyle}>{data.mileageRates.business}</td></tr>
                                        <tr><td className={tdStyle}>Medical</td><td className={tdStyle}>{data.mileageRates.medical}</td></tr>
                                        <tr className="bg-gray-50"><td className={tdStyle}>Charitable</td><td className={tdStyle}>{data.mileageRates.charitable}</td></tr>
                                        <tr><td className={tdStyle}>Moving</td><td className={tdStyle}>{data.mileageRates.moving}</td></tr>
                                    </tbody></table>
                                </div>
                            </div>

                            {/* Footer */}
                            <div className="bg-gray-100 p-3 rounded-lg text-xs text-gray-600 mt-4">
                                <p className="font-semibold">RBC Wealth Management | Burks-Chandler Investment Group</p>
                                <p>Brandon Chandler, CFP®, CPFA™ | 4001 W. 114th Street Suite 200, Leawood, KS 66211 | 913-451-3537</p>
                                <hr className="my-2 border-gray-300" />
                                <p className="italic">RBC Wealth Management does not provide tax or legal advice. All decisions regarding the tax or legal implications of your investments should be made in connection with your independent tax or legal advisor.</p>
                            </div>
                        </div>
                        <div className="sticky bottom-0 bg-white p-3 border-t border-gray-200">
                            <button onClick={onClose} className="w-full bg-brand-navy text-white font-bold py-2 px-6 rounded hover:bg-brand-navy/90 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        // TVM Financial Calculator Modal
        const CalculatorModal = ({ isOpen, onClose }) => {
            const [calcMode, setCalcMode] = React.useState('basic'); // 'basic' or 'tvm'
            const [display, setDisplay] = React.useState('0');
            const [prevValue, setPrevValue] = React.useState(null);
            const [operator, setOperator] = React.useState(null);
            const [waitingForOperand, setWaitingForOperand] = React.useState(false);
            const calcRef = React.useRef(null);

            // TVM Variables
            const [tvmN, setTvmN] = React.useState('');
            const [tvmIY, setTvmIY] = React.useState('');
            const [tvmPV, setTvmPV] = React.useState('');
            const [tvmPMT, setTvmPMT] = React.useState('');
            const [tvmFV, setTvmFV] = React.useState('');
            const [tvmResult, setTvmResult] = React.useState('');
            const [tvmSolveFor, setTvmSolveFor] = React.useState('FV');
            const [pmtTiming, setPmtTiming] = React.useState('end'); // 'end' or 'begin'
            const [periodsPerYear, setPeriodsPerYear] = React.useState(12);

            // Focus calculator when opened for keyboard input
            React.useEffect(() => {
                if (isOpen && calcRef.current) {
                    calcRef.current.focus();
                }
            }, [isOpen, calcMode]);

            if (!isOpen) return null;

            // Basic Calculator Functions
            const inputDigit = (digit) => {
                if (waitingForOperand) {
                    setDisplay(digit);
                    setWaitingForOperand(false);
                } else {
                    setDisplay(display === '0' ? digit : display + digit);
                }
            };

            const inputDecimal = () => {
                if (waitingForOperand) {
                    setDisplay('0.');
                    setWaitingForOperand(false);
                } else if (!display.includes('.')) {
                    setDisplay(display + '.');
                }
            };

            const clearAll = () => {
                setDisplay('0');
                setPrevValue(null);
                setOperator(null);
                setWaitingForOperand(false);
            };

            const backspace = () => {
                if (display.length > 1) {
                    setDisplay(display.slice(0, -1));
                } else {
                    setDisplay('0');
                }
            };

            const toggleSign = () => {
                const value = parseFloat(display);
                setDisplay(String(value * -1));
            };

            const inputPercent = () => {
                const value = parseFloat(display);
                setDisplay(String(value / 100));
            };

            const performOperation = (nextOperator) => {
                const inputValue = parseFloat(display);

                if (prevValue === null) {
                    setPrevValue(inputValue);
                } else if (operator) {
                    const currentValue = prevValue;
                    let result;
                    switch (operator) {
                        case '+': result = currentValue + inputValue; break;
                        case '-': result = currentValue - inputValue; break;
                        case '×': case '*': result = currentValue * inputValue; break;
                        case '÷': case '/': result = inputValue !== 0 ? currentValue / inputValue : 'Error'; break;
                        default: result = inputValue;
                    }
                    setDisplay(String(result));
                    setPrevValue(result);
                }

                setWaitingForOperand(true);
                setOperator(nextOperator);
            };

            const calculate = () => {
                if (operator && prevValue !== null) {
                    const inputValue = parseFloat(display);
                    let result;
                    switch (operator) {
                        case '+': result = prevValue + inputValue; break;
                        case '-': result = prevValue - inputValue; break;
                        case '×': case '*': result = prevValue * inputValue; break;
                        case '÷': case '/': result = inputValue !== 0 ? prevValue / inputValue : 'Error'; break;
                        default: result = inputValue;
                    }
                    setDisplay(String(result));
                    setPrevValue(null);
                    setOperator(null);
                    setWaitingForOperand(true);
                }
            };

            // Keyboard handler for basic calculator
            const handleKeyDown = (e) => {
                if (calcMode !== 'basic') return;

                const key = e.key;

                if (key >= '0' && key <= '9') {
                    e.preventDefault();
                    inputDigit(key);
                } else if (key === '.') {
                    e.preventDefault();
                    inputDecimal();
                } else if (key === '+') {
                    e.preventDefault();
                    performOperation('+');
                } else if (key === '-') {
                    e.preventDefault();
                    performOperation('-');
                } else if (key === '*') {
                    e.preventDefault();
                    performOperation('×');
                } else if (key === '/') {
                    e.preventDefault();
                    performOperation('÷');
                } else if (key === 'Enter' || key === '=') {
                    e.preventDefault();
                    calculate();
                } else if (key === 'Escape' || key === 'c' || key === 'C') {
                    e.preventDefault();
                    clearAll();
                } else if (key === 'Backspace') {
                    e.preventDefault();
                    backspace();
                } else if (key === '%') {
                    e.preventDefault();
                    inputPercent();
                }
            };

            // ===========================================
            // HP 10BII-Compatible TVM Solver Functions
            // ===========================================
            // The fundamental TVM equation (HP standard):
            // PV + PMT * k * [(1 - (1+i)^-n) / i] + FV * (1+i)^-n = 0
            // where k = 1 for END mode, k = (1+i) for BEGIN mode
            // When i = 0: PV + PMT*n + FV = 0

            const solveTVM = () => {
                // Parse inputs with full precision
                const n = parseFloat(tvmN) || 0;
                const annualRate = parseFloat(tvmIY) || 0;
                const i = annualRate / 100 / periodsPerYear; // Periodic interest rate
                const pv = parseFloat(tvmPV) || 0;
                const pmt = parseFloat(tvmPMT) || 0;
                const fv = parseFloat(tvmFV) || 0;
                const isBegin = pmtTiming === 'begin';

                // Payment timing multiplier: BEGIN mode multiplies PMT by (1+i)
                const k = isBegin ? (1 + i) : 1;

                let result;
                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                try {
                    switch (tvmSolveFor) {
                        case 'N': {
                            // Solve: PV + PMT*k*[(1-(1+i)^-n)/i] + FV*(1+i)^-n = 0 for n
                            // Rearranged: (1+i)^n = (PMT*k - FV*i) / (PMT*k + PV*i)
                            // n = ln[(PMT*k - FV*i) / (PMT*k + PV*i)] / ln(1+i)
                            if (Math.abs(i) < 1e-10) {
                                // When i ≈ 0: PV + PMT*n + FV = 0 → n = -(PV + FV) / PMT
                                if (Math.abs(pmt) < 1e-10) {
                                    setTvmResult('Error: Cannot solve N with PMT=0 and I/YR=0');
                                    return;
                                }
                                result = -(pv + fv) / pmt;
                            } else {
                                const pmtK = pmt * k;
                                const numerator = pmtK - fv * i;
                                const denominator = pmtK + pv * i;
                                if (denominator === 0 || numerator / denominator <= 0) {
                                    setTvmResult('Error: No solution exists');
                                    return;
                                }
                                result = Math.log(numerator / denominator) / Math.log(1 + i);
                            }
                            setTvmResult(`N = ${result.toFixed(4)} periods`);
                            setTvmN(result.toFixed(4));
                            break;
                        }

                        case 'I/YR': {
                            // Use Newton-Raphson iteration with HP-style precision
                            // f(i) = PV + PMT*k*[(1-(1+i)^-n)/i] + FV*(1+i)^-n = 0

                            if (n === 0) {
                                setTvmResult('Error: N cannot be 0');
                                return;
                            }

                            // Check for zero-interest case first
                            const zeroInterestSum = pv + pmt * n + fv;
                            if (Math.abs(zeroInterestSum) < 0.01) {
                                result = 0;
                                setTvmResult(`I/YR = 0.0000%`);
                                setTvmIY('0');
                                return;
                            }

                            // Initial guess based on simple interest approximation
                            let rate = 0.1 / periodsPerYear;
                            if (pv !== 0) {
                                const simpleRate = (-(fv + pmt * n) / pv - 1) / n;
                                if (simpleRate > -0.99 && simpleRate < 1) {
                                    rate = simpleRate;
                                }
                            }

                            const maxIterations = 200;
                            const tolerance = 1e-12;

                            for (let iter = 0; iter < maxIterations; iter++) {
                                const kIter = isBegin ? (1 + rate) : 1;
                                const onePlusR = 1 + rate;
                                const onePlusRtoN = Math.pow(onePlusR, n);
                                const onePlusRtoNegN = 1 / onePlusRtoN;

                                let f, fPrime;

                                if (Math.abs(rate) < 1e-10) {
                                    // Near-zero rate: use Taylor expansion
                                    f = pv + pmt * n + fv;
                                    fPrime = pmt * n * (n - 1) / 2 - fv * n;
                                } else {
                                    // Standard formula
                                    const annuityFactor = (1 - onePlusRtoNegN) / rate;
                                    f = pv + pmt * kIter * annuityFactor + fv * onePlusRtoNegN;

                                    // Derivative with respect to rate
                                    const dAnnuity = (n * onePlusRtoNegN / onePlusR - annuityFactor) / rate;
                                    const dKiter = isBegin ? 1 : 0;
                                    fPrime = pmt * (dKiter * annuityFactor + kIter * dAnnuity) - fv * n * onePlusRtoNegN / onePlusR;
                                }

                                if (Math.abs(f) < tolerance) break;
                                if (Math.abs(fPrime) < 1e-20) {
                                    // Derivative too small, try adjusting
                                    rate = rate * 1.1;
                                    continue;
                                }

                                const newRate = rate - f / fPrime;

                                // Bound the rate to reasonable values
                                if (newRate < -0.99) rate = -0.5;
                                else if (newRate > 10) rate = 1;
                                else rate = newRate;

                                if (Math.abs(rate - newRate) < tolerance) break;
                            }

                            result = rate * periodsPerYear * 100;
                            setTvmResult(`I/YR = ${result.toFixed(4)}%`);
                            setTvmIY(result.toFixed(4));
                            break;
                        }

                        case 'PV': {
                            // PV = -PMT*k*[(1-(1+i)^-n)/i] - FV*(1+i)^-n
                            if (Math.abs(i) < 1e-10) {
                                result = -pmt * n - fv;
                            } else {
                                const onePlusRtoNegN = Math.pow(1 + i, -n);
                                const annuityFactor = (1 - onePlusRtoNegN) / i;
                                result = -pmt * k * annuityFactor - fv * onePlusRtoNegN;
                            }
                            setTvmResult(`PV = ${formatter.format(result)}`);
                            setTvmPV(result.toFixed(2));
                            break;
                        }

                        case 'PMT': {
                            // PMT = -(PV + FV*(1+i)^-n) / (k * [(1-(1+i)^-n)/i])
                            if (Math.abs(i) < 1e-10) {
                                if (n === 0) {
                                    setTvmResult('Error: N cannot be 0');
                                    return;
                                }
                                result = -(pv + fv) / n;
                            } else {
                                const onePlusRtoNegN = Math.pow(1 + i, -n);
                                const annuityFactor = (1 - onePlusRtoNegN) / i;
                                if (Math.abs(annuityFactor) < 1e-10) {
                                    setTvmResult('Error: Cannot solve');
                                    return;
                                }
                                result = -(pv + fv * onePlusRtoNegN) / (k * annuityFactor);
                            }
                            setTvmResult(`PMT = ${formatter.format(result)}`);
                            setTvmPMT(result.toFixed(2));
                            break;
                        }

                        case 'FV': {
                            // FV = -(PV + PMT*k*[(1-(1+i)^-n)/i]) * (1+i)^n
                            // Simplified: FV = -PV*(1+i)^n - PMT*k*[(1+i)^n - 1]/i
                            if (Math.abs(i) < 1e-10) {
                                result = -pv - pmt * n;
                            } else {
                                const onePlusRtoN = Math.pow(1 + i, n);
                                const fvAnnuityFactor = (onePlusRtoN - 1) / i;
                                result = -pv * onePlusRtoN - pmt * k * fvAnnuityFactor;
                            }
                            setTvmResult(`FV = ${formatter.format(result)}`);
                            setTvmFV(result.toFixed(2));
                            break;
                        }
                    }
                } catch (e) {
                    setTvmResult('Error: Check inputs');
                }
            };

            const clearTVM = () => {
                setTvmN(''); setTvmIY(''); setTvmPV(''); setTvmPMT(''); setTvmFV('');
                setTvmResult('');
            };

            const btnClass = "bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-all active:scale-95 text-lg select-none";
            const opBtnClass = "bg-brand-gold hover:bg-brand-gold-hover text-white font-semibold py-3 px-4 rounded-lg transition-all active:scale-95 text-lg select-none";
            const inputClass = "w-full p-2 border border-gray-300 rounded-lg text-right font-mono text-lg bg-white focus:outline-none focus:ring-2 focus:ring-brand-navy";

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div
                        ref={calcRef}
                        tabIndex={0}
                        onKeyDown={handleKeyDown}
                        className="bg-white p-6 rounded-xl max-w-md w-full border-t-4 border-brand-gold shadow-2xl outline-none"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                            <h2 className="text-xl font-bold text-brand-navy font-serif">Financial Calculator</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>

                        {/* Mode Toggle */}
                        <div className="flex mb-4 bg-gray-100 rounded-lg p-1">
                            <button
                                className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${calcMode === 'basic' ? 'bg-brand-navy text-white shadow' : 'text-gray-600 hover:text-gray-800'}`}
                                onClick={() => setCalcMode('basic')}
                            >
                                Basic
                            </button>
                            <button
                                className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${calcMode === 'tvm' ? 'bg-brand-navy text-white shadow' : 'text-gray-600 hover:text-gray-800'}`}
                                onClick={() => setCalcMode('tvm')}
                            >
                                TVM Solver
                            </button>
                        </div>

                        {calcMode === 'basic' ? (
                            <>
                                {/* Display */}
                                <div className="bg-gray-900 text-white text-right p-4 rounded-lg mb-4 font-mono text-3xl overflow-x-auto">
                                    {display}
                                </div>
                                <p className="text-xs text-gray-400 text-center mb-2">Type numbers and operators, Enter for =, Esc to clear</p>

                                {/* Keypad */}
                                <div className="grid grid-cols-4 gap-2">
                                    <button className={btnClass} onClick={clearAll}>C</button>
                                    <button className={btnClass} onClick={toggleSign}>±</button>
                                    <button className={btnClass} onClick={inputPercent}>%</button>
                                    <button className={opBtnClass} onClick={() => performOperation('÷')}>÷</button>

                                    <button className={btnClass} onClick={() => inputDigit('7')}>7</button>
                                    <button className={btnClass} onClick={() => inputDigit('8')}>8</button>
                                    <button className={btnClass} onClick={() => inputDigit('9')}>9</button>
                                    <button className={opBtnClass} onClick={() => performOperation('×')}>×</button>

                                    <button className={btnClass} onClick={() => inputDigit('4')}>4</button>
                                    <button className={btnClass} onClick={() => inputDigit('5')}>5</button>
                                    <button className={btnClass} onClick={() => inputDigit('6')}>6</button>
                                    <button className={opBtnClass} onClick={() => performOperation('-')}>−</button>

                                    <button className={btnClass} onClick={() => inputDigit('1')}>1</button>
                                    <button className={btnClass} onClick={() => inputDigit('2')}>2</button>
                                    <button className={btnClass} onClick={() => inputDigit('3')}>3</button>
                                    <button className={opBtnClass} onClick={() => performOperation('+')}>+</button>

                                    <button className={`${btnClass} col-span-2`} onClick={() => inputDigit('0')}>0</button>
                                    <button className={btnClass} onClick={inputDecimal}>.</button>
                                    <button className="bg-brand-navy hover:bg-brand-navy/90 text-white font-semibold py-3 px-4 rounded-lg transition-all active:scale-95 text-lg select-none" onClick={calculate}>=</button>
                                </div>
                            </>
                        ) : (
                            <>
                                {/* TVM Solver */}
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1 font-medium">N (Total Periods)</label>
                                            <div className="flex">
                                                <input
                                                    type="number"
                                                    className={inputClass + (tvmSolveFor === 'N' ? ' ring-2 ring-brand-gold' : '')}
                                                    value={tvmN}
                                                    onChange={(e) => setTvmN(e.target.value)}
                                                    placeholder="0"
                                                    step="any"
                                                />
                                                <button
                                                    className={`ml-1 px-2 rounded text-xs font-semibold ${tvmSolveFor === 'N' ? 'bg-brand-gold text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                                                    onClick={() => setTvmSolveFor('N')}
                                                >
                                                    CPT
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1 font-medium">I/YR (Annual Rate %)</label>
                                            <div className="flex">
                                                <input
                                                    type="number"
                                                    className={inputClass + (tvmSolveFor === 'I/YR' ? ' ring-2 ring-brand-gold' : '')}
                                                    value={tvmIY}
                                                    onChange={(e) => setTvmIY(e.target.value)}
                                                    placeholder="0"
                                                    step="any"
                                                />
                                                <button
                                                    className={`ml-1 px-2 rounded text-xs font-semibold ${tvmSolveFor === 'I/YR' ? 'bg-brand-gold text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                                                    onClick={() => setTvmSolveFor('I/YR')}
                                                >
                                                    CPT
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs text-gray-600 mb-1 font-medium">PV (Present Value)</label>
                                        <div className="flex">
                                            <input
                                                type="number"
                                                className={inputClass + (tvmSolveFor === 'PV' ? ' ring-2 ring-brand-gold' : '')}
                                                value={tvmPV}
                                                onChange={(e) => setTvmPV(e.target.value)}
                                                placeholder="0"
                                                step="any"
                                            />
                                            <button
                                                className={`ml-1 px-2 rounded text-xs font-semibold ${tvmSolveFor === 'PV' ? 'bg-brand-gold text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                                                onClick={() => setTvmSolveFor('PV')}
                                            >
                                                CPT
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs text-gray-600 mb-1 font-medium">PMT (Payment per Period)</label>
                                        <div className="flex">
                                            <input
                                                type="number"
                                                className={inputClass + (tvmSolveFor === 'PMT' ? ' ring-2 ring-brand-gold' : '')}
                                                value={tvmPMT}
                                                onChange={(e) => setTvmPMT(e.target.value)}
                                                placeholder="0"
                                                step="any"
                                            />
                                            <button
                                                className={`ml-1 px-2 rounded text-xs font-semibold ${tvmSolveFor === 'PMT' ? 'bg-brand-gold text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                                                onClick={() => setTvmSolveFor('PMT')}
                                            >
                                                CPT
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs text-gray-600 mb-1 font-medium">FV (Future Value)</label>
                                        <div className="flex">
                                            <input
                                                type="number"
                                                className={inputClass + (tvmSolveFor === 'FV' ? ' ring-2 ring-brand-gold' : '')}
                                                value={tvmFV}
                                                onChange={(e) => setTvmFV(e.target.value)}
                                                placeholder="0"
                                                step="any"
                                            />
                                            <button
                                                className={`ml-1 px-2 rounded text-xs font-semibold ${tvmSolveFor === 'FV' ? 'bg-brand-gold text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                                                onClick={() => setTvmSolveFor('FV')}
                                            >
                                                CPT
                                            </button>
                                        </div>
                                    </div>

                                    {/* Settings Row */}
                                    <div className="grid grid-cols-2 gap-3 pt-2 border-t border-gray-200">
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1 font-medium">P/YR (Periods/Year)</label>
                                            <select
                                                className="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm"
                                                value={periodsPerYear}
                                                onChange={(e) => setPeriodsPerYear(Number(e.target.value))}
                                            >
                                                <option value={1}>1 (Annual)</option>
                                                <option value={2}>2 (Semi-Annual)</option>
                                                <option value={4}>4 (Quarterly)</option>
                                                <option value={12}>12 (Monthly)</option>
                                                <option value={26}>26 (Bi-Weekly)</option>
                                                <option value={52}>52 (Weekly)</option>
                                                <option value={365}>365 (Daily)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1 font-medium">PMT Timing (END/BGN)</label>
                                            <select
                                                className="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm"
                                                value={pmtTiming}
                                                onChange={(e) => setPmtTiming(e.target.value)}
                                            >
                                                <option value="end">END (Ordinary)</option>
                                                <option value="begin">BGN (Annuity Due)</option>
                                            </select>
                                        </div>
                                    </div>

                                    {/* Result Display */}
                                    {tvmResult && (
                                        <div className={`border rounded-lg p-3 text-center ${tvmResult.startsWith('Error') ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}>
                                            <p className={`font-bold text-lg ${tvmResult.startsWith('Error') ? 'text-red-700' : 'text-green-800'}`}>{tvmResult}</p>
                                        </div>
                                    )}

                                    {/* Action Buttons */}
                                    <div className="grid grid-cols-2 gap-3 pt-2">
                                        <button
                                            className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-all"
                                            onClick={clearTVM}
                                        >
                                            Clear All
                                        </button>
                                        <button
                                            className="bg-brand-navy hover:bg-brand-navy/90 text-white font-semibold py-3 px-4 rounded-lg transition-all"
                                            onClick={solveTVM}
                                        >
                                            Compute {tvmSolveFor}
                                        </button>
                                    </div>

                                    {/* Help Text */}
                                    <div className="text-xs text-gray-500 text-center mt-2 bg-blue-50 p-2 rounded border border-blue-100">
                                        <p className="font-semibold text-blue-700 mb-1">HP 10BII Sign Convention:</p>
                                        <p>Cash OUT (investments, payments) = <span className="text-red-600 font-semibold">negative</span></p>
                                        <p>Cash IN (withdrawals, receipts) = <span className="text-green-600 font-semibold">positive</span></p>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const InputValidation = ({ data, calculations }) => {
            const warnings = [];
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });

            // Split W2 Logic Check
            if (data.filingStatus === 'mfj' && data.w2IncomeP1 > 0 && data.w2IncomeP2 === 0 && !data.notes.toLowerCase().includes("unemployed")) {
                warnings.push({ type: 'info', msg: "Filing Jointly but Spouse Income is $0. Ensure you haven't combined incomes into P1.", icon: '💡' });
            }

            // Retirement Plan Coverage Check - User has 401k but hasn't checked coverage box
            if ((data.traditional401k > 0 || data.roth401k > 0 || data.employer401k > 0) && !data.coveredByRetirementPlan) {
                warnings.push({ type: 'info', msg: "You entered 401(k) contributions but 'Covered by Plan' is unchecked. Contributors are typically considered covered, which affects IRA deduction limits.", icon: 'ℹ️' });
            }

            // Spouse Retirement Plan Coverage Check
            if (data.filingStatus === 'mfj' && (data.spouseTraditional401k > 0 || data.spouseRoth401k > 0 || data.spouseEmployer401k > 0) && !data.spouseCoveredByRetirementPlan) {
                warnings.push({ type: 'info', msg: "Spouse has 401(k) contributions but 'Spouse Covered by Plan' is unchecked. Contributors are typically considered covered.", icon: 'ℹ️' });
            }

            // 401(k) Elective Deferral Limit Check (402(g))
            // Calculate age-based limit for primary filer
            const currentYear = CURRENT_TAX_YEAR;
            const age = currentYear - data.birthYearOfOldestFiler;
            let electiveDeferralLimit = CONTRIBUTION_LIMITS['401k_regular'];
            if (age >= 60 && age <= 63) {
                electiveDeferralLimit += CONTRIBUTION_LIMITS['401k_catchup_60_63'];
            } else if (age >= 50) {
                electiveDeferralLimit += CONTRIBUTION_LIMITS['401k_catchup'];
            }

            const totalElectiveDeferrals = (data.traditional401k || 0) + (data.roth401k || 0);
            if (totalElectiveDeferrals > electiveDeferralLimit && data.birthYearOfOldestFiler > 0) {
                warnings.push({
                    type: 'err',
                    msg: `401(k) elective deferrals (${formatter.format(totalElectiveDeferrals)}) exceed the ${age >= 60 && age <= 63 ? 'super catch-up' : age >= 50 ? 'catch-up' : 'regular'} limit of ${formatter.format(electiveDeferralLimit)} for age ${age}.`,
                    icon: '🚫'
                });
            }

            // Spouse 401(k) Elective Deferral Limit Check
            if (data.filingStatus === 'mfj' && data.spouseBirthYear > 0) {
                const spouseAge = currentYear - data.spouseBirthYear;
                let spouseElectiveDeferralLimit = CONTRIBUTION_LIMITS['401k_regular'];
                if (spouseAge >= 60 && spouseAge <= 63) {
                    spouseElectiveDeferralLimit += CONTRIBUTION_LIMITS['401k_catchup_60_63'];
                } else if (spouseAge >= 50) {
                    spouseElectiveDeferralLimit += CONTRIBUTION_LIMITS['401k_catchup'];
                }

                const spouseTotalElectiveDeferrals = (data.spouseTraditional401k || 0) + (data.spouseRoth401k || 0);
                if (spouseTotalElectiveDeferrals > spouseElectiveDeferralLimit) {
                    warnings.push({
                        type: 'err',
                        msg: `Spouse 401(k) elective deferrals (${formatter.format(spouseTotalElectiveDeferrals)}) exceed the ${spouseAge >= 60 && spouseAge <= 63 ? 'super catch-up' : spouseAge >= 50 ? 'catch-up' : 'regular'} limit of ${formatter.format(spouseElectiveDeferralLimit)} for age ${spouseAge}.`,
                        icon: '🚫'
                    });
                }
            }

            // Birth year validation
            if (data.birthYearOfOldestFiler > 0 && (data.birthYearOfOldestFiler < 1920 || data.birthYearOfOldestFiler > currentYear)) {
                warnings.push({ type: 'err', msg: "Birth year appears invalid. Please check your entry.", icon: '⚠️' });
            }

            // State not selected
            if (!data.selectedState && (data.w2IncomeP1 > 0 || data.selfEmploymentIncome > 0)) {
                warnings.push({ type: 'info', msg: "No state selected. State tax calculation will be skipped.", icon: '📍' });
            }

            // 415(c) Reality Check
            if (data.afterTax401k > (data.w2IncomeP1 * 0.6) && data.w2IncomeP1 > 0) {
                warnings.push({ type: 'warn', msg: "High After-Tax 401(k) entry (>60% of income). Verify this allows for taxes/living expenses.", icon: '🔍' });
            }

            // Spouse 415(c) check
            if (data.filingStatus === 'mfj' && data.spouseAfterTax401k > (data.w2IncomeP2 * 0.6) && data.w2IncomeP2 > 0) {
                warnings.push({ type: 'warn', msg: "High Spouse After-Tax 401(k) entry (>60% of spouse income). Verify accuracy.", icon: '🔍' });
            }

            // Savings > Income Check
            const totalIncome = data.w2IncomeP1 + data.w2IncomeP2 + data.selfEmploymentIncome;
            const totalSavings = data.traditional401k + data.roth401k + data.afterTax401k + data.spouseTraditional401k + data.spouseRoth401k + data.spouseAfterTax401k;
            if (totalSavings > totalIncome && totalIncome > 0) {
                warnings.push({ type: 'err', msg: `Total retirement contributions (${formatter.format(totalSavings)}) exceed entered Earned Income (${formatter.format(totalIncome)}).`, icon: '❌' });
            }

            // HSA without W2 income warning
            if (data.hsaContributions > 0 && data.w2IncomeP1 === 0 && data.selfEmploymentIncome === 0) {
                warnings.push({ type: 'info', msg: "HSA contributions entered without earned income. Ensure you have qualifying HDHP coverage.", icon: '🏥' });
            }

            // Social Security under 62 check
            if (data.socialSecurityIncome > 0 && data.birthYearOfOldestFiler > 0) {
                const age = currentYear - data.birthYearOfOldestFiler;
                if (age < 62) {
                    warnings.push({ type: 'warn', msg: `Social Security income entered but primary filer appears to be under 62 (age ${age}).`, icon: '📅' });
                }
            }

            // Roth IRA when MAGI is high
            if (calculations && calculations.isRothIraDisabled && (data.rothIRA_P1 > 0 || data.rothIRA_P2 > 0)) {
                warnings.push({ type: 'err', msg: "Roth IRA contributions entered but MAGI exceeds eligibility. Consider Backdoor Roth.", icon: '🚫' });
            }

            // Traditional IRA deduction warning
            if (calculations && calculations.disallowedIRADeduction > 0 && (data.traditionalIRA_P1 > 0 || data.traditionalIRA_P2 > 0)) {
                warnings.push({ type: 'warn', msg: `Traditional IRA deduction limited by ${formatter.format(calculations.disallowedIRADeduction)} due to retirement plan coverage and/or MAGI.`, icon: '📉' });
            }

            // Negative take-home pay warning
            if (calculations && calculations.takeHomePay < 0) {
                warnings.push({ type: 'err', msg: `Negative take-home pay (${formatter.format(calculations.takeHomePay)}). Review your income and contribution entries.`, icon: '💸' });
            }

            if (warnings.length === 0) return null;

            return (
                <div className="mb-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl shadow-sm">
                    <h3 className="text-brand-navy font-bold text-xs uppercase mb-3 tracking-widest flex items-center">
                        <span className="mr-2">🔎</span> Data Validation & Insights
                    </h3>
                    <ul className="space-y-2">
                        {warnings.map((w, idx) => (
                            <li key={idx} className={`text-sm flex items-start p-2 rounded-lg ${w.type === 'err' ? 'bg-red-100 text-red-700 border-l-4 border-red-500' : w.type === 'warn' ? 'bg-amber-100 text-amber-800 border-l-4 border-amber-500' : 'bg-blue-50 text-blue-700 border-l-4 border-blue-400'}`}>
                                <span className="mr-2 text-base leading-none flex-shrink-0">{w.icon}</span>
                                <span>{w.msg}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        };

        const ComparisonComponent = ({ scenario1, scenario2, s1Name, s2Name, formatter, percentFormatter }) => {
            // Calculate key comparison insights
            const taxDiff = scenario2.totalEstimatedTax - scenario1.totalEstimatedTax;
            const takeHomeDiff = scenario2.takeHomePay - scenario1.takeHomePay;
            const savingsDiff = scenario2.totalContributions - scenario1.totalContributions;
            const effectiveRateDiff = scenario2.effectiveOverallTaxRate - scenario1.effectiveOverallTaxRate;

            // Determine which scenario is "better" for key metrics
            const betterTaxScenario = taxDiff < 0 ? s2Name : taxDiff > 0 ? s1Name : 'Equal';
            const betterTakeHomeScenario = takeHomeDiff > 0 ? s2Name : takeHomeDiff < 0 ? s1Name : 'Equal';

            // This array defines every row in our comparison table.
            const metrics = [
                // --- Income & Core Tax Metrics ---
                { label: 'Adjusted Gross Income (AGI)', key: 'calculatedAGI', format: (val) => formatter.format(val) },
                { label: 'MAGI (for IRMAA & NIIT)', key: 'magiForIrmaa', format: (val) => formatter.format(val) },
                { label: 'Taxable Income', key: 'taxableIncome', format: (val) => formatter.format(val) },
                { label: 'FICA & Self-Employment Taxes', key: 'totalFicaTax', format: (val) => formatter.format(val), diffType: 'inverse' },
                { label: 'Total Federal Tax', key: 'totalFederalTaxLiability', format: (val) => formatter.format(val), highlight: true, diffType: 'inverse' },
                { label: 'Total State Tax', key: 'stateIncomeTax', format: (val) => formatter.format(val), diffType: 'inverse' },
                { label: 'Total Tax Liability', key: 'totalEstimatedTax', format: (val) => formatter.format(val), highlight: true, diffType: 'inverse' },
                { label: 'Refund / (Amount Owed)', key: 'remainingTaxOrRefund', format: (val) => formatter.format(val) },

                // --- Tax Calculation Details ---
                { label: 'Federal Tax (Ordinary Income)', key: 'federalOrdinaryTax', format: (val) => formatter.format(val), diffType: 'inverse' },
                { label: 'Federal Tax (LTCG & Qual. Divs)', key: 'estimatedLTCGTax', format: (val) => formatter.format(val), diffType: 'inverse' },
                { label: 'Child Tax Credit (Allowed)', key: 'childTaxCredit', format: (val) => formatter.format(val) },
                { label: 'Highest LTCG/Qual. Div Rate', key: 'highestLTCGRateApplied', format: (val) => `${val.toFixed(0)}%`, diffType: 'inverse' },

                // --- Deductions ---
                { label: 'Total Deductions', key: 'totalDeductions', format: (val) => formatter.format(val) },
                { label: 'Total Standard/Itemized', key: 'standardOrItemizedDeduction', format: (val) => formatter.format(val) },
                { label: 'Total OBBBA Deductions', key: 'totalBelowTheLineOBBBADeductions', format: (val) => formatter.format(val) },

                // --- Social Security & Medicare ---
                { label: 'Taxable Social Security', key: 'taxableSocialSecurity', format: (val) => formatter.format(val), diffType: 'inverse' },
                { label: 'Percentage of SS Taxed', key: 'percentageSSBenefitsTaxed', format: (val) => percentFormatter.format(val / 100), diffType: 'inverse' },
                { label: 'IRMAA MAGI Bracket', key: 'irmaaBracket', format: (val) => val },
                { label: 'Monthly IRMAA Surcharge', key: 'irmaaMonthlySurcharge', format: (val) => formatter.format(val), diffType: 'inverse' },
                { label: 'Total Monthly Medicare Premium', key: 'irmaaTotalPremium', format: (val) => formatter.format(val), diffType: 'inverse' },
                { label: 'Room Until Next IRMAA Bracket', key: 'roomUntilNextIrmaaBracket', format: (val) => val === Infinity ? 'N/A' : formatter.format(val) },

                // --- Marginal Bracket Insights ---
                { label: 'Current Fed. Marginal Rate', key: 'currentMarginalRate', format: (val) => `${val.toFixed(0)}%`, diffType: 'inverse' },
                { label: 'Room Until Next Bracket Up', key: 'roomUntilNextBracket', format: (val) => val === Infinity ? 'N/A' : formatter.format(val) },

                // --- Rates & Take-Home Pay ---
                { label: 'Effective Overall Tax Rate', key: 'effectiveOverallTaxRate', format: (val) => percentFormatter.format(val / 100), diffType: 'inverse' },
                { label: 'Total Retirement Savings (Pre-Tax)', key: 'totalTraditionalRetirement', format: (val) => formatter.format(val) },
                { label: 'Total Employer Retirement Match', key: 'totalEmployerRetirement', format: (val) => formatter.format(val) },
                { label: 'Total Roth/After-Tax Savings', key: 'totalRothAfterTaxSavings', format: (val) => formatter.format(val) },
                { label: 'Taxable Brokerage Savings', key: 'totalTaxableBrokerageSavings', format: (val) => formatter.format(val) },
                { label: 'Take-Home Pay', key: 'takeHomePay', format: (val) => formatter.format(val), highlight: true },
                { label: 'Total Annual Savings', key: 'totalContributions', format: (val) => formatter.format(val), highlight: true },
            ];


            return (
                <div className="p-6 bg-white rounded-xl shadow-lg border-t-4 border-brand-gold mt-6">
                    <h2 className="text-2xl font-bold text-brand-navy mb-6 text-center border-b border-gray-200 pb-4 font-serif">Scenario Comparison</h2>

                    {/* Quick Insights Summary */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 p-4 bg-gradient-to-r from-brand-navy/5 to-brand-gold/10 rounded-xl">
                        <div className="text-center p-3 bg-white rounded-lg shadow-sm">
                            <p className="text-xs text-gray-500 uppercase tracking-wider mb-1">Tax Difference</p>
                            <p className={`text-xl font-bold ${taxDiff < 0 ? 'text-green-600' : taxDiff > 0 ? 'text-red-600' : 'text-gray-500'}`}>
                                {taxDiff >= 0 ? '+' : ''}{formatter.format(taxDiff)}
                            </p>
                            <p className="text-xs text-gray-400 mt-1">{betterTaxScenario !== 'Equal' ? `${betterTaxScenario} saves more` : 'Equal'}</p>
                        </div>
                        <div className="text-center p-3 bg-white rounded-lg shadow-sm">
                            <p className="text-xs text-gray-500 uppercase tracking-wider mb-1">Take-Home Difference</p>
                            <p className={`text-xl font-bold ${takeHomeDiff > 0 ? 'text-green-600' : takeHomeDiff < 0 ? 'text-red-600' : 'text-gray-500'}`}>
                                {takeHomeDiff >= 0 ? '+' : ''}{formatter.format(takeHomeDiff)}
                            </p>
                            <p className="text-xs text-gray-400 mt-1">{betterTakeHomeScenario !== 'Equal' ? `${betterTakeHomeScenario} is higher` : 'Equal'}</p>
                        </div>
                        <div className="text-center p-3 bg-white rounded-lg shadow-sm">
                            <p className="text-xs text-gray-500 uppercase tracking-wider mb-1">Savings Difference</p>
                            <p className={`text-xl font-bold ${savingsDiff > 0 ? 'text-blue-600' : savingsDiff < 0 ? 'text-amber-600' : 'text-gray-500'}`}>
                                {savingsDiff >= 0 ? '+' : ''}{formatter.format(savingsDiff)}
                            </p>
                            <p className="text-xs text-gray-400 mt-1">{savingsDiff !== 0 ? `${savingsDiff > 0 ? s2Name : s1Name} saves more` : 'Equal'}</p>
                        </div>
                        <div className="text-center p-3 bg-white rounded-lg shadow-sm">
                            <p className="text-xs text-gray-500 uppercase tracking-wider mb-1">Effective Rate Δ</p>
                            <p className={`text-xl font-bold ${effectiveRateDiff < 0 ? 'text-green-600' : effectiveRateDiff > 0 ? 'text-red-600' : 'text-gray-500'}`}>
                                {effectiveRateDiff >= 0 ? '+' : ''}{percentFormatter.format(effectiveRateDiff / 100)}
                            </p>
                            <p className="text-xs text-gray-400 mt-1">{effectiveRateDiff !== 0 ? `${effectiveRateDiff < 0 ? s2Name : s1Name} is lower` : 'Equal'}</p>
                        </div>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-brand-navy">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Metric</th>
                                    <th className="px-6 py-3 text-right text-xs font-bold text-white uppercase tracking-wider">{s1Name}</th>
                                    <th className="px-6 py-3 text-right text-xs font-bold text-white uppercase tracking-wider">{s2Name}</th>
                                    <th className="px-6 py-3 text-right text-xs font-bold text-brand-gold uppercase tracking-wider">Difference</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {metrics.map(metric => {
                                    const val1 = scenario1[metric.key] || 0;
                                    const val2 = scenario2[metric.key] || 0;
                                    const diff = typeof val1 === 'number' && typeof val2 === 'number' ? val2 - val1 : 'N/A';

                                    let isGood;
                                    if (diff !== 'N/A') {
                                        isGood = metric.diffType === 'inverse' ? diff < 0 : diff > 0;
                                    }
                                    // Updated colors for Light Mode
                                    const diffColor = diff === 0 || diff === 'N/A' ? 'text-gray-400' : isGood ? 'text-green-600' : 'text-red-600';
                                    const diffSign = diff > 0 ? '+' : '';

                                    // Highlight significant differences (>5% change)
                                    const isSignificant = diff !== 'N/A' && val1 !== 0 && Math.abs(diff / val1) > 0.05;

                                    return (
                                        <tr key={metric.label} className={`${metric.highlight ? 'bg-brand-gold/10' : 'hover:bg-gray-50'} ${isSignificant ? 'border-l-4 border-brand-gold' : ''} transition-colors`}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">
                                                {metric.label}
                                                {isSignificant && <span className="ml-2 text-xs text-brand-gold">●</span>}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">{metric.format(val1)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">{metric.format(val2)}</td>
                                            <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold text-right ${diffColor}`}>
                                                {diff !== 'N/A' ? `${diffSign}${metric.format(diff)}` : diff}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    <p className="text-xs text-gray-400 mt-4 text-center">● indicates significant difference (&gt;5%)</p>
                </div>
            );
        };

        const StateTaxSummary = ({ selectedState }) => {
            const state = STATE_TAX_DATA[selectedState];
            if (!state || state.type === 'none') {
                return (
                    <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h3 className="text-brand-navy font-bold text-xs uppercase mb-2 tracking-widest">State Tax Status</h3>
                        <p className="text-green-700 text-sm">
                            {selectedState ? `${state?.name || selectedState} has no state income tax.` : 'Select a state to see tax details.'}
                        </p>
                    </div>
                );
            }

            return (
                <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 className="text-brand-navy font-bold text-xs uppercase mb-2 tracking-widest">State Tax Summary: {state.name}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span className="font-medium text-gray-600">Tax Type:</span>
                            <span className="ml-2 text-gray-800 capitalize">{state.type === 'flat' ? 'Flat Rate' : state.type === 'graduated' ? 'Graduated Brackets' : state.type}</span>
                        </div>
                        {state.type === 'flat' && (
                            <div>
                                <span className="font-medium text-gray-600">Rate:</span>
                                <span className="ml-2 text-gray-800">{(state.rate * 100).toFixed(2)}%</span>
                            </div>
                        )}
                        {state.socialSecurityExempt && (
                            <div>
                                <span className="font-medium text-gray-600">Social Security:</span>
                                <span className="ml-2 text-green-600">Exempt</span>
                            </div>
                        )}
                        {state.retirement?.exempt && (
                            <div>
                                <span className="font-medium text-gray-600">Retirement Income:</span>
                                <span className="ml-2 text-green-600">Exempt{state.retirement.age ? ` (age ${state.retirement.age}+)` : ''}</span>
                            </div>
                        )}
                        {state.capitalGains?.deductionRate && (
                            <div>
                                <span className="font-medium text-gray-600">LTCG Deduction:</span>
                                <span className="ml-2 text-gray-800">{(state.capitalGains.deductionRate * 100).toFixed(0)}%</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SummaryComponent = ({ calculations, title, formatter, percentFormatter }) => {
            if (!calculations) return null;

            // Helper for standard rows
            const ValueDisplay = ({ label, value, isCurrency = true, isPercent = false, highlight = false }) => {
                const formattedValue = isPercent ? percentFormatter.format(value / 100) : formatter.format(value);
                // Light mode colors: Gray-400 for zero, Dark gray for values
                const valueColor = value === 0 && isCurrency ? 'text-gray-400' : 'text-gray-800';

                return (
                    <div className="flex justify-between items-center py-2 border-b border-gray-200">
                        <span className="font-medium text-gray-600">{label}:</span>
                        <span className={`${valueColor} ${highlight ? 'font-bold text-brand-navy' : ''}`}>{formattedValue}</span>
                    </div>
                );
            };

            // Helper for large rate displays
            const RateDisplay = ({ label, value, highlightColor = 'text-blue-600' }) => {
                return (
                    <div className="flex justify-between items-center py-2">
                        <span className="font-bold text-brand-navy">{label}:</span>
                        <span className={`font-bold text-xl ${highlightColor}`}>{percentFormatter.format(value / 100)}</span>
                    </div>
                );
            };

            return (
                <div className="p-6 bg-white rounded-xl shadow-lg border-t-4 border-brand-gold text-gray-800">
                    <h2 className="text-2xl font-bold text-brand-navy mb-6 text-center border-b border-gray-200 pb-4 font-serif">{title}</h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-base">
                        {/* Column 1 */}
                        <div>
                            <h3 className="text-lg font-semibold text-brand-navy mt-4 mb-2 border-b-2 border-brand-gold pb-1">Income & Tax Liability</h3>
                            <ValueDisplay label="Adjusted Gross Income (AGI)" value={calculations.calculatedAGI} />
                            <ValueDisplay label="MAGI (for IRMAA & NIIT)" value={calculations.magiForIrmaa} highlight={true} />
                            <ValueDisplay label="Taxable Income (Before QBI)" value={calculations.taxableIncomeBeforeQBI} />
                            <ValueDisplay label="Final Federal Taxable Income" value={calculations.taxableIncome} />
                            <ValueDisplay label="FICA & Self-Employment Taxes" value={calculations.totalFicaTax} />
                            <ValueDisplay label="Estimated Local Income Tax" value={calculations.localIncomeTax} />
                        </div>

                        {/* Column 2 */}
                        <div>
                            <h3 className="text-lg font-semibold text-brand-navy mt-4 mb-2 border-b-2 border-brand-gold pb-1">&nbsp;</h3>
                            <ValueDisplay label="Regular Federal Income Tax" value={calculations.netFederalIncomeTax} />
                            <ValueDisplay label="Estimated State Income Tax" value={calculations.stateIncomeTax} />
                            <ValueDisplay label="Total Tax Withheld & Paid" value={calculations.totalTaxWithheld} />

                            {/* Refund / Owed Section */}
                            <div className="flex justify-between items-center py-2 font-bold text-lg border-b-2 border-gray-300">
                                <span className="text-gray-700">{calculations.remainingTaxOrRefund >= 0 ? 'Amount to be Refunded' : 'Total Remaining Tax Owed'}:</span>
                                <span className={calculations.remainingTaxOrRefund >= 0 ? 'text-green-600' : 'text-red-600'}>{formatter.format(Math.abs(calculations.remainingTaxOrRefund))}</span>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 mt-4">
                        <RateDisplay label="Effective Federal Tax Rate (on AGI)" value={calculations.effectiveFederalTaxRate} highlightColor="text-blue-600" />
                        <RateDisplay label="Effective Overall Tax Rate (on Gross Income)" value={calculations.effectiveOverallTaxRate} highlightColor="text-red-600" />
                    </div>

                    {calculations.amtDetails && (
                        <div className="mt-8 mb-6">
                            <h3 className="text-xl font-bold text-brand-navy mb-4 text-center font-serif">Alternative Minimum Tax (AMT) Breakdown</h3>
                            <div className="bg-gray-50 p-5 rounded-lg border border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <ValueDisplay label="AMT Income (AMTI)" value={calculations.amtDetails.amti} />
                                <ValueDisplay label="AMT Exemption Allowed" value={calculations.amtDetails.exemption} />
                                <ValueDisplay label="Taxable AMT Income" value={Math.max(0, calculations.amtDetails.amti - calculations.amtDetails.exemption)} />
                                <ValueDisplay label="Tentative Minimum Tax (TMT)" value={calculations.amtDetails.tentativeMinimumTax} />
                                <div className="col-span-full border-t border-gray-300 mt-2 pt-2">
                                    <div className="flex justify-between font-bold text-lg">
                                        <span className="text-gray-700">AMT Liability (TMT - Regular Tax)</span>
                                        <span className={calculations.amtDetails.amtLiability > 0 ? "text-red-600" : "text-gray-400"}>{formatter.format(calculations.amtDetails.amtLiability)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <h3 className="text-xl font-bold text-brand-navy mt-8 mb-4 text-center font-serif">Savings & Take-Home Pay</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 text-base">
                        <ValueDisplay label="Total Pre-Tax Retirement Savings" value={calculations.totalTraditionalRetirement} />
                        <ValueDisplay label="Total Employer Retirement Match" value={calculations.totalEmployerRetirement} />
                        <ValueDisplay label="Total Roth/After-Tax Savings" value={calculations.totalRothAfterTaxSavings} />
                        <ValueDisplay label="Total HSA Savings" value={calculations.totalHsaSavings} />
                        <ValueDisplay label="Total 529 Savings" value={calculations.total529Savings} />
                        <ValueDisplay label="Total Taxable Brokerage Savings" value={calculations.totalTaxableBrokerageSavings} />
                    </div>

                    {/* Take Home Pay Box - Light Mode Version */}
                    <div className="flex justify-between items-center py-3 px-4 font-bold text-xl col-span-full bg-green-50 border-2 border-green-500 rounded-lg mt-4 shadow-md">
                        <span className="text-gray-700">Your Take Home Pay :</span>
                        <span className="text-green-600">{formatter.format(calculations.takeHomePay)}</span>
                    </div>

                    <h3 className="text-xl font-bold text-brand-navy mt-8 mb-4 text-center font-serif">Deduction Details</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 text-base">
                        <ValueDisplay label="Total Standard/Itemized" value={calculations.standardOrItemizedDeduction} />
                        <ValueDisplay label="Total OBBBA Deductions" value={calculations.totalBelowTheLineOBBBADeductions} />
                        <div className="col-span-full">
                            <ValueDisplay label={`Using ${calculations.usingStandardDeduction ? 'Standard' : 'Itemized'} Deduction`} value={calculations.usingStandardDeduction ? calculations.calculatedStandardDeduction : calculations.totalItemizedDeductions} />
                        </div>
                    </div>

                    <h3 className="text-xl font-bold text-brand-navy mt-8 mb-4 text-center font-serif">Tax Calculation & Credits</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 text-base">
                        <ValueDisplay label="Federal Tax (Ordinary Income)" value={calculations.federalOrdinaryTax} />
                        <ValueDisplay label="Federal Tax (LTCG & Qual. Divs)" value={calculations.estimatedLTCGTax} />
                        <div className="flex justify-between items-center py-2 border-b border-gray-200">
                            <span className="font-medium text-gray-600">Highest LTCG/Qual. Div Rate:</span>
                            <span className="text-gray-800">{calculations.highestLTCGRateApplied.toFixed(0)}%</span>
                        </div>
                        <ValueDisplay label="Child Tax Credit (Allowed)" value={-calculations.childTaxCredit} />
                    </div>

                    <h3 className="text-xl font-bold text-brand-navy mt-8 mb-4 text-center font-serif">Social Security & Medicare</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 text-base">
                        <ValueDisplay label="Taxable Social Security" value={calculations.taxableSocialSecurity} />
                        <div className="flex justify-between items-center py-2 border-b border-gray-200">
                            <span className="font-medium text-gray-600">Percentage of SS Taxed:</span>
                            <span className="text-gray-800">{percentFormatter.format(calculations.percentageSSBenefitsTaxed / 100)}</span>
                        </div>
                        <ValueDisplay label="Monthly IRMAA Surcharge" value={calculations.irmaaMonthlySurcharge} />
                        <ValueDisplay label="Total Monthly Medicare Premium" value={calculations.irmaaTotalPremium} />
                        <div className="flex justify-between items-center py-2 border-b border-gray-200">
                            <span className="font-medium text-gray-600">IRMAA MAGI Bracket:</span>
                            <span className="text-gray-800">{calculations.irmaaBracket}</span>
                        </div>
                    </div>
                    <div className="col-span-full">
                        <ValueDisplay label="Room Until Next IRMAA Bracket" value={calculations.roomUntilNextIrmaaBracket === Infinity ? 0 : calculations.roomUntilNextIrmaaBracket} highlight={true} />
                    </div>

                    <h3 className="text-xl font-bold text-brand-navy mt-8 mb-4 text-center font-serif">Marginal Tax Bracket Insights</h3>
                    {/* Inner Card - Light Background */}
                    <div className="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 text-base">
                            <div className="flex justify-between items-center py-2 border-b border-gray-200">
                                <span className="font-medium text-gray-600">Current Fed. Ordinary Rate:</span>
                                <span className="text-brand-navy font-bold">{calculations.currentMarginalRate.toFixed(0)}%</span>
                            </div>
                            <div className="flex justify-between items-center py-2 border-b border-gray-200">
                                <span className="font-medium text-gray-600">Bracket Income Range:</span>
                                <span className="text-gray-700">{calculations.currentBracketRange}</span>
                            </div>
                            <div className="col-span-full">
                                <ValueDisplay label="Room Until Next Bracket Up" value={calculations.roomUntilNextBracket === Infinity ? 0 : calculations.roomUntilNextBracket} />
                            </div>
                        </div>
                    </div>

                    {/* LTCG Insights Section */}
                    {calculations.hasLTCG && (
                        <>
                            <h3 className="text-xl font-bold text-brand-navy mt-8 mb-4 text-center font-serif">Long-Term Capital Gains Insights</h3>
                            <div className="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 text-base">
                                    <div className="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span className="font-medium text-gray-600">Current LTCG/Qual. Div Rate:</span>
                                        <span className="text-brand-navy font-bold">{calculations.currentLTCGRate.toFixed(2)}%</span>
                                    </div>
                                    <div className="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span className="font-medium text-gray-600">Bracket Income Range:</span>
                                        <span className="text-gray-700">{calculations.currentLTCGBracketRange}</span>
                                    </div>
                                    <div className="col-span-full">
                                        <ValueDisplay label="Room Until Next LTCG Bracket Up" value={calculations.roomUntilNextLTCGBracket === Infinity ? 0 : calculations.roomUntilNextLTCGBracket} />
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    {/* Flags Section - Light Mode */}
                    <div className="mt-8">
                        <h3 className="text-2xl font-bold text-brand-navy mb-4 text-center font-serif">Important Tax Flags & Disallowances</h3>
                        <div className="grid grid-cols-1 gap-4 text-base">
                            {(() => {
                                const flags = [
                                    // ... (Same logic as before, omitting for brevity in display but INCLUDED in logic below) ...
                                    // --- Surtaxes & AMT ---
                                    { condition: calculations.niitLiability > 0, message: `Net Investment Income Tax (NIIT): Your MAGI and investment income trigger a NIIT liability of ${formatter.format(calculations.niitLiability)}. This is a 3.8% tax applied to investment income for high earners.` },
                                    { condition: calculations.additionalMedicareTax > 0, message: `Additional Medicare Tax: Your earned income exceeds the threshold, resulting in an additional 0.9% Medicare tax liability of ${formatter.format(calculations.additionalMedicareTax)}.` },
                                    { condition: calculations.amtLiability > 0, message: `Alternative Minimum Tax (AMT): You have an AMT liability of ${formatter.format(calculations.amtLiability)}. This parallel tax ensures high-income filers pay a minimum amount of tax.` },
                                    { condition: calculations.calculatedAGI > 500000 && calculations.allowableSaltDeduction < calculations.saltLimit, message: `SALT Deduction Phased Down: Because your AGI is over $500,000, your ${formatter.format(calculations.saltLimit, { minimumFractionDigits: 0 })} SALT deduction limit has been reduced to ${formatter.format(calculations.allowableSaltDeduction)}.` },
                                    { condition: calculations.calculatedAGI <= 500000 && calculations.originalSaltTaxes > calculations.allowableSaltDeduction, message: `SALT Deduction Capped: Your itemized deduction for state and local taxes is capped at ${formatter.format(calculations.allowableSaltDeduction)}, disallowing ${formatter.format(calculations.originalSaltTaxes - calculations.allowableSaltDeduction)} of your total SALT payments.` },
                                    { condition: calculations.disallowedChildTaxCredit > 0, message: `Child Tax Credit Phase-out: Your AGI exceeds the threshold, causing your Child Tax Credit to be reduced by ${formatter.format(calculations.disallowedChildTaxCredit)}.` },
                                    { condition: calculations.disallowedStudentLoanInterest > 0, message: `Student Loan Interest Deduction Reduced: Your MAGI is in the phase-out range, reducing your deductible student loan interest by ${formatter.format(calculations.disallowedStudentLoanInterest)}.` },
                                    { condition: calculations.p1_415c_limited, message: `Your 401(k) Limit Reached (Sec 415c): Your After-Tax 401(k) contribution was limited to ${formatter.format(calculations.actualAfterTax401k)} because your total contributions reached the limit (${formatter.format(calculations.limit415cP1)}) based on the statutory maximum or 100% of your compensation.` },
                                    { condition: calculations.p2_415c_limited, message: `Spouse's 401(k) Limit Reached (Sec 415c): Spouse's After-Tax 401(k) contribution was limited to ${formatter.format(calculations.actualSpouseAfterTax401k)} because their total contributions reached the limit (${formatter.format(calculations.limit415cP2)}) based on the statutory maximum or 100% of their compensation.` },
                                    { condition: calculations.isRothIraDisabled, message: `Roth IRA Contributions Disallowed: Your MAGI of ${formatter.format(calculations.magiForIrmaa)} is above the limit, disallowing direct Roth IRA contributions.` },
                                    { condition: !calculations.isRothIraDisabled && calculations.rothIRAWarning && calculations.rothIRAWarning.includes('phase-out'), message: `Roth IRA Contributions Limited: Your MAGI of ${formatter.format(calculations.magiForIrmaa)} is in the phase-out range, limiting your maximum direct contribution.` },
                                    { condition: calculations.disallowedIRADeduction > 0, message: `Traditional IRA Deduction Limited: Your Traditional IRA deduction is reduced by ${formatter.format(calculations.disallowedIRADeduction)} due to your MAGI and/or workplace retirement plan coverage.` },
                                    { condition: calculations.socialSecurityBenefitReduction > 0, message: `SS Earnings Test Reduction: Your Social Security benefits are reduced by ${formatter.format(calculations.socialSecurityBenefitReduction)} because you have earned income while being under your Full Retirement Age.` },
                                    { condition: calculations.irmaaMonthlySurcharge > 0, message: `Medicare IRMAA Surcharge: Your income triggers a ${formatter.format(calculations.irmaaMonthlySurcharge)} monthly surcharge on your Medicare premium, increasing your total monthly cost to ${formatter.format(calculations.irmaaTotalPremium)}.` },
                                    { condition: calculations.maxSepSolo401kContribution > 0, message: `Max SEP IRA / Solo 401(k) (Employer Portion): Based on your net self-employment earnings, your maximum potential employer profit-sharing contribution is approximately ${formatter.format(calculations.maxSepSolo401kContribution)}.` },
                                    { condition: calculations.hsaMedicareIssue, message: `HSA Contribution Warning: You have entered HSA contributions while age 65+. Once enrolled in Medicare, HSA contributions are not allowed and may be subject to a 6% excise tax. Please verify your Medicare enrollment status.` }
                                ];

                                const activeFlags = flags.filter(flag => flag.condition);

                                if (activeFlags.length > 0) {
                                    return activeFlags.map((flag, index) => (
                                        <div key={index} className="p-3 bg-red-50 border-l-4 border-red-500 text-red-800 rounded-r-md shadow-sm">
                                            <p>{flag.message}</p>
                                        </div>
                                    ));
                                } else {
                                    return (
                                        <div className="p-3 bg-green-50 border-l-4 border-green-500 text-green-800 rounded-r-md shadow-sm">
                                            <p className="font-semibold">All Clear!</p>
                                            <p className="text-green-700">No major disallowances or limitations were flagged based on your entries.</p>
                                        </div>
                                    );
                                }
                            })()}
                        </div>
                    </div>

                    <p className="text-xs text-gray-500 mt-4 text-center">
                        *Disclaimer: All figures are estimates for the 2026 tax year based on current interpretations of tax law and the OBBBA provisions. Actual figures, contribution limits, and tax brackets may vary based on official IRS publications. State and local tax estimations are generalized (using 2025 data where 2026 is unavailable) and may not reflect all specific circumstances or credits. QBI calculations are simplified. Consult a tax professional.*
                    </p>
                </div>
            );
        };
        // Main Application Component

        // Math expression parser for in-field calculations (e.g. "50000+10000")
        // Uses a safe recursive descent parser instead of eval/Function
        const evaluateMathExpression = (expr) => {
            if (typeof expr !== 'string') return Number(expr) || 0;
            const cleaned = expr.replace(/[^0-9+\-*/.()]/g, '').trim();
            if (!cleaned) return 0;

            // Safe tokenizer and parser
            let pos = 0;
            const peek = () => cleaned[pos];
            const consume = () => cleaned[pos++];

            const parseNumber = () => {
                let numStr = '';
                while (pos < cleaned.length && /[0-9.]/.test(peek())) {
                    numStr += consume();
                }
                return parseFloat(numStr) || 0;
            };

            const parseFactor = () => {
                if (peek() === '(') {
                    consume(); // (
                    const result = parseExpression();
                    if (peek() === ')') consume(); // )
                    return result;
                }
                if (peek() === '-') {
                    consume();
                    return -parseFactor();
                }
                return parseNumber();
            };

            const parseTerm = () => {
                let result = parseFactor();
                while (peek() === '*' || peek() === '/') {
                    const op = consume();
                    const right = parseFactor();
                    if (op === '*') result *= right;
                    else if (op === '/' && right !== 0) result /= right;
                    else if (right === 0) return 0; // Division by zero returns 0
                }
                return result;
            };

            const parseExpression = () => {
                let result = parseTerm();
                while (peek() === '+' || peek() === '-') {
                    const op = consume();
                    const right = parseTerm();
                    if (op === '+') result += right;
                    else result -= right;
                }
                return result;
            };

            try {
                const result = parseExpression();
                return isNaN(result) || !isFinite(result) ? 0 : Math.round(result * 100) / 100;
            } catch (e) {
                return 0;
            }
        };

        // MathInput component for fields that support expressions
        const MathInput = ({ value, onChange, label, className, min, disabled, placeholder, ...rest }) => {
            const [displayValue, setDisplayValue] = React.useState(value?.toString() || '');
            const [isFocused, setIsFocused] = React.useState(false);

            React.useEffect(() => {
                if (!isFocused) {
                    setDisplayValue(value?.toString() || '');
                }
            }, [value, isFocused]);

            const handleChange = (e) => {
                setDisplayValue(e.target.value);
            };

            const handleBlur = () => {
                setIsFocused(false);
                const evaluated = evaluateMathExpression(displayValue);
                const finalValue = min !== undefined ? Math.max(min, evaluated) : evaluated;
                onChange({ target: { value: finalValue } });
                setDisplayValue(finalValue.toString());
            };

            const handleFocus = () => {
                setIsFocused(true);
            };

            return (
                <input
                    type="text"
                    inputMode="decimal"
                    className={className}
                    value={displayValue}
                    onChange={handleChange}
                    onBlur={handleBlur}
                    onFocus={handleFocus}
                    disabled={disabled}
                    placeholder={placeholder || "e.g. 50000+10000"}
                    autoComplete="off"
                    {...rest}
                />
            );
        };

        function App() {
            const { useState, useEffect, useMemo, useCallback } = React;
            const CARD_STYLE = "bg-white rounded-xl shadow-lg p-6 sm:p-8 lg:p-10 w-full max-w-7xl border-t-4 border-brand-gold";
            const SECTION_STYLE = "p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200 mb-6 relative overflow-hidden";
            const LABEL_STYLE = "block text-gray-700 text-sm font-medium mb-1 tracking-wide";
            const INPUT_STYLE = "w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:border-brand-navy focus:ring-2 focus:ring-brand-navy/20 transition-all";
            const HEADER_STYLE = "text-xl font-semibold text-brand-navy mb-4 border-b-2 border-brand-gold pb-2 font-serif";
            const BUTTON_PRIMARY = "bg-brand-navy hover:bg-brand-navy/90 text-white font-bold py-2 px-6 rounded shadow-lg transform transition hover:scale-105";
            const BUTTON_SECONDARY = "bg-transparent border-2 border-brand-navy text-brand-navy hover:bg-brand-navy hover:text-white font-bold py-2 px-4 rounded transition-colors";



            const initialScenarioState = {
                // --- Income ---
                // UPDATED: Split W2 Income, removed grossIncome
                w2IncomeP1: 0, // Primary W2
                w2IncomeP2: 0, // Spouse W2
                selfEmploymentIncome: 0,
                selfEmploymentIncomeP2: 0, // Spouse self-employment income
                socialSecurityIncome: 0,
                form1099RIncome: 0,
                rothConversion: 0,
                shortTermCapitalGains: 0,
                longTermCapitalGains: 0,
                taxableInterest: 0,
                qualifiedDividends: 0,
                taxExemptInterest: 0,
                rentalIncome: 0,
                k1Income: 0,
                alimonyReceived: 0,
                // --- Status & Demographics ---
                filingStatus: 'single',
                numFilers65Plus: 0,
                spouseBirthYear: 0,
                numFilersBlind: 0,
                birthYearOfOldestFiler: 0,
                isFRAyear: false,
                numChildren: 0,
                selectedState: '',
                // --- Contributions & Deductions (Above-the-Line) ---
                traditional401k: 0,
                useMax401k: false,
                roth401k: 0,
                afterTax401k: 0,
                employer401k: 0, // NEW
                spouseTraditional401k: 0,
                spouseRoth401k: 0,
                spouseAfterTax401k: 0, // NEW
                spouseEmployer401k: 0, // NEW
                spouseUseMax401k: false,
                // UPDATED: Split IRA Inputs
                traditionalIRA_P1: 0,
                traditionalIRA_P2: 0,
                useMaxIRA: false, // Applies to P1 for convenience
                coveredByRetirementPlan: false,
                spouseCoveredByRetirementPlan: false,
                hsaContributions: 0,
                useMaxHSA: false,
                hsaFamilyCoverage: false,
                // UPDATED: Split Roth Inputs
                rothIRA_P1: 0,
                rothIRA_P2: 0,
                useMaxRothIRA: false,
                // UPDATED: Separated SEP/Solo 401k and SIMPLE IRA
                sepSolo401kContributions: 0,
                simpleIraContributions: 0, // NEW
                educatorExpenses: 0,
                alimonyPaid: 0,
                // --- Other Savings ---
                taxableBrokerageContributions: 0,
                savings529: 0,
                // --- Itemized Deductions ---
                saltTaxes: 0,
                mortgageInterest: 0,
                charitableContributions: 0,
                otherItemizedDeductions: 0,
                medicalExpenses: 0,
                wageringGains: 0,
                wageringLosses: 0,
                investmentInterestExpense: 0,
                // --- OBBBA & Other Deductions ---
                studentLoanInterest: 0,
                qualifiedTipsIncome: 0,
                qualifiedOvertimeIncome: 0,
                autoLoanInterest: 0,
                // --- QBI Inputs ---
                isSSTB: false,
                qbiW2Wages: 0,
                qbiUBIA: 0,
                // --- AMT Preference Items ---
                amtISOExercise: 0,
                amtPABInterest: 0,
                // --- Tax Payments ---
                federalTaxWithheldW2: 0,
                ficaTaxWithheldW2: 0,
                federalTaxWithheld1099R: 0,
                federalTaxWithheldEstimates: 0,
                stateTaxWithheldW2: 0,
                stateTaxWithheld1099R: 0,
                stateTaxWithheldEstimates: 0,
                localIncomeTaxPaid: 0,
                // --- Notes ---
                notes: '',
            };

            // Initialize scenario state from profile if available
            const getInitialStateFromProfile = () => {
                const baseState = { ...initialScenarioState };

                if (typeof GlobalStateManager !== 'undefined') {
                    try {
                        const profile = GlobalStateManager.getState();

                        // Filing status mapping
                        if (profile.filingStatus) {
                            const fsMap = { 'single': 'single', 'mfj': 'mfj', 'mfs': 'mfs', 'hoh': 'hoh' };
                            baseState.filingStatus = fsMap[profile.filingStatus] || 'single';
                        }

                        // State
                        if (profile.state) {
                            baseState.selectedState = profile.state;
                        }

                        // Calculate income from sources
                        if (profile.incomeSources && profile.incomeSources.length > 0) {
                            let w2P1 = 0, w2P2 = 0, ssIncome = 0, seIncome = 0, dividends = 0, interest = 0, rental = 0, k1 = 0;

                            profile.incomeSources.forEach(src => {
                                const amt = parseFloat(src.amount) || 0;
                                const owner = src.owner || 'client1';

                                switch (src.type) {
                                    case 'w2':
                                    case 'w2_bonus':
                                        if (owner === 'client1') w2P1 += amt;
                                        else if (owner === 'client2') w2P2 += amt;
                                        else { w2P1 += amt / 2; w2P2 += amt / 2; }
                                        break;
                                    case 'ssa_1099':
                                        ssIncome += amt;
                                        break;
                                    case '1099_nec':
                                        if (owner === 'client1') baseState.selfEmploymentIncome = amt;
                                        else baseState.selfEmploymentIncomeP2 = amt;
                                        break;
                                    case '1099_div':
                                        dividends += amt;
                                        break;
                                    case '1099_int':
                                        interest += amt;
                                        break;
                                    case 'rental':
                                        rental += amt;
                                        break;
                                    case 'k1':
                                        k1 += amt;
                                        break;
                                    case '1099r_pension':
                                    case '1099r_ira':
                                        baseState.form1099RIncome += amt;
                                        break;
                                }
                            });

                            baseState.w2IncomeP1 = w2P1;
                            baseState.w2IncomeP2 = w2P2;
                            baseState.socialSecurityIncome = ssIncome;
                            baseState.qualifiedDividends = dividends;
                            baseState.taxableInterest = interest;
                            baseState.rentalIncome = rental;
                            baseState.k1Income = k1;
                        }

                        // Birth year for age-based calculations
                        if (profile.client1?.dob) {
                            baseState.birthYearOfOldestFiler = new Date(profile.client1.dob).getFullYear();
                        }
                        if (profile.client2?.dob) {
                            baseState.spouseBirthYear = new Date(profile.client2.dob).getFullYear();
                        }

                        console.log('Tax Calculator: Loaded profile data', baseState);
                    } catch (e) {
                        console.warn('Tax Calculator: Failed to load profile', e);
                    }
                }

                return baseState;
            };

            // Get client names from GlobalStateManager for personalized labels
            const getClientNames = () => {
                if (typeof GlobalStateManager !== 'undefined') {
                    try {
                        const profile = GlobalStateManager.getState();
                        return {
                            client1: profile.client1?.name || 'Your',
                            client2: profile.client2?.name || 'Spouse'
                        };
                    } catch (e) {
                        return { client1: 'Your', client2: 'Spouse' };
                    }
                }
                return { client1: 'Your', client2: 'Spouse' };
            };
            const [clientNames, setClientNames] = useState(getClientNames);

            // Standalone client name entry (for when tool is used independently)
            const [clientType, setClientType] = useState('single');
            const [localClientName1, setLocalClientName1] = useState('');
            const [localClientName2, setLocalClientName2] = useState('');

            const getClientDisplayName = () => {
                if (localClientName1 && clientType === 'joint' && localClientName2) {
                    return `${localClientName1} & ${localClientName2}`;
                }
                return localClientName1 || '';
            };

            // Effective client names - use local names if entered, otherwise fall back to GlobalStateManager
            const effectiveClientNames = useMemo(() => ({
                client1: localClientName1 || clientNames.client1 || 'Your',
                client2: localClientName2 || clientNames.client2 || 'Spouse'
            }), [localClientName1, localClientName2, clientNames]);

            // Update client names when GlobalStateManager changes
            useEffect(() => {
                if (typeof GlobalStateManager !== 'undefined') {
                    const handleStateChange = () => {
                        setClientNames(getClientNames());
                    };
                    GlobalStateManager.subscribe(handleStateChange);
                    return () => GlobalStateManager.unsubscribe(handleStateChange);
                }
            }, []);

            const [scenario1, setScenario1] = useState(() => getInitialStateFromProfile());
            const [scenario2, setScenario2] = useState(initialScenarioState);
            const [activeScenario, setActiveScenario] = useState('scenario1');

            const [scenario1Name, setScenario1Name] = useState('Scenario 1');
            const [scenario2Name, setScenario2Name] = useState('Scenario 2');
            const [savedScenarios, setSavedScenarios] = useState([]);

            const currentScenarioData = activeScenario === 'scenario1' ? scenario1 : scenario2;
            const currentScenarioName = activeScenario === 'scenario1' ? scenario1Name : scenario2Name;

            const [showMethodology, setShowMethodology] = useState(false);
            const [showKeyNumbers, setShowKeyNumbers] = useState(false);
            const [showCalculator, setShowCalculator] = useState(false);

            // Handle download of 2026 Key Tax Numbers PDF
            const handleDownloadKeyNumbers = () => {
                // Create a link element and trigger download from the embedded PDF file
                // The PDF file should be in the same directory as this HTML file
                const link = document.createElement('a');
                link.href = '2026_key_numbers.pdf';
                link.download = '2026_Key_Numbers.pdf';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleExportPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                const pct = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2 });

                // 1. Embed Data for Re-Import (Metadata)
                const exportData = {
                    s1: { name: scenario1Name, data: scenario1 },
                    s2: { name: scenario2Name, data: scenario2 }
                };
                doc.setProperties({
                    title: "Comprehensive Tax Analysis",
                    subject: JSON.stringify(exportData),
                    author: "WM Tool",
                    creator: "TaxCalc V6"
                });

                // 2. Helper Function to Build Input Rows
                const buildInputRows = (data) => {
                    const rows = [];
                    const addHeader = (text) => rows.push([{ content: text, colSpan: 2, styles: { fillColor: [0, 32, 91], fontStyle: 'bold', textColor: 255 } }]);
                    const addRow = (label, val, isCurr = true) => {
                        if (val && val !== 0 && val !== '') {
                            rows.push([label, isCurr ? fmt.format(val) : val]);
                        }
                    };

                    // Personal
                    addHeader("Personal Details & Location");
                    rows.push(['Filing Status', data.filingStatus.toUpperCase()]);
                    rows.push(['State of Residence', STATE_TAX_DATA[data.selectedState]?.name || 'Not Selected']);
                    addRow('Birth Year', data.birthYearOfOldestFiler, false);
                    if (data.filingStatus === 'mfj') addRow('Spouse Birth Year', data.spouseBirthYear, false);
                    if (data.numChildren > 0) addRow('Number of Children', data.numChildren, false);
                    if (data.numFilersBlind > 0) addRow('Blind Filers', data.numFilersBlind, false);

                    // Income
                    addHeader("Income Sources");
                    addRow('W2 Income (Primary)', data.w2IncomeP1);
                    addRow('W2 Income (Spouse)', data.w2IncomeP2);
                    addRow('Self-Employment (Net)', data.selfEmploymentIncome);
                    addRow('Social Security Benefits', data.socialSecurityIncome);
                    addRow('Interest (Taxable)', data.taxableInterest);
                    addRow('Interest (Tax-Exempt)', data.taxExemptInterest);
                    addRow('Dividends (Qualified)', data.qualifiedDividends);
                    addRow('Capital Gains (Short-Term)', data.shortTermCapitalGains);
                    addRow('Capital Gains (Long-Term)', data.longTermCapitalGains);
                    addRow('Rental Income', data.rentalIncome);
                    addRow('K-1 Income', data.k1Income);
                    addRow('1099-R / Pension', data.form1099RIncome);
                    addRow('Roth Conversion', data.rothConversion);
                    addRow('Alimony Received', data.alimonyReceived);
                    addRow('Wagering Gains', data.wageringGains);

                    // Retirement
                    addHeader("Retirement & Savings Contributions");
                    addRow('401k Traditional (Primary)', data.traditional401k);
                    addRow('401k Roth (Primary)', data.roth401k);
                    addRow('401k After-Tax (Primary)', data.afterTax401k);
                    addRow('401k Employer Match (Primary)', data.employer401k);

                    addRow('401k Traditional (Spouse)', data.spouseTraditional401k);
                    addRow('401k Roth (Spouse)', data.spouseRoth401k);
                    addRow('401k After-Tax (Spouse)', data.spouseAfterTax401k);
                    addRow('401k Employer Match (Spouse)', data.spouseEmployer401k);

                    addRow('Traditional IRA (Primary)', data.traditionalIRA_P1);
                    addRow('Traditional IRA (Spouse)', data.traditionalIRA_P2);
                    addRow('Roth IRA (Primary)', data.rothIRA_P1);
                    addRow('Roth IRA (Spouse)', data.rothIRA_P2);

                    addRow('SEP / Solo 401k (Employer)', data.sepSolo401kContributions);
                    addRow('SIMPLE IRA', data.simpleIraContributions);
                    addRow('HSA Contributions', data.hsaContributions);
                    addRow('529 Savings', data.savings529);
                    addRow('Taxable Brokerage Additions', data.taxableBrokerageContributions);

                    // Deductions
                    addHeader("Itemized Deductions & Adjustments");
                    addRow('State & Local Taxes (SALT) Paid', data.saltTaxes);
                    addRow('Mortgage Interest', data.mortgageInterest);
                    addRow('Charitable Contributions', data.charitableContributions);
                    addRow('Medical Expenses', data.medicalExpenses);
                    addRow('Student Loan Interest', data.studentLoanInterest);
                    addRow('Educator Expenses', data.educatorExpenses);
                    addRow('Alimony Paid', data.alimonyPaid);

                    // Taxes Paid
                    addHeader("Taxes Already Withheld/Paid");
                    addRow('Federal Withholding (W2)', data.federalTaxWithheldW2);
                    addRow('State Withholding (W2)', data.stateTaxWithheldW2);
                    addRow('Federal Estimated Payments', data.federalTaxWithheldEstimates);
                    addRow('State Estimated Payments', data.stateTaxWithheldEstimates);

                    return rows;
                };

                // 3. Helper to Build Scenario Page
                const generateScenarioPage = (scenarioName, scenarioData, isFirstPage = false) => {
                    if (!isFirstPage) doc.addPage();

                    // Title
                    doc.setFontSize(18);
                    doc.setTextColor(0, 32, 91); // Navy
                    doc.text(`Scenario: ${scenarioName}`, 14, 20);

                    // Gold accent line under title
                    doc.setDrawColor(212, 175, 55);
                    doc.setLineWidth(0.5);
                    doc.line(14, 22, 80, 22);

                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);

                    // Add client name if provided
                    const clientDisplayName = getClientDisplayName();
                    if (clientDisplayName) {
                        doc.setFontSize(11);
                        doc.setTextColor(212, 175, 55); // Gold
                        doc.text(`Prepared for: ${clientDisplayName}`, 14, 34);
                    }

                    // --- INPUTS TABLE ---
                    doc.autoTable({
                        startY: clientDisplayName ? 44 : 38,
                        head: [['Input Item', 'Value']],
                        body: buildInputRows(scenarioData),
                        theme: 'striped',
                        headStyles: { fillColor: [0, 32, 91], textColor: [255, 255, 255] },
                        styles: { fontSize: 9, cellPadding: 2 },
                        alternateRowStyles: { fillColor: [249, 249, 247] }
                    });

                    // --- RESULTS TABLE ---
                    const calc = calculateFinancials(scenarioData);
                    const finalY = doc.lastAutoTable.finalY + 10;

                    // Check if we need a new page for results
                    if (finalY > 250) { doc.addPage(); doc.setTextColor(0, 32, 91); doc.text("Calculation Results", 14, 20); }
                    else { doc.setFontSize(14); doc.setTextColor(0, 32, 91); doc.text("Calculation Results", 14, finalY - 2); }

                    const resultBody = [
                        ['Adjusted Gross Income (AGI)', fmt.format(calc.calculatedAGI)],
                        ['Total Itemized/Standard Deduction', fmt.format(calc.standardOrItemizedDeduction)],
                        ['Taxable Income', fmt.format(calc.taxableIncome)],
                        ['Regular Federal Income Tax', fmt.format(calc.netFederalIncomeTax)],
                        ['Alternative Minimum Tax (AMT)', fmt.format(calc.amtLiability)],
                        ['Net Investment Income Tax (NIIT)', fmt.format(calc.niitLiability)],
                        ['State Income Tax', fmt.format(calc.stateIncomeTax)],
                        ['FICA & Self-Employment Tax', fmt.format(calc.totalFicaTax)],
                        [{ content: 'Total Tax Liability', styles: { fontStyle: 'bold' } }, { content: fmt.format(calc.totalEstimatedTax), styles: { fontStyle: 'bold' } }],
                        [{ content: 'Take-Home Pay', styles: { fontStyle: 'bold', fillColor: [253, 248, 227] } }, { content: fmt.format(calc.takeHomePay), styles: { fontStyle: 'bold', fillColor: [253, 248, 227], textColor: [0, 32, 91] } }]
                    ];

                    doc.autoTable({
                        startY: finalY > 250 ? 25 : finalY,
                        head: [['Metric', 'Result']],
                        body: resultBody,
                        theme: 'grid',
                        headStyles: { fillColor: [0, 32, 91], textColor: [212, 175, 55] },
                        alternateRowStyles: { fillColor: [249, 249, 247] }
                    });

                    return calc;
                };

                // 4. Generate Pages
                const s1Calc = generateScenarioPage(scenario1Name, scenario1, true);
                const s2Calc = generateScenarioPage(scenario2Name, scenario2, false);

                // 5. Comparison Page
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(0, 32, 91); // Navy
                doc.text("Side-by-Side Comparison", 14, 20);

                // Gold accent line under title
                doc.setDrawColor(212, 175, 55);
                doc.setLineWidth(0.5);
                doc.line(14, 22, 90, 22);

                doc.autoTable({
                    startY: 30,
                    head: [['Metric', scenario1Name, scenario2Name, 'Difference']],
                    body: [
                        ['AGI', fmt.format(s1Calc.calculatedAGI), fmt.format(s2Calc.calculatedAGI), fmt.format(s2Calc.calculatedAGI - s1Calc.calculatedAGI)],
                        ['Taxable Income', fmt.format(s1Calc.taxableIncome), fmt.format(s2Calc.taxableIncome), fmt.format(s2Calc.taxableIncome - s1Calc.taxableIncome)],
                        ['Total Tax Liability', fmt.format(s1Calc.totalEstimatedTax), fmt.format(s2Calc.totalEstimatedTax), fmt.format(s2Calc.totalEstimatedTax - s1Calc.totalEstimatedTax)],
                        ['Effective Tax Rate', pct.format(s1Calc.effectiveOverallTaxRate / 100), pct.format(s2Calc.effectiveOverallTaxRate / 100), pct.format((s2Calc.effectiveOverallTaxRate - s1Calc.effectiveOverallTaxRate) / 100)],
                        ['Total Savings (Pre + Post)', fmt.format(s1Calc.totalContributions), fmt.format(s2Calc.totalContributions), fmt.format(s2Calc.totalContributions - s1Calc.totalContributions)],
                        ['Take-Home Pay', fmt.format(s1Calc.takeHomePay), fmt.format(s2Calc.takeHomePay), fmt.format(s2Calc.takeHomePay - s1Calc.takeHomePay)]
                    ],
                    theme: 'striped',
                    headStyles: { fillColor: [0, 32, 91], textColor: [212, 175, 55] },
                    alternateRowStyles: { fillColor: [249, 249, 247] },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 50 },
                        3: { fontStyle: 'bold' }
                    }
                });

                doc.save("Detailed_Tax_Analysis_2026.pdf");
            };
            const handleImportPDF = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // We use PDF-Lib here because it is better at reading PDFs than jsPDF
                const { PDFDocument } = window.PDFLib;
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);

                // The inputs are hidden in the "Subject" metadata field
                const subject = pdfDoc.getSubject();

                if (subject) {
                    try {
                        const data = JSON.parse(subject);
                        if (data.s1 && data.s2) {
                            // Load the data back into the app
                            setScenario1(data.s1.data);
                            setScenario1Name(data.s1.name);
                            setScenario2(data.s2.data);
                            setScenario2Name(data.s2.name);

                            // Clear the file input so you can reload the same file if needed
                            e.target.value = null;

                            alert("Success! Scenarios imported from the PDF.");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error: Could not read scenario data from this PDF.");
                    }
                } else {
                    alert("No hidden scenario data found in this PDF file.");
                }
            };
            const handleSaveCurrentScenarioWithTag = () => {
                const tagName = prompt("Enter a tag for this scenario (e.g. 'Base', 'Optimistic'):", "Base");
                if (tagName === null) return;

                const newSavedScenario = {
                    name: currentScenarioName,
                    tag: tagName,
                    data: currentScenarioData,
                    timestamp: new Date().toISOString()
                };

                const updatedScenarios = [newSavedScenario, ...savedScenarios.filter(s => s.name !== currentScenarioName)].slice(0, 20);
                setSavedScenarios(updatedScenarios);
                localStorage.setItem('taxCalculatorSavedScenarios', JSON.stringify(updatedScenarios));
            };
            // UPDATED DESTRUCTURING BLOCK
            const {
                // UPDATED: Split W2 Income
                w2IncomeP1, w2IncomeP2,
                selfEmploymentIncome, selfEmploymentIncomeP2, socialSecurityIncome, form1099RIncome, rothConversion, shortTermCapitalGains, longTermCapitalGains,
                taxableInterest, qualifiedDividends, taxExemptInterest, rentalIncome, k1Income, alimonyReceived,
                filingStatus, numFilers65Plus, spouseBirthYear, numFilersBlind, birthYearOfOldestFiler, isFRAyear, numChildren, selectedState,
                // UPDATED: Added Employer Match and Spouse After-Tax
                traditional401k, useMax401k, roth401k, afterTax401k, employer401k,
                spouseTraditional401k, spouseRoth401k, spouseAfterTax401k, spouseEmployer401k, spouseUseMax401k,
                // UPDATED: Split IRA variables
                traditionalIRA_P1, traditionalIRA_P2, useMaxIRA, coveredByRetirementPlan, spouseCoveredByRetirementPlan,
                hsaContributions, useMaxHSA, hsaFamilyCoverage,
                rothIRA_P1, rothIRA_P2, useMaxRothIRA,
                // UPDATED: Separated SIMPLE IRA
                sepSolo401kContributions, simpleIraContributions,
                educatorExpenses, alimonyPaid,
                taxableBrokerageContributions, savings529,
                saltTaxes, mortgageInterest, charitableContributions, otherItemizedDeductions, medicalExpenses, wageringGains, wageringLosses, investmentInterestExpense,
                studentLoanInterest, qualifiedTipsIncome, qualifiedOvertimeIncome, autoLoanInterest,
                isSSTB, qbiW2Wages, qbiUBIA,
                amtISOExercise, amtPABInterest,
                federalTaxWithheldW2, ficaTaxWithheldW2, federalTaxWithheld1099R, federalTaxWithheldEstimates,
                stateTaxWithheldW2, stateTaxWithheld1099R, stateTaxWithheldEstimates, localIncomeTaxPaid,
                notes
            } = currentScenarioData;

            const setScenarioState = activeScenario === 'scenario1' ? setScenario1 : setScenario2;

            // Input validation helper - sanitizes values based on field type
            const validateInput = useCallback((field, value) => {
                // Fields that cannot be negative (most income types)
                const nonNegativeFields = [
                    'w2IncomeP1', 'w2IncomeP2', 'selfEmploymentIncome', 'selfEmploymentIncomeP2',
                    'socialSecurityIncome', 'form1099RIncome', 'rothConversion', 'taxableInterest',
                    'qualifiedDividends', 'taxExemptInterest', 'alimonyReceived', 'wageringGains',
                    'traditional401k', 'roth401k', 'afterTax401k', 'employer401k',
                    'spouseTraditional401k', 'spouseRoth401k', 'spouseAfterTax401k', 'spouseEmployer401k',
                    'traditionalIRA_P1', 'traditionalIRA_P2', 'hsaContributions', 'rothIRA_P1', 'rothIRA_P2',
                    'sepSolo401kContributions', 'simpleIraContributions', 'savings529', 'taxableBrokerageContributions',
                    'saltTaxes', 'mortgageInterest', 'charitableContributions', 'medicalExpenses',
                    'studentLoanInterest', 'educatorExpenses', 'autoLoanInterest', 'otherItemizedDeductions',
                    'qualifiedTipsIncome', 'qualifiedOvertimeIncome', 'qbiW2Wages', 'qbiUBIA',
                    'federalTaxWithheldW2', 'ficaTaxWithheldW2', 'federalTaxWithheldEstimates',
                    'stateTaxWithheldW2', 'stateTaxWithheldEstimates', 'localIncomeTaxPaid',
                    'numChildren', 'numFilersBlind'
                ];

                // Fields that CAN be negative (gains/losses, rental income)
                const allowNegativeFields = [
                    'shortTermCapitalGains', 'longTermCapitalGains', 'rentalIncome', 'k1Income',
                    'wageringLosses', 'investmentInterestExpense'
                ];

                // Birth year fields need bounds checking
                if (field === 'birthYearOfOldestFiler' || field === 'spouseBirthYear') {
                    const year = Number(value);
                    if (isNaN(year)) return CURRENT_TAX_YEAR - 40; // Default to ~40 years old
                    return Math.max(MIN_BIRTH_YEAR, Math.min(MAX_BIRTH_YEAR, year));
                }

                // Non-negative fields
                if (nonNegativeFields.includes(field)) {
                    const num = Number(value);
                    return isNaN(num) ? 0 : Math.max(0, num);
                }

                // Allow negative fields - just ensure it's a number
                if (allowNegativeFields.includes(field)) {
                    const num = Number(value);
                    return isNaN(num) ? 0 : num;
                }

                // Default: return as-is (for booleans, strings, etc.)
                return value;
            }, []);

            const handleInputChange = useCallback((field, value) => {
                const validatedValue = validateInput(field, value);
                setScenarioState(prev => ({ ...prev, [field]: validatedValue }));
            }, [setScenarioState, validateInput]);

            useEffect(() => {
                const age1 = CURRENT_TAX_YEAR - birthYearOfOldestFiler;
                let count = 0;
                if (age1 >= 65) {
                    count++;
                }
                if (filingStatus === 'mfj') {
                    const spouseAge = CURRENT_TAX_YEAR - spouseBirthYear;
                    if (spouseAge >= 65) {
                        count++;
                    }
                }
                handleInputChange('numFilers65Plus', count);
            }, [birthYearOfOldestFiler, spouseBirthYear, filingStatus, handleInputChange]);

            useEffect(() => {
                const loadedScenarios = localStorage.getItem('taxCalculatorSavedScenarios');
                if (loadedScenarios) {
                    setSavedScenarios(JSON.parse(loadedScenarios));
                }
            }, []);

            const cloneScenario1To2 = () => {
                setScenario2(scenario1);
                setScenario2Name(scenario1Name + " (Copy)");
                setActiveScenario('scenario2');
            };

            const handleSaveCurrentScenario = () => {
                const newSavedScenario = {
                    name: currentScenarioName,
                    data: currentScenarioData,
                    timestamp: new Date().toISOString()
                };

                const updatedScenarios = [newSavedScenario, ...savedScenarios.filter(s => s.name !== currentScenarioName)].slice(0, 5);

                setSavedScenarios(updatedScenarios);
                localStorage.setItem('taxCalculatorSavedScenarios', JSON.stringify(updatedScenarios));
                alert(`Scenario "${currentScenarioName}" saved!`);
            };

            const handleLoadScenario = (scenarioToLoad) => {
                if (!scenarioToLoad) return;

                // Ensure loaded data conforms to the new structure (e.g., handling the transition from 'grossIncome' to 'w2IncomeP1')
                const dataToLoad = { ...initialScenarioState, ...scenarioToLoad.data };

                // Handle legacy 'grossIncome' if present
                if (dataToLoad.grossIncome && dataToLoad.w2IncomeP1 === 0) {
                    dataToLoad.w2IncomeP1 = dataToLoad.grossIncome;
                    delete dataToLoad.grossIncome;
                }
                // Handle legacy 'sepIraContributions'
                if (dataToLoad.sepIraContributions && dataToLoad.sepSolo401kContributions === 0) {
                    dataToLoad.sepSolo401kContributions = dataToLoad.sepIraContributions;
                    delete dataToLoad.sepIraContributions;
                }

                const { name } = scenarioToLoad;

                if (activeScenario === 'scenario1') {
                    setScenario1(dataToLoad);
                    setScenario1Name(name);
                } else {
                    setScenario2(dataToLoad);
                    setScenario2Name(name);
                }
                alert(`Scenario "${name}" loaded into ${activeScenario === 'scenario1' ? 'Scenario 1' : 'Scenario 2'}.`);
            };

            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const percentFormatter = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const max401kLimit = useMemo(() => {
                const age = CURRENT_TAX_YEAR - currentScenarioData.birthYearOfOldestFiler;
                let limit = CONTRIBUTION_LIMITS['401k_regular'];
                // Logic for SECURE 2.0 Age 60-63 higher catch-up
                if (age >= 60 && age <= 63) {
                    limit += CONTRIBUTION_LIMITS['401k_catchup_60_63'];
                } else if (age >= 50) {
                    limit += CONTRIBUTION_LIMITS['401k_catchup'];
                }
                return limit;
            }, [currentScenarioData.birthYearOfOldestFiler]);

            const spouseMax401kLimit = useMemo(() => {
                if (currentScenarioData.filingStatus !== 'mfj' || !currentScenarioData.spouseBirthYear) return 0;
                const spouseAge = CURRENT_TAX_YEAR - currentScenarioData.spouseBirthYear;
                let limit = CONTRIBUTION_LIMITS['401k_regular'];
                // Logic for SECURE 2.0 Age 60-63 higher catch-up
                if (spouseAge >= 60 && spouseAge <= 63) {
                    limit += CONTRIBUTION_LIMITS['401k_catchup_60_63'];
                } else if (spouseAge >= 50) {
                    limit += CONTRIBUTION_LIMITS['401k_catchup'];
                }
                return limit;
            }, [currentScenarioData.spouseBirthYear, currentScenarioData.filingStatus]);

            const maxIraLimit = useMemo(() => {
                const { filingStatus, birthYearOfOldestFiler, spouseBirthYear } = currentScenarioData;
                const age = CURRENT_TAX_YEAR - birthYearOfOldestFiler;
                let totalLimit = CONTRIBUTION_LIMITS['ira_regular'] + (age >= 50 ? CONTRIBUTION_LIMITS['ira_catchup'] : 0);

                if (filingStatus === 'mfj') {
                    const spouseAge = CURRENT_TAX_YEAR - spouseBirthYear;
                    const spouseMax = CONTRIBUTION_LIMITS['ira_regular'] + (spouseAge >= 50 ? CONTRIBUTION_LIMITS['ira_catchup'] : 0);
                    totalLimit += spouseMax;
                }

                return totalLimit;
            }, [currentScenarioData.filingStatus, currentScenarioData.birthYearOfOldestFiler, currentScenarioData.spouseBirthYear]);

            const maxHsaLimit = useMemo(() => {
                const age = CURRENT_TAX_YEAR - currentScenarioData.birthYearOfOldestFiler;
                // Cannot contribute to HSA once enrolled in Medicare (typically age 65+)
                if (age >= MEDICARE_ENROLLMENT_AGE) return 0;
                let limit = currentScenarioData.hsaFamilyCoverage ? CONTRIBUTION_LIMITS['hsa_family'] : CONTRIBUTION_LIMITS['hsa_self_only'];
                limit += (age >= 55 ? CONTRIBUTION_LIMITS['hsa_catchup'] : 0);
                return limit;
            }, [currentScenarioData.birthYearOfOldestFiler, currentScenarioData.hsaFamilyCoverage]);

            // HSA Medicare warning for display
            const hsaMedicareWarning = useMemo(() => {
                const age = CURRENT_TAX_YEAR - currentScenarioData.birthYearOfOldestFiler;
                if (age >= MEDICARE_ENROLLMENT_AGE && currentScenarioData.hsaContributions > 0) {
                    return 'Warning: HSA contributions are not allowed once enrolled in Medicare (typically age 65+). These contributions may be subject to a 6% excise tax.';
                }
                return null;
            }, [currentScenarioData.birthYearOfOldestFiler, currentScenarioData.hsaContributions]);

            useEffect(() => { if (useMax401k) handleInputChange('traditional401k', max401kLimit); }, [useMax401k, max401kLimit, activeScenario, handleInputChange]);
            useEffect(() => { if (useMaxIRA) handleInputChange('traditionalIRA_P1', maxIraLimit); }, [useMaxIRA, maxIraLimit, activeScenario, handleInputChange]);
            useEffect(() => { if (useMaxHSA) handleInputChange('hsaContributions', maxHsaLimit); }, [useMaxHSA, maxHsaLimit, activeScenario, handleInputChange]);
            useEffect(() => { if (currentScenarioData.spouseUseMax401k) handleInputChange('spouseTraditional401k', spouseMax401kLimit); }, [currentScenarioData.spouseUseMax401k, spouseMax401kLimit, activeScenario, handleInputChange]);

            // --- FINAL, COMPLETE AND UNABBREVIATED calculateFinancials FUNCTION ---
            const calculateFinancials = (scenarioData) => {
                const {
                    // UPDATED: Using split W2 income
                    w2IncomeP1, w2IncomeP2,
                    selfEmploymentIncome, selfEmploymentIncomeP2, socialSecurityIncome, form1099RIncome, rothConversion, shortTermCapitalGains, longTermCapitalGains,
                    taxableInterest, qualifiedDividends, taxExemptInterest, rentalIncome, k1Income, alimonyReceived,
                    filingStatus, numFilers65Plus, spouseBirthYear, numFilersBlind, birthYearOfOldestFiler, isFRAyear, numChildren, selectedState,
                    // UPDATED: Added Employer Match and Spouse After-Tax
                    traditional401k, roth401k, afterTax401k, employer401k,
                    spouseTraditional401k, spouseRoth401k, spouseAfterTax401k, spouseEmployer401k,
                    traditionalIRA_P1, traditionalIRA_P2, hsaContributions, rothIRA_P1, rothIRA_P2,
                    coveredByRetirementPlan, spouseCoveredByRetirementPlan,
                    // UPDATED: Separated SIMPLE IRA
                    sepSolo401kContributions, simpleIraContributions,
                    educatorExpenses, alimonyPaid,
                    taxableBrokerageContributions, savings529,
                    saltTaxes, mortgageInterest, charitableContributions, otherItemizedDeductions, medicalExpenses, wageringGains, wageringLosses, investmentInterestExpense,
                    studentLoanInterest, qualifiedTipsIncome, qualifiedOvertimeIncome, autoLoanInterest,
                    isSSTB, qbiW2Wages, qbiUBIA,
                    amtISOExercise, amtPABInterest,
                    federalTaxWithheldW2, federalTaxWithheld1099R, federalTaxWithheldEstimates,
                    stateTaxWithheldW2, stateTaxWithheld1099R, stateTaxWithheldEstimates, localIncomeTaxPaid
                } = scenarioData;
                const netCapitalGains = shortTermCapitalGains + longTermCapitalGains;

                // Calculate combined W2 income for AGI purposes
                // Ensure P2 income is zero if not MFJ
                const incomeP1 = w2IncomeP1 || 0;
                const incomeP2 = filingStatus === 'mfj' ? (w2IncomeP2 || 0) : 0;
                const grossIncome = incomeP1 + incomeP2;

                // --- Contribution Validation & AGI Deductions ---
                const age = CURRENT_TAX_YEAR - birthYearOfOldestFiler;
                const spouseAge = filingStatus === 'mfj' && spouseBirthYear ? CURRENT_TAX_YEAR - spouseBirthYear : 0;

                // Helper function to calculate 401k limits and validate contributions against 402(g) and 415(c)
                const process401k = (age, tradInput, rothInput, employerInput, afterTaxInput, w2Income) => {
                    const regularLimit = CONTRIBUTION_LIMITS['401k_regular'];
                    let catchupLimit = 0;
                    if (age >= 60 && age <= 63) {
                        catchupLimit = CONTRIBUTION_LIMITS['401k_catchup_60_63'];
                    } else if (age >= 50) {
                        catchupLimit = CONTRIBUTION_LIMITS['401k_catchup'];
                    }
                    const maxElective = regularLimit + catchupLimit;

                    // 1. Cap inputs at W2 income first (assuming plan allows 100% deferral)
                    const cappedTrad = Math.min(tradInput, w2Income);
                    const cappedRoth = Math.min(rothInput, w2Income - cappedTrad);
                    const totalElectiveInput = cappedTrad + cappedRoth;

                    // 2. Determine actual elective deferrals (Apply 402(g) limit)
                    const actualTotalElective = Math.min(totalElectiveInput, maxElective);

                    // 3. Identify Catch-up vs Regular (Crucial for 415c)
                    // Catch-up contributions do not count towards the 415(c) limit.
                    const actualCatchupUsed = Math.max(0, actualTotalElective - regularLimit);
                    const actualRegularElective = actualTotalElective - actualCatchupUsed;

                    // 4. Distribute actual amounts back to Trad/Roth (for AGI calculation)
                    // If capped (by income or 402g), distribute proportionally based on the income-capped inputs
                    let actualTrad, actualRoth;
                    if (totalElectiveInput > 0 && actualTotalElective < totalElectiveInput) {
                        const tradRatio = cappedTrad / totalElectiveInput;
                        actualTrad = actualTotalElective * tradRatio;
                        actualRoth = actualTotalElective - actualTrad;
                    } else {
                        // Otherwise, use the income-capped values
                        actualTrad = cappedTrad;
                        actualRoth = cappedRoth;
                    }

                    // 5. Validate Employer Match (Cannot exceed compensation)
                    const actualEmployer = Math.min(employerInput, w2Income);

                    // 6. 415(c) Limit Calculation
                    // The 415(c) limit is the lesser of $72k or 100% of compensation.
                    const effective415cLimit = Math.min(SECTION_415C_LIMIT, w2Income);

                    // Calculate space remaining for After-Tax (Mega Backdoor)
                    const contributionsCountingTowards415c = actualRegularElective + actualEmployer;
                    const availableSpaceForAfterTax = Math.max(0, effective415cLimit - contributionsCountingTowards415c);

                    const actualAfterTax = Math.min(afterTaxInput, availableSpaceForAfterTax);

                    // Flag if 415(c) limit reduced the after-tax contribution
                    const reducedBy415c = (afterTaxInput > actualAfterTax);

                    return {
                        actualTrad,
                        actualRoth,
                        actualAfterTax,
                        actualEmployer,
                        reducedBy415c,
                        limit415c: effective415cLimit
                    };
                };

                // Process 401k for Primary Filer (P1)
                const p1_401k = process401k(
                    age,
                    traditional401k,
                    roth401k,
                    employer401k,
                    afterTax401k,
                    incomeP1
                );

                // Process 401k for Spouse (P2)
                const p2_401k = filingStatus === 'mfj' ? process401k(
                    spouseAge,
                    spouseTraditional401k,
                    spouseRoth401k,
                    spouseEmployer401k,
                    spouseAfterTax401k,
                    incomeP2
                ) : { actualTrad: 0, actualRoth: 0, actualAfterTax: 0, actualEmployer: 0, reducedBy415c: false, limit415c: 0 };

                // Extract the values needed for AGI calculation
                const actualTraditional401k = p1_401k.actualTrad;
                const actualSpouseTraditional401k = p2_401k.actualTrad;

                // NEW: SIMPLE IRA Validation (Basic validation against limits)
                // SECURE 2.0: Ages 60-63 get enhanced catch-up of $5,250 (instead of $4,000)
                let simpleIraCatchup = 0;
                if (age >= 60 && age <= 63) {
                    simpleIraCatchup = 5250; // Enhanced catch-up for ages 60-63 per SECURE 2.0
                } else if (age >= 50) {
                    simpleIraCatchup = CONTRIBUTION_LIMITS['simple_catchup']; // $4,000 standard catch-up
                }
                const maxSimple = CONTRIBUTION_LIMITS['simple_regular'] + simpleIraCatchup;
                const actualSimpleIraContributions = Math.min(simpleIraContributions, maxSimple);

                const total1099RIncome = form1099RIncome + rothConversion;

                // --- 1. Calculate FICA & Self-Employment Taxes ---
                // UPDATED: FICA calculated individually, with split SE income for P1 and P2

                // P1 FICA (W2)
                const socialSecurityTaxW2_P1 = Math.min(incomeP1, SOCIAL_SECURITY_WAGE_BASE) * SOCIAL_SECURITY_RATE_EMPLOYEE;
                const medicareTaxW2_P1 = incomeP1 * MEDICARE_RATE_EMPLOYEE;

                // P2 FICA (W2)
                const socialSecurityTaxW2_P2 = Math.min(incomeP2, SOCIAL_SECURITY_WAGE_BASE) * SOCIAL_SECURITY_RATE_EMPLOYEE;
                const medicareTaxW2_P2 = incomeP2 * MEDICARE_RATE_EMPLOYEE;

                const socialSecurityTaxW2 = socialSecurityTaxW2_P1 + socialSecurityTaxW2_P2;
                const medicareTaxW2 = medicareTaxW2_P1 + medicareTaxW2_P2;

                // Self-Employment Tax P1
                const netEarningsSE_P1 = selfEmploymentIncome * SE_TAX_NET_EARNINGS_FACTOR;
                const remainingSSWageBaseP1 = Math.max(0, SOCIAL_SECURITY_WAGE_BASE - incomeP1);
                const ssTaxSE_P1 = Math.min(netEarningsSE_P1, remainingSSWageBaseP1) * (SOCIAL_SECURITY_RATE_EMPLOYEE * 2);
                const medicareTaxSE_P1 = netEarningsSE_P1 * (MEDICARE_RATE_EMPLOYEE * 2);

                // Self-Employment Tax P2 (NEW: Split SE income for spouse)
                const netEarningsSE_P2 = (selfEmploymentIncomeP2 || 0) * SE_TAX_NET_EARNINGS_FACTOR;
                const remainingSSWageBaseP2 = Math.max(0, SOCIAL_SECURITY_WAGE_BASE - incomeP2);
                const ssTaxSE_P2 = Math.min(netEarningsSE_P2, remainingSSWageBaseP2) * (SOCIAL_SECURITY_RATE_EMPLOYEE * 2);
                const medicareTaxSE_P2 = netEarningsSE_P2 * (MEDICARE_RATE_EMPLOYEE * 2);

                const selfEmploymentTax = ssTaxSE_P1 + medicareTaxSE_P1 + ssTaxSE_P2 + medicareTaxSE_P2;

                // Combined net SE earnings for AGI calculations
                const totalNetEarningsFromSE = netEarningsSE_P1 + netEarningsSE_P2;
                const totalSelfEmploymentIncome = selfEmploymentIncome + (selfEmploymentIncomeP2 || 0);

                // Additional Medicare Tax (Based on combined earnings and joint thresholds)
                const combinedEarnings = grossIncome + totalNetEarningsFromSE;
                const additionalMedicareThreshold = ADDITIONAL_MEDICARE_TAX_THRESHOLDS[filingStatus];
                const additionalMedicareTax = Math.max(0, combinedEarnings - additionalMedicareThreshold) * ADDITIONAL_MEDICARE_TAX_RATE;

                const totalFicaTax = socialSecurityTaxW2 + medicareTaxW2 + selfEmploymentTax + additionalMedicareTax;

                // --- 2. Calculate Adjusted Gross Income (AGI) ---
                const selfEmploymentTaxDeduction = selfEmploymentTax * SE_TAX_DEDUCTION_FACTOR;

                // SEP/Solo 401k Contribution Calculation (based on combined SE earnings)
                const seBaseForRetirement = totalNetEarningsFromSE - selfEmploymentTaxDeduction;
                // Max employer contribution (approx 20% of net earnings after 1/2 SE tax)
                const maxSepSolo401kContribution = seBaseForRetirement * SEP_IRA_CONTRIBUTION_RATE;

                const totalGrossReceipts = grossIncome + totalSelfEmploymentIncome + total1099RIncome + shortTermCapitalGains + longTermCapitalGains + taxableInterest + qualifiedDividends + k1Income + alimonyReceived + rentalIncome + wageringGains;

                // UPDATED: Include SIMPLE IRA contributions and use actual 401k values
                let agiDeductions = actualTraditional401k + actualSpouseTraditional401k + hsaContributions + selfEmploymentTaxDeduction + sepSolo401kContributions + actualSimpleIraContributions + educatorExpenses + alimonyPaid;

                // Passive Activity Loss (PAL) Limitation
                let deductibleRentalLoss = 0;
                if (rentalIncome < 0) {
                    const provisionalAgiForPAL = totalGrossReceipts - agiDeductions;
                    if (provisionalAgiForPAL < PAL_AGI_PHASEOUT.max) {
                        let palLimit = PAL_MAX_DEDUCTION;
                        if (provisionalAgiForPAL > PAL_AGI_PHASEOUT.min) {
                            const reduction = (provisionalAgiForPAL - PAL_AGI_PHASEOUT.min) / (PAL_AGI_PHASEOUT.max - PAL_AGI_PHASEOUT.min);
                            palLimit = PAL_MAX_DEDUCTION * (1 - reduction);
                        }
                        deductibleRentalLoss = Math.max(rentalIncome, -palLimit);
                    }
                }
                const incomeBeforeAgiDeductions = grossIncome + totalSelfEmploymentIncome + total1099RIncome + shortTermCapitalGains + longTermCapitalGains + taxableInterest + qualifiedDividends + k1Income + alimonyReceived + (rentalIncome >= 0 ? rentalIncome : deductibleRentalLoss) + wageringGains;

                // MAGI for Student Loan Interest and IRA Deductions
                let provisionalAgiForDeductions = incomeBeforeAgiDeductions - agiDeductions + taxExemptInterest;

                // Student Loan Interest Deduction
                let deductibleStudentLoanInterest = 0;
                const studentLoanPhaseout = STUDENT_LOAN_PHASEOUTS[filingStatus];
                if (studentLoanPhaseout && studentLoanPhaseout.max > 0) {
                    const maxDeduction = Math.min(studentLoanInterest, STUDENT_LOAN_INTEREST_MAX);
                    if (provisionalAgiForDeductions < studentLoanPhaseout.min) { deductibleStudentLoanInterest = maxDeduction; }
                    else if (provisionalAgiForDeductions < studentLoanPhaseout.max) {
                        const reductionRatio = (provisionalAgiForDeductions - studentLoanPhaseout.min) / (studentLoanPhaseout.max - studentLoanPhaseout.min);
                        deductibleStudentLoanInterest = maxDeduction * (1 - reductionRatio);
                    }
                }
                agiDeductions += deductibleStudentLoanInterest;
                const disallowedStudentLoanInterest = studentLoanInterest - deductibleStudentLoanInterest;

                // Recalculate MAGI after Student Loan deduction
                provisionalAgiForDeductions = incomeBeforeAgiDeductions - agiDeductions + taxExemptInterest;

                // --- UPDATED: Split Traditional IRA Deduction Limitation ---
                // We calculate deductibility for P1 and P2 separately based on their specific coverage status

                // Helper to calculate deductible amount for a specific person
                const calcIraDeduction = (contribution, isCovered, isSpouseCovered, filingStatus, magi) => {
                    let deductible = contribution;

                    if (isCovered) {
                        // If covered, use standard phaseouts
                        let phaseout = null;
                        if (filingStatus === 'single' || filingStatus === 'hoh') phaseout = IRA_PHASEOUT_SINGLE_COVERED_BY_PLAN;
                        else if (filingStatus === 'mfj') phaseout = IRA_PHASEOUT_MFJ_CONTRIBUTOR_COVERED_BY_PLAN;
                        else if (filingStatus === 'mfs') phaseout = IRA_PHASEOUT_MFS_COVERED_BY_PLAN;

                        if (phaseout && magi > phaseout.min) {
                            const range = phaseout.max - phaseout.min;
                            const reduction = Math.min(1, (magi - phaseout.min) / range);
                            deductible = contribution * (1 - reduction);
                        }
                    } else if (filingStatus === 'mfj' && isSpouseCovered) {
                        // If not covered, but spouse IS covered (MFJ only)
                        const phaseout = IRA_PHASEOUT_MFJ_NON_CONTRIBUTOR_SPOUSE_COVERED_BY_PLAN;
                        if (magi > phaseout.min) {
                            const range = phaseout.max - phaseout.min;
                            const reduction = Math.min(1, (magi - phaseout.min) / range);
                            deductible = contribution * (1 - reduction);
                        }
                    }
                    // If neither covered, or single and not covered, full deduction (no change to 'deductible')
                    return Math.max(0, Math.round(deductible));
                };

                // Calculate P1 Deduction
                const deductibleIRA_P1 = calcIraDeduction(traditionalIRA_P1, coveredByRetirementPlan, spouseCoveredByRetirementPlan, filingStatus, provisionalAgiForDeductions);

                // Calculate P2 Deduction (only if MFJ)
                const deductibleIRA_P2 = filingStatus === 'mfj'
                    ? calcIraDeduction(traditionalIRA_P2, spouseCoveredByRetirementPlan, coveredByRetirementPlan, filingStatus, provisionalAgiForDeductions)
                    : 0;

                const totalTraditionalIRAInput = traditionalIRA_P1 + traditionalIRA_P2;
                let deductibleIRA = deductibleIRA_P1 + deductibleIRA_P2;

                agiDeductions += deductibleIRA;
                const disallowedIRADeduction = totalTraditionalIRAInput - deductibleIRA;

                const calculatedAGI_preSS = Math.max(0, incomeBeforeAgiDeductions - agiDeductions);

                // Social Security Earnings Test Reduction
                let socialSecurityBenefitReduction = 0;
                const currentAge = CURRENT_TAX_YEAR - birthYearOfOldestFiler;
                const fra = 67; // Simplified Full Retirement Age
                if (socialSecurityIncome > 0 && (grossIncome + totalSelfEmploymentIncome) > 0) {
                    if (isFRAyear) {
                        const excessEarnings = Math.max(0, (grossIncome + totalSelfEmploymentIncome) - SS_EARNINGS_LIMIT_FRA_YEAR);
                        socialSecurityBenefitReduction = excessEarnings / SS_REDUCTION_RATE_FRA_YEAR;
                    } else if (currentAge < fra) {
                        const excessEarnings = Math.max(0, (grossIncome + totalSelfEmploymentIncome) - SS_EARNINGS_LIMIT_UNDER_FRA);
                        socialSecurityBenefitReduction = excessEarnings / SS_REDUCTION_RATE_UNDER_FRA;
                    }
                    socialSecurityBenefitReduction = Math.min(socialSecurityBenefitReduction, socialSecurityIncome);
                }
                const adjustedSocialSecurityIncome = socialSecurityIncome - socialSecurityBenefitReduction;

                // Social Security Taxation
                let taxableSocialSecurity = 0;
                const ssThresholds = SS_TAX_THRESHOLDS[filingStatus];
                const provisionalIncomeForSS = calculatedAGI_preSS + (adjustedSocialSecurityIncome * 0.5) + taxExemptInterest;
                if (filingStatus === 'mfs' && provisionalIncomeForSS > 0) { taxableSocialSecurity = adjustedSocialSecurityIncome * 0.85; }
                else if (provisionalIncomeForSS > ssThresholds.first) {
                    if (provisionalIncomeForSS <= ssThresholds.second) { taxableSocialSecurity = Math.min(adjustedSocialSecurityIncome * 0.5, (provisionalIncomeForSS - ssThresholds.first) * 0.5); }
                    else {
                        const taxAt50 = (ssThresholds.second - ssThresholds.first) * 0.5;
                        const taxAt85 = (provisionalIncomeForSS - ssThresholds.second) * 0.85;
                        taxableSocialSecurity = Math.min(adjustedSocialSecurityIncome * 0.85, taxAt50 + taxAt85);
                    }
                }
                const percentageSSBenefitsTaxed = (adjustedSocialSecurityIncome > 0 && taxableSocialSecurity >= 0)
                    ? Math.min(100, (taxableSocialSecurity / adjustedSocialSecurityIncome) * 100)
                    : 0;
                const finalCalculatedAGI = calculatedAGI_preSS + Math.max(0, taxableSocialSecurity);

                // --- 3. Calculate Deductions & Taxable Income ---
                const magiForIrmaaAndNIIT = finalCalculatedAGI + taxExemptInterest;

                // Itemized Deductions
                const netInvestmentIncome = taxableInterest + qualifiedDividends + shortTermCapitalGains + longTermCapitalGains + Math.max(0, rentalIncome) + Math.max(0, k1Income);
                const deductibleInvestmentInterest = Math.min(investmentInterestExpense, netInvestmentIncome);
                const medicalExpenseDeduction = Math.max(0, medicalExpenses - (finalCalculatedAGI * MEDICAL_EXPENSE_AGI_FLOOR));
                const wageringLossesDeduction = Math.min(wageringLosses, wageringGains);

                // SALT Deduction (OBBBA Rules)
                let allowableSalt = saltTaxes;
                const saltLimit = filingStatus === 'mfs' ? SALT_DEDUCTION_LIMIT_MFS : SALT_DEDUCTION_LIMIT;
                allowableSalt = Math.min(allowableSalt, saltLimit);
                if (finalCalculatedAGI > SALT_PHASEDOWN_THRESHOLD) {
                    const excessAGI = finalCalculatedAGI - SALT_PHASEDOWN_THRESHOLD;
                    const reduction = excessAGI * SALT_PHASEDOWN_RATE;
                    const saltFloor = filingStatus === 'mfs' ? SALT_PHASEDOWN_FLOOR / 2 : SALT_PHASEDOWN_FLOOR;
                    allowableSalt = Math.max(saltFloor, allowableSalt - reduction);
                }
                const totalItemizedDeductions = allowableSalt + mortgageInterest + Math.min(charitableContributions, finalCalculatedAGI * CHARITABLE_CONTRIBUTION_AGI_LIMIT) + medicalExpenseDeduction + wageringLossesDeduction + deductibleInvestmentInterest + otherItemizedDeductions;

                // Standard Deduction
                let baseStandardDeduction = STANDARD_DEDUCTIONS[filingStatus];
                let totalAdditionalDeductions = 0;
                const addtlAmount = (filingStatus === 'single' || filingStatus === 'hoh') ? EXISTING_ADDITIONAL_DEDUCTION_65_PLUS_SINGLE_HOH : EXISTING_ADDITIONAL_DEDUCTION_65_PLUS_MFJ_MFS;
                totalAdditionalDeductions += addtlAmount * numFilers65Plus;
                totalAdditionalDeductions += addtlAmount * numFilersBlind;
                const calculatedStandardDeduction = baseStandardDeduction + totalAdditionalDeductions;

                const standardOrItemizedDeduction = Math.max(calculatedStandardDeduction, totalItemizedDeductions);
                const usingStandardDeduction = standardOrItemizedDeduction === calculatedStandardDeduction;

                // --- OBBBA DEDUCTION LOGIC ---

                // 1. OBBBA Temporary Senior Deduction (Age 65+)
                let obbbaSeniorDeduction = 0;
                if (numFilers65Plus > 0) {
                    const maxDeduction = numFilers65Plus * OBBBA_ADDITIONAL_DEDUCTION_65_PLUS; // $6,000 per person
                    const threshold = (filingStatus === 'single' || filingStatus === 'hoh') ? OBBBA_65_PLUS_DEDUCTION_PHASEOUT_SINGLE_THRESHOLD : OBBBA_65_PLUS_DEDUCTION_PHASEOUT_JOINT_THRESHOLD; // $75k single, $150k joint

                    if (magiForIrmaaAndNIIT > threshold) {
                        const excessMagi = magiForIrmaaAndNIIT - threshold;
                        const reduction = excessMagi * OBBBA_65_PLUS_DEDUCTION_PHASEOUT_RATE; // 6% phaseout rate
                        obbbaSeniorDeduction = Math.max(0, maxDeduction - reduction);
                    } else {
                        obbbaSeniorDeduction = maxDeduction;
                    }
                }

                // 2. OBBBA Qualified Tips Deduction
                let tipsDeduction = 0;
                if (qualifiedTipsIncome > 0) {
                    const maxDeduction = OBBBA_TIPS_DEDUCTION_MAX; // $25,000
                    const threshold = (filingStatus === 'single' || filingStatus === 'hoh') ? OBBBA_TIPS_DEDUCTION_PHASEOUT_SINGLE_HOH_THRESHOLD : OBBBA_TIPS_DEDUCTION_PHASEOUT_JOINT_THRESHOLD; // $150k single, $300k joint

                    let potentialDeduction = Math.min(qualifiedTipsIncome, maxDeduction);

                    if (magiForIrmaaAndNIIT > threshold) {
                        const excessMagi = magiForIrmaaAndNIIT - threshold;
                        const reduction = excessMagi * OBBBA_TIPS_DEDUCTION_PHASEOUT_RATE; // 10% phaseout rate ($100 per $1,000)
                        potentialDeduction -= reduction;
                    }
                    tipsDeduction = Math.max(0, potentialDeduction);
                }

                // 3. OBBBA Qualified Overtime Deduction
                let overtimeDeduction = 0;
                if (qualifiedOvertimeIncome > 0) {
                    const maxDeduction = (filingStatus === 'mfj') ? OBBBA_OVERTIME_DEDUCTION_MAX_JOINT : OBBBA_OVERTIME_DEDUCTION_MAX_SINGLE_HOH; // $12.5k single, $25k joint
                    const threshold = (filingStatus === 'single' || filingStatus === 'hoh') ? OBBBA_OVERTIME_DEDUCTION_PHASEOUT_SINGLE_HOH_THRESHOLD : OBBBA_OVERTIME_DEDUCTION_PHASEOUT_JOINT_THRESHOLD; // $150k single, $300k joint

                    let potentialDeduction = Math.min(qualifiedOvertimeIncome, maxDeduction);

                    if (magiForIrmaaAndNIIT > threshold) {
                        const excessMagi = magiForIrmaaAndNIIT - threshold;
                        const reduction = excessMagi * OBBBA_OVERTIME_DEDUCTION_PHASEOUT_RATE; // 10% phaseout rate
                        potentialDeduction -= reduction;
                    }
                    overtimeDeduction = Math.max(0, potentialDeduction);
                }

                // 4. OBBBA Auto Loan Interest Deduction
                let autoLoanDeduction = 0;
                if (autoLoanInterest > 0) {
                    const maxDeduction = OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_MAX; // $10,000
                    const threshold = (filingStatus === 'single' || filingStatus === 'hoh') ? OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_PHASEOUT_SINGLE_THRESHOLD : OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_PHASEOUT_JOINT_THRESHOLD; // $100k single, $200k joint

                    let potentialDeduction = Math.min(autoLoanInterest, maxDeduction);

                    if (magiForIrmaaAndNIIT > threshold) {
                        const excessMagi = magiForIrmaaAndNIIT - threshold;
                        const reduction = excessMagi * OBBBA_AUTO_LOAN_INTEREST_DEDUCTION_PHASEOUT_RATE; // 20% phaseout rate ($200 per $1,000)
                        potentialDeduction -= reduction;
                    }
                    autoLoanDeduction = Math.max(0, potentialDeduction);
                }

                const totalBelowTheLineOBBBADeductions = obbbaSeniorDeduction + tipsDeduction + overtimeDeduction + autoLoanDeduction;

                const totalDeductionsBeforeQBI = standardOrItemizedDeduction + totalBelowTheLineOBBBADeductions;
                const taxableIncomeBeforeQBI = Math.max(0, finalCalculatedAGI - totalDeductionsBeforeQBI);

                // QBI Deduction (Simplified)
                let qbiDeduction = 0;
                const qbiThresholds = QBI_THRESHOLDS[filingStatus];
                // QBI includes SE income, K1 income, and potentially rental income if it qualifies as a trade or business.
                const totalQBIIncome = selfEmploymentIncome + Math.max(0, k1Income); // Simplified QBI calculation source

                if (totalQBIIncome > 0) {
                    const taxableIncomeLimit = (taxableIncomeBeforeQBI - netCapitalGains) * 0.20;
                    let potentialQBIDeduction = totalQBIIncome * 0.20;

                    // Apply limitations if income is above the threshold
                    if (taxableIncomeBeforeQBI > qbiThresholds.min) {
                        const w2Limit = qbiW2Wages * 0.50;
                        const w2AndCapitalLimit = (qbiW2Wages * 0.25) + (qbiUBIA * 0.025);
                        const wageCapitalLimitation = Math.max(w2Limit, w2AndCapitalLimit);

                        if (isSSTB) {
                            // SSTB Rules
                            if (taxableIncomeBeforeQBI >= qbiThresholds.max) {
                                potentialQBIDeduction = 0; // Fully phased out
                            } else {
                                // Phase-out the deduction and the W2/UBIA limitation
                                const phaseoutRange = qbiThresholds.max - qbiThresholds.min;
                                const phaseoutPercent = (taxableIncomeBeforeQBI - qbiThresholds.min) / phaseoutRange;
                                const applicablePercentage = 1 - phaseoutPercent;

                                potentialQBIDeduction *= applicablePercentage;
                                const reducedWageLimit = wageCapitalLimitation * applicablePercentage;
                                potentialQBIDeduction = Math.min(potentialQBIDeduction, reducedWageLimit);
                            }
                        } else {
                            // Non-SSTB Rules
                            if (taxableIncomeBeforeQBI >= qbiThresholds.max) {
                                // Fully subject to limitation
                                potentialQBIDeduction = Math.min(potentialQBIDeduction, wageCapitalLimitation);
                            } else {
                                // Phase-in the limitation
                                const phaseinRange = qbiThresholds.max - qbiThresholds.min;
                                const phaseinPercent = (taxableIncomeBeforeQBI - qbiThresholds.min) / phaseinRange;
                                const limitationDifference = Math.max(0, potentialQBIDeduction - wageCapitalLimitation);
                                const reduction = limitationDifference * phaseinPercent;
                                potentialQBIDeduction -= reduction;
                            }
                        }
                    }
                    qbiDeduction = Math.min(taxableIncomeLimit, potentialQBIDeduction);
                }

                const totalDeductions = totalDeductionsBeforeQBI + qbiDeduction;
                const taxableIncome = Math.max(0, taxableIncomeBeforeQBI - qbiDeduction);

                // --- 4. Calculate Tax Liability ---
                const preferentialIncome = longTermCapitalGains + qualifiedDividends;
                const ordinaryTaxableIncome = Math.max(0, taxableIncome - preferentialIncome);

                // Federal Ordinary Income Tax
                let federalOrdinaryTax = 0;
                const ordinaryBrackets = FEDERAL_TAX_BRACKETS[filingStatus];
                let incomeToTax = ordinaryTaxableIncome;
                let previousBracketMax = 0;

                for (const bracket of ordinaryBrackets) {
                    if (incomeToTax <= 0) break;
                    const taxableInBracket = Math.min(incomeToTax, (bracket.max === Infinity ? Infinity : bracket.max) - previousBracketMax);
                    federalOrdinaryTax += taxableInBracket * bracket.rate;
                    incomeToTax -= taxableInBracket;
                    previousBracketMax = bracket.max;
                }

                // Long-Term Capital Gains Tax
                let estimatedLTCGTax = 0;
                let highestLTCGRateApplied = 0;
                if (preferentialIncome > 0) {
                    const ltcgBrackets = LTCG_BRACKETS[filingStatus];
                    let remainingLTCG = preferentialIncome;
                    let cumulativeIncome = ordinaryTaxableIncome;
                    for (const bracket of ltcgBrackets) {
                        if (remainingLTCG <= 0) break;
                        const spaceInBracket = Math.max(0, (bracket.max === Infinity ? Infinity : bracket.max) - cumulativeIncome);
                        if (spaceInBracket > 0) {
                            const ltcgInBracket = Math.min(remainingLTCG, spaceInBracket);
                            estimatedLTCGTax += ltcgInBracket * bracket.rate;
                            highestLTCGRateApplied = Math.max(highestLTCGRateApplied, bracket.rate * 100);
                            remainingLTCG -= ltcgInBracket;
                            cumulativeIncome += ltcgInBracket;
                        }
                    }
                }

                // Child Tax Credit
                let childTaxCredit = 0, maxPossibleChildTaxCredit = 0;
                if (numChildren > 0) {
                    maxPossibleChildTaxCredit = numChildren * CHILD_TAX_CREDIT_AMOUNT;
                    const ctcPhaseoutThreshold = filingStatus === 'mfj' ? CHILD_TAX_CREDIT_PHASEOUT_MFJ : CHILD_TAX_CREDIT_PHASEOUT_OTHER;
                    if (finalCalculatedAGI > ctcPhaseoutThreshold) {
                        const excessAGI = finalCalculatedAGI - ctcPhaseoutThreshold;
                        const reduction = Math.ceil(excessAGI / 1000) * CHILD_TAX_CREDIT_PHASEOUT_RATE_PER_1000;
                        childTaxCredit = Math.max(0, maxPossibleChildTaxCredit - reduction);
                    } else { childTaxCredit = maxPossibleChildTaxCredit; }
                }
                const disallowedChildTaxCredit = maxPossibleChildTaxCredit - childTaxCredit;

                const federalIncomeTaxBeforeCredits = federalOrdinaryTax + estimatedLTCGTax;
                const netFederalIncomeTax = Math.max(0, federalIncomeTaxBeforeCredits - childTaxCredit);

                // Alternative Minimum Tax (AMT) Enhanced
                let amti = finalCalculatedAGI + amtISOExercise + amtPABInterest;
                // Standard deduction is NOT allowed for AMT
                if (usingStandardDeduction) {
                    // Logic: AMTI typically starts from AGI. Standard deduction wasn't subtracted from AGI, so we don't need to add it back.
                    // However, we do not subtract it later. 
                } else {
                    // If itemized, taxes (SALT) are not deductible for AMT, so we add them back to AGI.
                    amti = amti + allowableSalt;
                }

                let amtExemptionAllowed = AMT_EXEMPTION[filingStatus];
                const amtPhaseout = AMT_EXEMPTION_PHASEOUT_THRESHOLD[filingStatus];
                if (amti > amtPhaseout) {
                    const reduction = (amti - amtPhaseout) * AMT_EXEMPTION_PHASEOUT_RATE;
                    amtExemptionAllowed = Math.max(0, amtExemptionAllowed - reduction);
                }

                const taxableAmti = Math.max(0, amti - amtExemptionAllowed);
                let tmt = 0;
                const amtBreakpoint = filingStatus === 'mfs' ? AMT_RATES[0].max / 2 : AMT_RATES[0].max;

                if (taxableAmti <= amtBreakpoint) {
                    tmt = taxableAmti * AMT_RATES[0].rate;
                } else {
                    tmt = (amtBreakpoint * AMT_RATES[0].rate) + ((taxableAmti - amtBreakpoint) * AMT_RATES[1].rate);
                }

                const amtLiability = Math.max(0, tmt - netFederalIncomeTax);

                const amtDetails = {
                    amti: amti,
                    exemption: amtExemptionAllowed,
                    tentativeMinimumTax: tmt,
                    amtLiability: amtLiability
                };
                // Net Investment Income Tax (NIIT)
                let niitLiability = 0;
                if (magiForIrmaaAndNIIT > NIIT_THRESHOLDS[filingStatus]) {
                    const taxableBase = Math.min(netInvestmentIncome, magiForIrmaaAndNIIT - NIIT_THRESHOLDS[filingStatus]);
                    niitLiability = taxableBase * NIIT_RATE;
                }

                const totalFederalTaxLiability = netFederalIncomeTax + amtLiability + niitLiability;

                // State Income Tax
                const stateIncomeTax = calculateStateTax(scenarioData, finalCalculatedAGI, totalFederalTaxLiability, taxableSocialSecurity, totalItemizedDeductions, calculatedStandardDeduction, qbiDeduction, totalBelowTheLineOBBBADeductions);

                const totalEstimatedTax = totalFederalTaxLiability + totalFicaTax + stateIncomeTax + localIncomeTaxPaid;

                // --- 5. Final Summary & Insights ---
                const totalGrossIncome = totalGrossReceipts + socialSecurityIncome;
                const effectiveFederalTaxRate = finalCalculatedAGI > 0 ? (totalFederalTaxLiability / finalCalculatedAGI) * 100 : 0;
                const effectiveOverallTaxRate = totalGrossIncome > 0 ? (totalEstimatedTax / totalGrossIncome) * 100 : 0;
                const totalTaxWithheld = federalTaxWithheldW2 + ficaTaxWithheldW2 + federalTaxWithheld1099R + federalTaxWithheldEstimates + stateTaxWithheldW2 + stateTaxWithheld1099R + stateTaxWithheldEstimates + localIncomeTaxPaid;
                const remainingTaxOrRefund = totalTaxWithheld - totalEstimatedTax;

                // UPDATED: Include new contribution types in totals, using the actual (capped) values
                const totalEmployerRetirement = p1_401k.actualEmployer + p2_401k.actualEmployer;

                const totalContributions = p1_401k.actualTrad + p2_401k.actualTrad + p1_401k.actualRoth + p2_401k.actualRoth + p1_401k.actualAfterTax + p2_401k.actualAfterTax + traditionalIRA_P1 + traditionalIRA_P2 + hsaContributions + rothIRA_P1 + rothIRA_P2 + taxableBrokerageContributions + savings529 + sepSolo401kContributions + actualSimpleIraContributions;

                // Take-home pay excludes employer match as it's not part of the employee's gross income disbursement.
                const takeHomePay = totalGrossIncome - totalEstimatedTax - totalContributions;

                const totalTraditionalRetirement = p1_401k.actualTrad + p2_401k.actualTrad + deductibleIRA + sepSolo401kContributions + actualSimpleIraContributions;
                const totalRothAfterTaxSavings = p1_401k.actualRoth + p2_401k.actualRoth + p1_401k.actualAfterTax + p2_401k.actualAfterTax + rothIRA_P1 + rothIRA_P2;

                // Roth IRA Contribution Limit Calculation
                let maxAllowedRothContribution = 0;
                let rothIRAWarning = '';
                let isRothIraDisabled = false;

                const userIraLimit = CONTRIBUTION_LIMITS.ira_regular + (age >= 50 ? CONTRIBUTION_LIMITS.ira_catchup : 0);
                const spouseIraLimit = filingStatus === 'mfj' ? (CONTRIBUTION_LIMITS.ira_regular + (spouseAge >= 50 ? CONTRIBUTION_LIMITS.ira_catchup : 0)) : 0;
                const totalStatutoryIraLimit = userIraLimit + spouseIraLimit;

                let phaseout = ROTH_IRA_PHASEOUT_SINGLE_HOH;
                if (filingStatus === 'mfj') phaseout = ROTH_IRA_PHASEOUT_MFJ;
                else if (filingStatus === 'mfs') phaseout = ROTH_IRA_PHASEOUT_MFS;

                if (provisionalAgiForDeductions >= phaseout.max) {
                    maxAllowedRothContribution = 0;
                    rothIRAWarning = 'MAGI is above the limit for Roth IRA contributions.';
                    isRothIraDisabled = true;
                } else if (provisionalAgiForDeductions > phaseout.min) {
                    const range = phaseout.max - phaseout.min;
                    const reductionRatio = (provisionalAgiForDeductions - phaseout.min) / range;
                    const phasedOutLimit = totalStatutoryIraLimit * (1 - reductionRatio);
                    maxAllowedRothContribution = Math.max(0, Math.floor((phasedOutLimit - (traditionalIRA_P1 + traditionalIRA_P2)) / 10) * 10);
                    rothIRAWarning = 'You are in the Roth IRA contribution phase-out range.';
                } else {
                    maxAllowedRothContribution = Math.max(0, totalStatutoryIraLimit - (traditionalIRA_P1 + traditionalIRA_P2));
                }
                if (isRothIraDisabled) maxAllowedRothContribution = 0;

                // IRMAA Calculation
                let irmaaMonthlySurcharge = 0, irmaaBracket = 'N/A', roomUntilNextIrmaaBracket = 0, irmaaTotalPremium = 0;
                if (age >= 65) {
                    const irmaaTiers = IRMAA_THRESHOLDS[filingStatus];
                    irmaaTotalPremium = STANDARD_PREMIUM;
                    for (const tier of irmaaTiers) {
                        if (magiForIrmaaAndNIIT <= tier.magiMax) {
                            irmaaMonthlySurcharge = tier.surcharge;
                            irmaaTotalPremium = tier.totalPremium;
                            irmaaBracket = tier.bracket;
                            roomUntilNextIrmaaBracket = tier.magiMax === Infinity ? Infinity : tier.magiMax - magiForIrmaaAndNIIT + 1;
                            break;
                        }
                    }
                }

                // Marginal Rate Insights
                let currentMarginalRate = 0, currentBracketRange = "$0 - $0", roomUntilNextBracket = 0;
                let currentBracket = {};
                previousBracketMax = 0;
                for (const bracket of ordinaryBrackets) {
                    if (ordinaryTaxableIncome >= bracket.min && (ordinaryTaxableIncome <= bracket.max || bracket.max === Infinity)) {
                        currentBracket = bracket;
                        currentMarginalRate = bracket.rate * 100;
                        currentBracketRange = `$${bracket.min.toLocaleString()} - $${bracket.max === Infinity ? 'Infinity' : bracket.max.toLocaleString()}`;
                        roomUntilNextBracket = (bracket.max === Infinity) ? Infinity : bracket.max - ordinaryTaxableIncome + 1;
                        break;
                    }
                }

                // LTCG Marginal Rate Insights
                let currentLTCGRate = 0, currentLTCGBracketRange = "$0 - $0", roomUntilNextLTCGBracket = 0;
                const hasLTCG = netCapitalGains > 0;
                if (hasLTCG) {
                    const ltcgBracketsForInsight = LTCG_BRACKETS[filingStatus];
                    if (ltcgBracketsForInsight) {
                        for (const bracket of ltcgBracketsForInsight) {
                            if (taxableIncome >= bracket.min && (taxableIncome <= bracket.max || bracket.max === Infinity)) {
                                currentLTCGRate = bracket.rate * 100;
                                currentLTCGBracketRange = `$${bracket.min.toLocaleString()} - $${bracket.max === Infinity ? 'Infinity' : bracket.max.toLocaleString()}`;
                                roomUntilNextLTCGBracket = (bracket.max === Infinity) ? Infinity : bracket.max - taxableIncome + 1;
                                break;
                            }
                        }
                    }
                }

                // HSA Medicare warning - computed within the calculation for return
                const hsaMedicareIssue = (age >= MEDICARE_ENROLLMENT_AGE && hsaContributions > 0);

                return {
                    calculatedAGI: finalCalculatedAGI, magiForIrmaa: magiForIrmaaAndNIIT, roomUntilNextIrmaaBracket,
                    calculatedStandardDeduction, totalDeductions, totalItemizedDeductions, usingStandardDeduction,
                    standardOrItemizedDeduction, taxableIncome, taxableIncomeBeforeQBI, hasLTCG,
                    federalIncomeTax: federalIncomeTaxBeforeCredits, netFederalIncomeTax, federalOrdinaryTax, totalFicaTax, childTaxCredit,
                    disallowedChildTaxCredit,
                    stateIncomeTax, localIncomeTax: localIncomeTaxPaid, totalEstimatedTax, totalContributions, takeHomePay,
                    effectiveFederalTaxRate, effectiveOverallTaxRate, disallowedIRADeduction,
                    taxableSocialSecurity, percentageSSBenefitsTaxed, estimatedLTCGTax, highestLTCGRateApplied,
                    irmaaMonthlySurcharge, irmaaBracket, irmaaTotalPremium, socialSecurityBenefitReduction,
                    totalBelowTheLineOBBBADeductions,
                    currentMarginalRate, currentBracketRange, roomUntilNextBracket,
                    currentLTCGRate, currentLTCGBracketRange, roomUntilNextLTCGBracket,
                    totalTaxWithheld, remainingTaxOrRefund, rothIRAWarning, isRothIraDisabled, maxAllowedRothContribution,
                    amtLiability, niitLiability, qbiDeduction, deductibleStudentLoanInterest, disallowedStudentLoanInterest,
                    totalTraditionalRetirement,
                    totalRothAfterTaxSavings,
                    // NEW: Added Employer Contributions to output
                    totalEmployerRetirement,
                    total529Savings: savings529, totalHsaSavings: hsaContributions, totalTaxableBrokerageSavings: taxableBrokerageContributions,
                    totalFederalTaxLiability, additionalMedicareTax,
                    originalSaltTaxes: saltTaxes,
                    allowableSaltDeduction: allowableSalt,
                    saltLimit,
                    // UPDATED: Variable name change
                    maxSepSolo401kContribution,
                    // NEW: Added 415c details to output
                    p1_415c_limited: p1_401k.reducedBy415c,
                    p2_415c_limited: p2_401k.reducedBy415c,
                    limit415cP1: p1_401k.limit415c,
                    limit415cP2: p2_401k.limit415c,
                    actualAfterTax401k: p1_401k.actualAfterTax,
                    actualSpouseAfterTax401k: p2_401k.actualAfterTax,
                    currentBracket,
                    ordinaryBrackets,
                    filingStatus,
                    amtDetails,
                    // NEW: HSA Medicare warning
                    hsaMedicareIssue,
                };
            };

            const calculateStateTax = (scenario, federalAGI, federalTaxLiability, taxableSocialSecurity, totalItemized, calculatedStandard, qbiDeduction, obbbaDeductions) => {
                // NOTE: State tax calculation logic remains unchanged from the original file, but updated to use split W2 if needed (though current states don't require it).
                const state = STATE_TAX_DATA[scenario.selectedState];
                if (!state || state.type === 'none') return 0;

                if (state.type === 'capitalGainsOnly' && state.name === 'Washington') {
                    const gains = scenario.longTermCapitalGains;
                    const threshold = state.capitalGains.threshold;
                    const taxableGains = Math.max(0, gains - threshold);
                    return taxableGains * state.capitalGains.rate;
                }
                let stateTaxableIncome;
                if (state.taxableIncomeBasis === 'federalTaxableIncome') {
                    const federalTaxableIncome = Math.max(0, federalAGI - Math.max(totalItemized, calculatedStandard) - qbiDeduction - obbbaDeductions);
                    stateTaxableIncome = federalTaxableIncome;
                } else {
                    stateTaxableIncome = federalAGI;
                }
                if (state.socialSecurityExempt) {
                    stateTaxableIncome -= taxableSocialSecurity;
                }
                let retirementDeduction = 0;
                const age = CURRENT_TAX_YEAR - scenario.birthYearOfOldestFiler;
                if (state.retirement?.exempt) {
                    if (!state.retirement.age || age >= state.retirement.age) {
                        if (state.name !== 'Hawaii') {
                            retirementDeduction = scenario.form1099RIncome + scenario.rothConversion;
                        }
                    }
                } else if (state.retirement?.partial) {
                    if (!state.retirement.partial.age || age >= state.retirement.partial.age) {
                        let potentialDeduction = 0;
                        if (typeof state.retirement.partial.amount === 'number') {
                            potentialDeduction = state.retirement.partial.amount;
                        }
                        if (state.name === 'Colorado') {
                            if (age >= 65) potentialDeduction = 24000;
                            else if (age >= 55) potentialDeduction = 20000;
                        }
                        retirementDeduction = Math.min(scenario.form1099RIncome + scenario.rothConversion, potentialDeduction);
                    }
                }
                stateTaxableIncome -= retirementDeduction;
                if (state.capitalGains?.deductionRate) {
                    stateTaxableIncome -= scenario.longTermCapitalGains * state.capitalGains.deductionRate;
                }
                if (state.deductions?.federalTaxDeductible) {
                    let deductibleFederalTax = federalTaxLiability;
                    if (state.deductions.federalTaxDeductibleCap) {
                        const cap = state.deductions.federalTaxDeductibleCap[scenario.filingStatus] || state.deductions.federalTaxDeductibleCap.single;
                        deductibleFederalTax = Math.min(deductibleFederalTax, cap);
                    }
                    stateTaxableIncome -= deductibleFederalTax;
                }
                if (state.taxableIncomeBasis !== 'federalTaxableIncome') {
                    let stateDeduction = 0;
                    if (state.deductions?.federalConformity) {
                        stateDeduction = Math.max(totalItemized, calculatedStandard);
                    } else if (state.deductions?.standard) {
                        stateDeduction = state.deductions.standard[scenario.filingStatus] || state.deductions.standard.single || 0;
                        if (state.name === 'Maryland') stateDeduction = 2800;
                    }
                    stateTaxableIncome -= stateDeduction;
                    if (state.exemptions?.personal) {
                        let exemptionAmount = 0;
                        if (typeof state.exemptions.personal.amount === 'number') {
                            exemptionAmount = state.exemptions.personal.amount;
                        } else if (typeof state.exemptions.personal === 'object') {
                            exemptionAmount = state.exemptions.personal[scenario.filingStatus] || 0;
                        }
                        if (['Illinois', 'Indiana', 'Michigan', 'Virginia', 'New Jersey'].includes(state.name)) {
                            stateTaxableIncome -= exemptionAmount * (scenario.filingStatus === 'mfj' ? 2 : 1);
                        } else {
                            stateTaxableIncome -= exemptionAmount;
                        }
                    }
                    if (state.exemptions?.dependent?.amount && typeof state.exemptions.dependent.amount === 'number') {
                        stateTaxableIncome -= state.exemptions.dependent.amount * scenario.numChildren;
                    }
                }
                stateTaxableIncome = Math.max(0, stateTaxableIncome);
                let tax = 0;
                if (state.name === 'Massachusetts') {
                    const stcg = scenario.shortTermCapitalGains;
                    const ordinaryIncome = Math.max(0, stateTaxableIncome - stcg);
                    tax += ordinaryIncome * state.rate;
                    tax += stcg * state.capitalGains.shortTermRate;
                }
                else if (state.name === 'Hawaii' && state.capitalGains.preferentialRate) {
                    const ltcg = scenario.longTermCapitalGains;
                    const ordinaryIncome = Math.max(0, stateTaxableIncome - ltcg);
                    const brackets = state.brackets[scenario.filingStatus] || state.brackets.all || state.brackets.single;
                    let income = ordinaryIncome;
                    let lastMax = 0;
                    for (const bracket of brackets) {
                        if (income > 0) {
                            const taxableInBracket = Math.min(income, (bracket.max || Infinity) - lastMax);
                            tax += taxableInBracket * bracket.rate;
                            income -= taxableInBracket;
                            lastMax = bracket.max;
                        }
                    }
                    tax += ltcg * state.capitalGains.preferentialRate;
                }
                else if (state.type === 'flat') {
                    tax = stateTaxableIncome * state.rate;
                }
                else if (state.type === 'graduated') {
                    const brackets = state.brackets[scenario.filingStatus] || state.brackets.all || state.brackets.single;
                    if (brackets) {
                        let income = stateTaxableIncome;
                        let lastMax = 0;
                        for (const bracket of brackets) {
                            if (income > 0) {
                                const taxableInBracket = Math.min(income, (bracket.max || Infinity) - lastMax);
                                tax += taxableInBracket * bracket.rate;
                                income -= taxableInBracket;
                                lastMax = bracket.max;
                            }
                        }
                    }
                }
                if (state.surtax) {
                    const baseIncome = state.surtax.appliesTo === 'agi' ? federalAGI : stateTaxableIncome;
                    if (baseIncome > state.surtax.threshold) {
                        if (state.name === 'California') {
                            tax += Math.max(0, stateTaxableIncome - state.surtax.threshold) * state.surtax.rate;
                        } else if (state.name === 'Massachusetts') {
                            tax += (baseIncome - state.surtax.threshold) * state.surtax.rate;
                        }
                    }
                }
                if (state.credits?.personal) { tax -= state.credits.personal * (scenario.filingStatus === 'mfj' ? 2 : 1); }
                if (state.credits?.dependent) { tax -= state.credits.dependent * scenario.numChildren; }

                return Math.max(0, tax);
            };

            const scenario1Calculations = useMemo(() => calculateFinancials(scenario1), [scenario1]);
            const scenario2Calculations = useMemo(() => calculateFinancials(scenario2), [scenario2]);

            const calculations = activeScenario === 'scenario1' ? scenario1Calculations : scenario2Calculations;

            // --- Rendering Logic ---
            // --- Rendering Logic (Light Mode / Professional Theme) ---
            return (
                <div className="min-h-screen bg-brand-bg p-4 sm:p-6 lg:p-8 font-sans flex items-center justify-center antialiased">
                    <div className={CARD_STYLE}>

                        {/* --- Header Section --- */}
                        <div className="flex flex-col items-center mb-8 border-b-4 border-brand-gold pb-6">
                            {/* RBC Logo Image */}

                            <h1 className="text-3xl sm:text-4xl font-bold text-center text-brand-navy tracking-wide font-serif">
                                2026 Comprehensive Tax Calculator
                            </h1>
                            <p className="text-center text-brand-muted mt-2 font-light tracking-widest text-sm uppercase">
                                Estimated Tax Planning Tool
                            </p>

                        </div>

                        {/* Client Info Card for Standalone Mode */}
                        <div className="mb-6 p-4 bg-gradient-to-r from-brand-gold/10 to-brand-navy/5 rounded-lg border border-brand-gold/30">
                            <div className="flex flex-wrap items-center justify-center gap-4">
                                <span className="text-xs font-bold text-brand-navy uppercase">Client Type:</span>
                                <label className="flex items-center gap-1 text-sm cursor-pointer">
                                    <input type="radio" name="clientType" value="single" checked={clientType === 'single'} onChange={(e) => setClientType(e.target.value)} className="accent-brand-navy" /> Single
                                </label>
                                <label className="flex items-center gap-1 text-sm cursor-pointer">
                                    <input type="radio" name="clientType" value="joint" checked={clientType === 'joint'} onChange={(e) => setClientType(e.target.value)} className="accent-brand-navy" /> Joint
                                </label>
                                <input type="text" value={localClientName1} onChange={(e) => setLocalClientName1(e.target.value)} placeholder="Client Name" className="p-2 border-2 border-gray-200 rounded-md text-sm w-36" />
                                {clientType === 'joint' && <input type="text" value={localClientName2} onChange={(e) => setLocalClientName2(e.target.value)} placeholder="Spouse Name" className="p-2 border-2 border-gray-200 rounded-md text-sm w-36" />}
                                {getClientDisplayName() && <span className="text-sm font-semibold text-brand-navy">| Prepared for: {getClientDisplayName()}</span>}
                            </div>
                        </div>

                        <MethodologyModal isOpen={showMethodology} onClose={() => setShowMethodology(false)} />
                        <KeyNumbersModal isOpen={showKeyNumbers} onClose={() => setShowKeyNumbers(false)} />
                        <CalculatorModal isOpen={showCalculator} onClose={() => setShowCalculator(false)} />

                        <div className="p-4 bg-gray-50 rounded-lg mb-8 border-t-4 border-brand-gold shadow-md">
                            <div className="flex flex-wrap justify-between items-center mb-3 border-b border-gray-200 pb-2 gap-2">
                                <h2 className="text-xs font-bold text-brand-navy uppercase tracking-widest">Scenario Manager</h2>
                                <div className="flex flex-wrap items-center gap-3">
                                    <button onClick={() => setShowCalculator(true)} className="text-xs bg-brand-navy text-white hover:bg-brand-gold px-3 py-1 rounded font-semibold transition-colors">🧮 Calculator</button>
                                    <button onClick={() => setShowKeyNumbers(true)} className="text-xs text-brand-gold hover:text-brand-navy font-semibold underline">Show 2026 Key Numbers</button>
                                    <button onClick={() => setShowMethodology(true)} className="text-xs text-brand-navy hover:text-brand-gold underline">View Calculation Methodology</button>
                                </div>
                            </div>

                            <div className="flex flex-col xl:flex-row items-center justify-between gap-4">
                                <div className="flex gap-2 w-full xl:w-auto">
                                    <select
                                        className={INPUT_STYLE + " flex-grow"}
                                        onChange={(e) => handleLoadScenario(savedScenarios.find(s => s.name === e.target.value))}
                                    >
                                        <option value="">Load Saved Scenario...</option>
                                        {savedScenarios.map(s => <option key={s.name} value={s.name}>{s.name} [{s.tag || 'No Tag'}]</option>)}
                                    </select>
                                    <button onClick={handleSaveCurrentScenarioWithTag} className={BUTTON_SECONDARY}>Save</button>
                                </div>

                                <div className="flex gap-2 items-center w-full xl:w-auto justify-end">
                                    <label className="cursor-pointer bg-white hover:bg-gray-100 text-gray-700 py-2 px-4 rounded border-2 border-gray-300 text-sm transition-colors">
                                        Import PDF
                                        <input type="file" accept=".pdf" className="hidden" onChange={handleImportPDF} />
                                    </label>
                                    <button onClick={handleExportPDF} className={BUTTON_PRIMARY + " text-sm"}>
                                        Export PDF Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* --- Navigation Tabs --- */}
                        <div className="flex justify-center mb-8 space-x-4 border-b-2 border-gray-200 pb-1">
                            <button className={`pb-2 px-4 text-lg font-medium transition-all duration-300 ${activeScenario === 'scenario1' ? 'text-brand-navy border-b-2 border-brand-gold' : 'text-gray-400 hover:text-gray-600'}`} onClick={() => setActiveScenario('scenario1')}>
                                <input type="text" value={scenario1Name} onChange={(e) => setScenario1Name(e.target.value)} className="bg-transparent text-center focus:outline-none w-32 cursor-pointer font-bold" />
                            </button>
                            <button className={`pb-2 px-4 text-lg font-medium transition-all duration-300 ${activeScenario === 'scenario2' ? 'text-brand-navy border-b-2 border-brand-gold' : 'text-gray-400 hover:text-gray-600'}`} onClick={() => setActiveScenario('scenario2')}>
                                <input type="text" value={scenario2Name} onChange={(e) => setScenario2Name(e.target.value)} className="bg-transparent text-center focus:outline-none w-32 cursor-pointer font-bold" />
                            </button>
                            <button className={`pb-2 px-4 text-lg font-medium transition-all duration-300 ${activeScenario === 'comparison' ? 'text-brand-navy border-b-2 border-brand-gold' : 'text-gray-400 hover:text-gray-600'}`} onClick={() => setActiveScenario('comparison')}> Comparison </button>
                        </div>

                        {activeScenario === 'scenario2' && (<div className="flex justify-center mb-6"> <button onClick={cloneScenario1To2} className={BUTTON_PRIMARY}> Clone Scenario 1 to Scenario 2 </button> </div>)}

                        {activeScenario !== 'comparison' ? (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 mt-4">

                                    {/* --- Income & Status Panel --- */}
                                    <div className={SECTION_STYLE}>
                                        <h2 className={HEADER_STYLE}>Income & Status</h2>
                                        <div className="space-y-4">
                                            {filingStatus === 'mfj' ? (
                                                <>
                                                    <div> <label className={LABEL_STYLE}> {effectiveClientNames.client1}'s W2 Income ($) </label> <MathInput className={INPUT_STYLE} value={w2IncomeP1} onChange={(e) => handleInputChange('w2IncomeP1', Number(e.target.value))} min={0} /> </div>
                                                    <div> <label className={LABEL_STYLE}> {effectiveClientNames.client2}'s W2 Income ($) </label> <MathInput className={INPUT_STYLE} value={w2IncomeP2} onChange={(e) => handleInputChange('w2IncomeP2', Number(e.target.value))} min={0} /> </div>
                                                </>
                                            ) : (
                                                <div> <label className={LABEL_STYLE}> W2 Income ($) </label> <MathInput className={INPUT_STYLE} value={w2IncomeP1} onChange={(e) => handleInputChange('w2IncomeP1', Number(e.target.value))} min={0} /> </div>
                                            )}

                                            {filingStatus === 'mfj' ? (
                                                <>
                                                    <div> <label className={LABEL_STYLE}> {effectiveClientNames.client1}'s Self-Employment Income (Net) ($) </label> <MathInput className={INPUT_STYLE} value={selfEmploymentIncome} onChange={(e) => handleInputChange('selfEmploymentIncome', Number(e.target.value))} /> </div>
                                                    <div> <label className={LABEL_STYLE}> {effectiveClientNames.client2}'s Self-Employment Income (Net) ($) </label> <MathInput className={INPUT_STYLE} value={selfEmploymentIncomeP2} onChange={(e) => handleInputChange('selfEmploymentIncomeP2', Number(e.target.value))} /> </div>
                                                </>
                                            ) : (
                                                <div> <label className={LABEL_STYLE}> Self-Employment Income (Net) ($) </label> <MathInput className={INPUT_STYLE} value={selfEmploymentIncome} onChange={(e) => handleInputChange('selfEmploymentIncome', Number(e.target.value))} /> </div>
                                            )}
                                            <div> <label className={LABEL_STYLE}> Rental Real Estate Income ($) </label> <MathInput className={INPUT_STYLE} value={rentalIncome} onChange={(e) => handleInputChange('rentalIncome', Number(e.target.value))} /> </div>
                                            <div> <label className={LABEL_STYLE}> K-1 Income (Loss) ($) </label> <MathInput className={INPUT_STYLE} value={k1Income} onChange={(e) => handleInputChange('k1Income', Number(e.target.value))} /> </div>
                                            <div> <label className={LABEL_STYLE}> Social Security Benefits ($) </label> <MathInput className={INPUT_STYLE} value={socialSecurityIncome} onChange={(e) => handleInputChange('socialSecurityIncome', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}> 1099-R Income ($) </label> <MathInput className={INPUT_STYLE} value={form1099RIncome} onChange={(e) => handleInputChange('form1099RIncome', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}> Roth Conversion Amount ($) </label> <MathInput className={INPUT_STYLE} value={rothConversion} onChange={(e) => handleInputChange('rothConversion', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}> Taxable Interest ($) </label> <MathInput className={INPUT_STYLE} value={taxableInterest} onChange={(e) => handleInputChange('taxableInterest', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}> Qualified Dividends ($) </label> <MathInput className={INPUT_STYLE} value={qualifiedDividends} onChange={(e) => handleInputChange('qualifiedDividends', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}> Short-Term Capital Gains ($) </label> <MathInput className={INPUT_STYLE} value={shortTermCapitalGains} onChange={(e) => handleInputChange('shortTermCapitalGains', Number(e.target.value))} /> </div>
                                            <div> <label className={LABEL_STYLE}> Long-Term Capital Gains ($) </label> <MathInput className={INPUT_STYLE} value={longTermCapitalGains} onChange={(e) => handleInputChange('longTermCapitalGains', Number(e.target.value))} /> </div>

                                            <hr className="border-gray-200" />

                                            <div> <label className={LABEL_STYLE}> Filing Status </label> <select className={INPUT_STYLE} value={filingStatus} onChange={(e) => handleInputChange('filingStatus', e.target.value)}> <option value="single">Single</option> <option value="mfj">Married Filing Jointly</option> <option value="mfs">Married Filing Separately</option> <option value="hoh">Head of Household</option> </select> </div>
                                            <div> <label className={LABEL_STYLE}> State </label> <select className={INPUT_STYLE} value={selectedState} onChange={(e) => handleInputChange('selectedState', e.target.value)}> <option value="">Select your state...</option> {Object.entries(STATE_TAX_DATA).map(([abbr, data]) => (<option key={abbr} value={abbr}>{data.name}</option>))} </select> </div>
                                            <div> <label className={LABEL_STYLE}> {effectiveClientNames.client1}'s Birth Year </label> <input type="text" inputMode="numeric" pattern="[0-9]*" className={INPUT_STYLE} defaultValue={birthYearOfOldestFiler} onBlur={(e) => { const val = parseInt(e.target.value) || 1960; const clamped = Math.min(MAX_BIRTH_YEAR, Math.max(MIN_BIRTH_YEAR, val)); handleInputChange('birthYearOfOldestFiler', clamped); e.target.value = clamped; }} placeholder="e.g., 1960" /> </div>
                                            {filingStatus === 'mfj' && (<div> <label className={LABEL_STYLE}>{effectiveClientNames.client2}'s Birth Year</label> <input type="text" inputMode="numeric" pattern="[0-9]*" className={INPUT_STYLE} defaultValue={spouseBirthYear} onBlur={(e) => { const val = parseInt(e.target.value) || 1960; const clamped = Math.min(MAX_BIRTH_YEAR, Math.max(MIN_BIRTH_YEAR, val)); handleInputChange('spouseBirthYear', clamped); e.target.value = clamped; }} placeholder="e.g., 1962" /> </div>)}
                                            <div> <label className={LABEL_STYLE}> Qualified Dependents (Under 17) </label> <input type="number" className={INPUT_STYLE} value={numChildren} onChange={(e) => handleInputChange('numChildren', Number(e.target.value))} min="0" /> </div>
                                        </div>
                                    </div>

                                    {/* --- Deductions & Contributions Panel --- */}
                                    <div className={SECTION_STYLE}>
                                        <h2 className={HEADER_STYLE}>Deductions & Contributions</h2>
                                        <div className="space-y-4">
                                            <h3 className="text-brand-navy text-sm font-bold uppercase tracking-wider mb-2">401(k) / 403(b)</h3>
                                            <div> <label className={LABEL_STYLE}>Traditional (Pre-Tax) ($)</label>
                                                <MathInput className={INPUT_STYLE} value={traditional401k} onChange={(e) => { handleInputChange('traditional401k', Number(e.target.value)); handleInputChange('useMax401k', false); }} min={0} />
                                                <div className="flex items-center mt-1 text-gray-400 text-sm"><input type="checkbox" className="mr-2" checked={useMax401k} onChange={(e) => handleInputChange('useMax401k', e.target.checked)} /> Use Max ({formatter.format(max401kLimit)})</div>
                                            </div>
                                            <div> <label className={LABEL_STYLE}>Roth ($)</label> <MathInput className={INPUT_STYLE} value={roth401k} onChange={(e) => handleInputChange('roth401k', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>Employer Match ($)</label> <MathInput className={INPUT_STYLE} value={employer401k} onChange={(e) => handleInputChange('employer401k', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>After-Tax (Mega Backdoor) ($)</label> <MathInput className={INPUT_STYLE} value={afterTax401k} onChange={(e) => handleInputChange('afterTax401k', Number(e.target.value))} min={0} /> </div>

                                            {filingStatus === 'mfj' && (
                                                <>
                                                    <hr className="border-gray-200" />
                                                    <h3 className="text-brand-navy text-sm font-bold uppercase tracking-wider mb-2">{effectiveClientNames.client2}'s 401(k)</h3>
                                                    <div> <label className={LABEL_STYLE}>Traditional ($)</label> <MathInput className={INPUT_STYLE} value={spouseTraditional401k} onChange={(e) => { handleInputChange('spouseTraditional401k', Number(e.target.value)); handleInputChange('spouseUseMax401k', false); }} /> </div>
                                                    <div> <label className={LABEL_STYLE}>Roth ($)</label> <MathInput className={INPUT_STYLE} value={spouseRoth401k} onChange={(e) => handleInputChange('spouseRoth401k', Number(e.target.value))} /> </div>
                                                    <div> <label className={LABEL_STYLE}>Employer Match ($)</label> <MathInput className={INPUT_STYLE} value={spouseEmployer401k} onChange={(e) => handleInputChange('spouseEmployer401k', Number(e.target.value))} min={0} /> </div>
                                                    <div> <label className={LABEL_STYLE}>After-Tax (Mega Backdoor) ($)</label> <MathInput className={INPUT_STYLE} value={spouseAfterTax401k} onChange={(e) => handleInputChange('spouseAfterTax401k', Number(e.target.value))} min={0} /> </div>
                                                </>
                                            )}

                                            <hr className="border-gray-200" />
                                            <div> <label className={LABEL_STYLE}>SEP IRA / Solo 401k (Employer) ($)</label> <MathInput className={INPUT_STYLE} value={sepSolo401kContributions} onChange={(e) => handleInputChange('sepSolo401kContributions', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>SIMPLE IRA ($)</label> <MathInput className={INPUT_STYLE} value={simpleIraContributions} onChange={(e) => handleInputChange('simpleIraContributions', Number(e.target.value))} min={0} /> </div>

                                            {/* Retirement Plan Coverage Checkboxes */}
                                            <div className="bg-blue-50 p-3 rounded-md mb-2 border border-blue-100">
                                                <h3 className="text-brand-navy text-xs font-bold uppercase tracking-wider mb-2">Retirement Plan Coverage</h3>
                                                <div className="flex flex-col gap-2">
                                                    <label className="flex items-center text-sm text-gray-700">
                                                        <input
                                                            type="checkbox"
                                                            className="mr-2 accent-brand-navy"
                                                            checked={coveredByRetirementPlan}
                                                            onChange={(e) => handleInputChange('coveredByRetirementPlan', e.target.checked)}
                                                        />
                                                        I am covered by a workplace plan (401k, Pension, etc.)
                                                    </label>
                                                    {filingStatus === 'mfj' && (
                                                        <label className="flex items-center text-sm text-gray-700">
                                                            <input
                                                                type="checkbox"
                                                                className="mr-2 accent-brand-navy"
                                                                checked={spouseCoveredByRetirementPlan}
                                                                onChange={(e) => handleInputChange('spouseCoveredByRetirementPlan', e.target.checked)}
                                                            />
                                                            Spouse is covered by a workplace plan
                                                        </label>
                                                    )}
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1 ml-6">
                                                    *Required to calculate IRA deduction limits correctly.
                                                </p>
                                            </div>

                                            {/* UPDATED: Split Traditional IRA Inputs */}
                                            {filingStatus === 'mfj' ? (
                                                <>
                                                    <div> <label className={LABEL_STYLE}>{effectiveClientNames.client1}'s Traditional IRA ($)</label> <MathInput className={INPUT_STYLE} value={traditionalIRA_P1} onChange={(e) => handleInputChange('traditionalIRA_P1', Number(e.target.value))} min={0} /> </div>
                                                    <div> <label className={LABEL_STYLE}>{effectiveClientNames.client2}'s Traditional IRA ($)</label> <MathInput className={INPUT_STYLE} value={traditionalIRA_P2} onChange={(e) => handleInputChange('traditionalIRA_P2', Number(e.target.value))} min={0} /> </div>
                                                </>
                                            ) : (
                                                <div>
                                                    <label className={LABEL_STYLE}>Traditional IRA ($)</label>
                                                    <MathInput className={INPUT_STYLE} value={traditionalIRA_P1} onChange={(e) => { handleInputChange('traditionalIRA_P1', Number(e.target.value)); handleInputChange('useMaxIRA', false); }} min={0} />
                                                    <div className="flex items-center mt-1 text-gray-400 text-sm"><input type="checkbox" className="mr-2" checked={useMaxIRA} onChange={(e) => { handleInputChange('useMaxIRA', e.target.checked); if (e.target.checked) handleInputChange('traditionalIRA_P1', maxIraLimit); }} /> Use Max ({formatter.format(maxIraLimit)})</div>
                                                </div>
                                            )}

                                            <div> <label className={LABEL_STYLE}>HSA Contributions ($)</label> <MathInput className={INPUT_STYLE} value={hsaContributions} onChange={(e) => { handleInputChange('hsaContributions', Number(e.target.value)); handleInputChange('useMaxHSA', false); }} min={0} /> </div>

                                            {/* UPDATED: Split Roth IRA Inputs */}
                                            {filingStatus === 'mfj' ? (
                                                <>
                                                    <div> <label className={LABEL_STYLE}>{effectiveClientNames.client1}'s Roth IRA ($)</label> <MathInput className={INPUT_STYLE} value={rothIRA_P1} onChange={(e) => handleInputChange('rothIRA_P1', Number(e.target.value))} min={0} disabled={calculations.isRothIraDisabled} /> </div>
                                                    <div> <label className={LABEL_STYLE}>{effectiveClientNames.client2}'s Roth IRA ($)</label> <MathInput className={INPUT_STYLE} value={rothIRA_P2} onChange={(e) => handleInputChange('rothIRA_P2', Number(e.target.value))} min={0} disabled={calculations.isRothIraDisabled} /> </div>
                                                </>
                                            ) : (
                                                <div> <label className={LABEL_STYLE}>Roth IRA ($)</label> <MathInput className={INPUT_STYLE} value={rothIRA_P1} onChange={(e) => handleInputChange('rothIRA_P1', Number(e.target.value))} min={0} disabled={calculations.isRothIraDisabled} /> </div>
                                            )}

                                            <div> <label className={LABEL_STYLE}>529 Savings ($)</label> <MathInput className={INPUT_STYLE} value={savings529} onChange={(e) => handleInputChange('savings529', Number(e.target.value))} min={0} /> </div>
                                            {/* UPDATED: Added Taxable Brokerage Input */}
                                            <div> <label className={LABEL_STYLE}>Taxable Brokerage Contributions ($)</label> <MathInput className={INPUT_STYLE} value={taxableBrokerageContributions} onChange={(e) => handleInputChange('taxableBrokerageContributions', Number(e.target.value))} min={0} /> </div>
                                        </div>
                                    </div>

                                    {/* --- Itemized Deductions & Taxes Panel --- */}
                                    <div className={SECTION_STYLE}>
                                        <h2 className={HEADER_STYLE}>Itemized Deductions & Taxes</h2>
                                        <div className="space-y-4">
                                            <div> <label className={LABEL_STYLE}>State & Local Taxes (SALT) ($)</label> <MathInput className={INPUT_STYLE} value={saltTaxes} onChange={(e) => handleInputChange('saltTaxes', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>Mortgage Interest ($)</label> <MathInput className={INPUT_STYLE} value={mortgageInterest} onChange={(e) => handleInputChange('mortgageInterest', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>Charitable Contributions ($)</label> <MathInput className={INPUT_STYLE} value={charitableContributions} onChange={(e) => handleInputChange('charitableContributions', Number(e.target.value))} min={0} /> </div>
                                            <hr className="border-gray-200" />
                                            <h3 className="text-brand-navy text-sm font-bold uppercase tracking-wider mb-2">Taxes Already Paid</h3>
                                            <div> <label className={LABEL_STYLE}>Fed Withheld (W-2) ($)</label> <MathInput className={INPUT_STYLE} value={federalTaxWithheldW2} onChange={(e) => handleInputChange('federalTaxWithheldW2', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>State Withheld (W-2) ($)</label> <MathInput className={INPUT_STYLE} value={stateTaxWithheldW2} onChange={(e) => handleInputChange('stateTaxWithheldW2', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>FICA Withheld (W-2) ($)</label> <MathInput className={INPUT_STYLE} value={ficaTaxWithheldW2} onChange={(e) => handleInputChange('ficaTaxWithheldW2', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>Federal Estimated Payments ($)</label> <MathInput className={INPUT_STYLE} value={federalTaxWithheldEstimates} onChange={(e) => handleInputChange('federalTaxWithheldEstimates', Number(e.target.value))} min={0} /> </div>
                                            <div> <label className={LABEL_STYLE}>State Estimated Payments ($)</label> <MathInput className={INPUT_STYLE} value={stateTaxWithheldEstimates} onChange={(e) => handleInputChange('stateTaxWithheldEstimates', Number(e.target.value))} min={0} /> </div>
                                        </div>
                                    </div>

                                    {/* --- OBBBA / QBI Panel (Condensed) --- */}
                                    <div className={SECTION_STYLE + " lg:col-span-3"}>
                                        <h2 className={HEADER_STYLE}>Advanced (QBI, OBBBA, AMT)</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div className="space-y-4">
                                                <h3 className="text-gray-400 text-sm uppercase">QBI Details</h3>
                                                <div> <label className={LABEL_STYLE}>Total W-2 Wages (Business)</label> <MathInput className={INPUT_STYLE} value={qbiW2Wages} onChange={(e) => handleInputChange('qbiW2Wages', Number(e.target.value))} /> </div>
                                                <div> <label className={LABEL_STYLE}>UBIA of Property</label> <MathInput className={INPUT_STYLE} value={qbiUBIA} onChange={(e) => handleInputChange('qbiUBIA', Number(e.target.value))} /> </div>
                                                <div className="flex items-center text-gray-300"> <input type="checkbox" className="mr-2" checked={isSSTB} onChange={(e) => handleInputChange('isSSTB', e.target.checked)} /> Is SSTB? </div>
                                            </div>
                                            <div className="space-y-4">
                                                <h3 className="text-gray-400 text-sm uppercase">OBBBA Deductions</h3>
                                                <div> <label className={LABEL_STYLE}>Qualified Tips</label> <MathInput className={INPUT_STYLE} value={qualifiedTipsIncome} onChange={(e) => handleInputChange('qualifiedTipsIncome', Number(e.target.value))} /> </div>
                                                <div> <label className={LABEL_STYLE}>Qualified Overtime</label> <MathInput className={INPUT_STYLE} value={qualifiedOvertimeIncome} onChange={(e) => handleInputChange('qualifiedOvertimeIncome', Number(e.target.value))} /> </div>
                                            </div>
                                            <div className="space-y-4">
                                                <h3 className="text-gray-400 text-sm uppercase">Scenario Notes</h3>
                                                <textarea className={INPUT_STYLE + " h-24"} value={notes} onChange={(e) => handleInputChange('notes', e.target.value)} placeholder="Add notes here..." />
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <InputValidation data={currentScenarioData} calculations={calculations} />
                                <StateTaxSummary selectedState={selectedState} />
                                <SummaryComponent calculations={activeScenario === 'scenario1' ? scenario1Calculations : scenario2Calculations} title={`${currentScenarioName} - Estimated Financial Summary`} formatter={formatter} percentFormatter={percentFormatter} />
                            </>
                        ) : (
                            <ComparisonComponent
                                scenario1={scenario1Calculations}
                                scenario2={scenario2Calculations}
                                s1Name={scenario1Name}
                                s2Name={scenario2Name}
                                formatter={formatter}
                                percentFormatter={percentFormatter}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Initialize GlobalStateManager and load profile data
        function loadProfileToState() {
            if (typeof GlobalStateManager === 'undefined') return null;
            GlobalStateManager.init();
            return GlobalStateManager.getState();
        }

        // Make profile state available globally for React component
        window.initialProfileState = loadProfileToState();

        // Subscribe to profile updates to trigger re-render
        if (typeof GlobalStateManager !== 'undefined') {
            GlobalStateManager.subscribe(function (state) {
                window.initialProfileState = state;
                // Dispatch custom event for React to catch
                window.dispatchEvent(new CustomEvent('profileUpdated', { detail: state }));
            });
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>