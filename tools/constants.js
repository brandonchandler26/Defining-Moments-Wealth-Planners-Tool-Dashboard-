/**
 * Financial Planning Dashboard - Centralized Constants
 * All 2026 tax brackets, limits, and financial parameters
 * Source: RBC Wealth Management Key Numbers 2026
 * Updated: January 2026
 */

const FinancialConstants = {
    currentYear: 2026,

    // ===========================================
    // FEDERAL INCOME TAX BRACKETS 2026
    // ===========================================
    federalBrackets: {
        single: [
            { min: 0, max: 12400, rate: 0.10 },
            { min: 12400, max: 50400, rate: 0.12 },
            { min: 50400, max: 105700, rate: 0.22 },
            { min: 105700, max: 201775, rate: 0.24 },
            { min: 201775, max: 256225, rate: 0.32 },
            { min: 256225, max: 640600, rate: 0.35 },
            { min: 640600, max: Infinity, rate: 0.37 }
        ],
        mfj: [
            { min: 0, max: 24800, rate: 0.10 },
            { min: 24800, max: 100800, rate: 0.12 },
            { min: 100800, max: 211400, rate: 0.22 },
            { min: 211400, max: 403550, rate: 0.24 },
            { min: 403550, max: 512450, rate: 0.32 },
            { min: 512450, max: 768700, rate: 0.35 },
            { min: 768700, max: Infinity, rate: 0.37 }
        ],
        mfs: [
            { min: 0, max: 12400, rate: 0.10 },
            { min: 12400, max: 50400, rate: 0.12 },
            { min: 50400, max: 105700, rate: 0.22 },
            { min: 105700, max: 201775, rate: 0.24 },
            { min: 201775, max: 256225, rate: 0.32 },
            { min: 256225, max: 384350, rate: 0.35 },
            { min: 384350, max: Infinity, rate: 0.37 }
        ],
        hoh: [
            { min: 0, max: 17700, rate: 0.10 },
            { min: 17700, max: 67450, rate: 0.12 },
            { min: 67450, max: 105700, rate: 0.22 },
            { min: 105700, max: 201750, rate: 0.24 },
            { min: 201750, max: 256200, rate: 0.32 },
            { min: 256200, max: 640600, rate: 0.35 },
            { min: 640600, max: Infinity, rate: 0.37 }
        ]
    },

    // ===========================================
    // STANDARD DEDUCTIONS 2026
    // ===========================================
    standardDeduction: {
        single: 16100,
        mfj: 32200,
        mfs: 16100,
        hoh: 24150,
        dependent: 1350,
        // Additional for blind or aged (65+)
        additionalSingleHOH: 2050,
        additionalMFJ: 1650,
        // New senior deduction (age 65+)
        seniorDeduction: 6000,  // Reduced by 6% of income over $75K single / $150K MFJ
        seniorPhaseoutSingle: 75000,
        seniorPhaseoutMFJ: 150000
    },

    // ===========================================
    // CAPITAL GAINS TAX BRACKETS 2026
    // ===========================================
    capitalGainsBrackets: {
        single: [
            { min: 0, max: 49450, rate: 0.00 },
            { min: 49450, max: 545500, rate: 0.15 },
            { min: 545500, max: Infinity, rate: 0.20 }
        ],
        mfj: [
            { min: 0, max: 98900, rate: 0.00 },
            { min: 98900, max: 613700, rate: 0.15 },
            { min: 613700, max: Infinity, rate: 0.20 }
        ],
        mfs: [
            { min: 0, max: 49450, rate: 0.00 },
            { min: 49450, max: 306850, rate: 0.15 },
            { min: 306850, max: Infinity, rate: 0.20 }
        ],
        hoh: [
            { min: 0, max: 66200, rate: 0.00 },
            { min: 66200, max: 579600, rate: 0.15 },
            { min: 579600, max: Infinity, rate: 0.20 }
        ]
    },

    // ===========================================
    // FICA / PAYROLL TAXES 2026
    // ===========================================
    fica: {
        socialSecurityRate: 0.062,
        socialSecurityWageBase: 184500,  // Updated per RBC 2026
        medicareRate: 0.0145,
        medicareAdditionalRate: 0.009,
        medicareAdditionalThreshold: { single: 200000, mfj: 250000, mfs: 125000 }
    },

    // ===========================================
    // RETIREMENT CONTRIBUTION LIMITS 2026
    // ===========================================
    retirementLimits: {
        // 401(k), 403(b), 457(b), SAR-SEPs
        elective401k: 24500,
        catchUp401k: 8000,           // Age 50+
        catchUp401kSuper: 11250,     // Ages 60-63 (SECURE 2.0)

        // SIMPLE 401(k) and SIMPLE IRA
        simple: 17000,
        simpleCatchUp: 4000,         // Age 50+
        simpleCatchUpSuper: 5250,    // Ages 60-63

        // Traditional and Roth IRA (combined)
        iraContribution: 7500,
        iraCatchUp: 1100,            // Age 50+ (Updated to $1,100)

        // IRA deduction phaseouts (covered by employer plan)
        iraDeductionPhaseout: {
            single: { start: 81000, end: 91000 },
            mfj_covered: { start: 129000, end: 149000 },
            mfj_spouse_covered: { start: 242000, end: 252000 },
            mfs: { start: 0, end: 10000 }
        },

        // Roth IRA contribution phaseouts
        rothPhaseout: {
            single: { start: 153000, end: 168000 },
            mfj: { start: 242000, end: 252000 },
            mfs: { start: 0, end: 10000 }
        }
    },

    // ===========================================
    // HEALTH CARE 2026
    // ===========================================
    healthcare: {
        // FSA
        fsaHealthcare: 3400,

        // HSA
        hsaIndividual: 4400,
        hsaFamily: 8750,
        hsaCatchUp: 1000,  // Age 55+

        // HDHP minimums/maximums
        hdhpMinDeductibleIndividual: 1700,
        hdhpMinDeductibleFamily: 3400,
        hdhpMaxOOPIndividual: 8500,
        hdhpMaxOOPFamily: 17000
    },

    // ===========================================
    // SOCIAL SECURITY 2026
    // ===========================================
    socialSecurity: {
        maxTaxableEarnings: 184500,  // Updated per RBC 2026
        taxRate: 0.062,
        fullRetirementAge: 67,
        claimingFactors: {
            62: 0.700, 63: 0.750, 64: 0.800, 65: 0.867,
            66: 0.933, 67: 1.000, 68: 1.080, 69: 1.160, 70: 1.240
        },
        taxationThresholds: {
            single: { lower: 25000, upper: 34000 },
            mfj: { lower: 32000, upper: 44000 }
        }
    },

    // ===========================================
    // ESTATE & GIFT TAX 2026
    // ===========================================
    estateTax: {
        federalExemption: 15000000,      // Updated to $15M per RBC 2026
        gstExemption: 15000000,          // GST exemption (not portable)
        topRate: 0.40,
        annualGiftExclusion: 19000,
        noncitizenSpouseGift: 194000,    // Updated per RBC 2026
        // State estate tax thresholds
        stateThresholds: {
            'CT': 13610000, 'DC': 4528800, 'HI': 5490000,
            'IL': 4000000, 'ME': 6800000, 'MD': 5000000,
            'MA': 2000000, 'MN': 3000000, 'NY': 6940000,
            'OR': 1000000, 'RI': 1774583, 'VT': 5000000, 'WA': 2193000
        }
    },

    // ===========================================
    // AMT PARAMETERS 2026
    // ===========================================
    amt: {
        exemption: {
            single: 90100,
            hoh: 90100,
            mfj: 140200,
            mfs: 70100
        },
        phaseoutThreshold: {
            single: 500000,
            hoh: 500000,
            mfj: 1000000,
            mfs: 500000
        },
        // 26% up to $244,500 ($122,250 MFS), 28% above
        breakpoint: 244500,
        breakpointMFS: 122250
    },

    // ===========================================
    // EDUCATION 2026
    // ===========================================
    education: {
        lifetimeLearningCredit: {
            max: 2000,
            phaseout: {
                single: { start: 80000, end: 90000 },
                mfj: { start: 160000, end: 180000 }
            }
        },
        americanOpportunityCredit: {
            max: 2500,
            phaseout: {
                single: { start: 80000, end: 90000 },
                mfj: { start: 160000, end: 180000 }
            }
        },
        studentLoanInterestDeduction: {
            max: 2500,
            phaseout: {
                single: { start: 85000, end: 100000 },
                mfj: { start: 175000, end: 205000 }
            }
        },
        savingsBondExclusion: {
            phaseout: {
                single: { start: 101800, end: 116800 },
                mfj: { start: 152650, end: 182650 }
            }
        }
    },

    // ===========================================
    // RMD FACTORS - Table III (Uniform Lifetime Table - IRS Pub 590-B)
    // ===========================================
    rmdFactors: {
        72: 27.4, 73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9,
        78: 22.0, 79: 21.1, 80: 20.2, 81: 19.4, 82: 18.5,
        83: 17.7, 84: 16.8, 85: 16.0, 86: 15.2, 87: 14.4,
        88: 13.7, 89: 12.9, 90: 12.2, 91: 11.5, 92: 10.8,
        93: 10.1, 94: 9.5, 95: 8.9, 96: 8.4, 97: 7.8,
        98: 7.3, 99: 6.8, 100: 6.4, 101: 6.0, 102: 5.6,
        103: 5.2, 104: 4.9, 105: 4.6, 106: 4.3, 107: 4.1,
        108: 3.9, 109: 3.7, 110: 3.5, 111: 3.4, 112: 3.3,
        113: 3.1, 114: 3.0, 115: 2.9, 116: 2.8, 117: 2.7,
        118: 2.5, 119: 2.3, 120: 2.0
    },

    // ===========================================
    // RMD FACTORS - Table II (Joint and Last Survivor - IRS Pub 590-B)
    // Used when spouse is sole beneficiary AND more than 10 years younger
    // Keys are "ownerAge-spouseAge" format
    // ===========================================
    rmdJointFactors: {
        // Owner Age 70
        '70-40': 46.1, '70-41': 45.2, '70-42': 44.3, '70-43': 43.3, '70-44': 42.4, '70-45': 41.5, '70-46': 40.6, '70-47': 39.7, '70-48': 38.8,
        '70-49': 38.0, '70-50': 37.1, '70-51': 36.2, '70-52': 35.4, '70-53': 34.6, '70-54': 33.8, '70-55': 33.0, '70-56': 32.2, '70-57': 31.4,
        '70-58': 30.7, '70-59': 29.9, '70-60': 29.2, '70-61': 28.5, '70-62': 27.9, '70-63': 27.2, '70-64': 26.6, '70-65': 26.0, '70-66': 25.4, '70-67': 24.9, '70-68': 24.3, '70-69': 23.9,
        // Owner Age 71
        '71-40': 46.1, '71-41': 45.1, '71-42': 44.2, '71-43': 43.3, '71-44': 42.4, '71-45': 41.5, '71-46': 40.6, '71-47': 39.7, '71-48': 38.8,
        '71-49': 37.9, '71-50': 37.0, '71-51': 36.1, '71-52': 35.3, '71-53': 34.5, '71-54': 33.6, '71-55': 32.8, '71-56': 32.0, '71-57': 31.2,
        '71-58': 30.5, '71-59': 29.7, '71-60': 29.0, '71-61': 28.3, '71-62': 27.6, '71-63': 26.9, '71-64': 26.3, '71-65': 25.7, '71-66': 25.1, '71-67': 24.5, '71-68': 24.0, '71-69': 23.4,
        // Owner Age 72
        '72-40': 46.0, '72-41': 45.1, '72-42': 44.2, '72-43': 43.2, '72-44': 42.3, '72-45': 41.4, '72-46': 40.5, '72-47': 39.6, '72-48': 38.7,
        '72-49': 37.8, '72-50': 36.9, '72-51': 36.0, '72-52': 35.2, '72-53': 34.3, '72-54': 33.5, '72-55': 32.7, '72-56': 31.9, '72-57': 31.1,
        '72-58': 30.3, '72-59': 29.5, '72-60': 28.8, '72-61': 28.1, '72-62': 27.4,
        // Owner Age 73
        '73-40': 46.0, '73-41': 45.1, '73-42': 44.1, '73-43': 43.2, '73-44': 42.3, '73-45': 41.4, '73-46': 40.4, '73-47': 39.5, '73-48': 38.6,
        '73-49': 37.7, '73-50': 36.8, '73-51': 36.0, '73-52': 35.1, '73-53': 34.2, '73-54': 33.4, '73-55': 32.6, '73-56': 31.7, '73-57': 30.9,
        '73-58': 30.1, '73-59': 29.4, '73-60': 28.6, '73-61': 27.9, '73-62': 27.2, '73-63': 26.5,
        // Owner Age 74
        '74-40': 46.0, '74-41': 45.0, '74-42': 44.1, '74-43': 43.2, '74-44': 42.2, '74-45': 41.3, '74-46': 40.4, '74-47': 39.5, '74-48': 38.6,
        '74-49': 37.7, '74-50': 36.8, '74-51': 35.9, '74-52': 35.0, '74-53': 34.1, '74-54': 33.3, '74-55': 32.4, '74-56': 31.6, '74-57': 30.8,
        '74-58': 30.0, '74-59': 29.2, '74-60': 28.4, '74-61': 27.7, '74-62': 27.0, '74-63': 26.2, '74-64': 25.5,
        // Owner Age 75
        '75-40': 45.9, '75-41': 45.0, '75-42': 44.1, '75-43': 43.1, '75-44': 42.2, '75-45': 41.3, '75-46': 40.3, '75-47': 39.4, '75-48': 38.5,
        '75-49': 37.6, '75-50': 36.7, '75-51': 35.8, '75-52': 34.9, '75-53': 34.0, '75-54': 33.2, '75-55': 32.3, '75-56': 31.5, '75-57': 30.7,
        '75-58': 29.8, '75-59': 29.0, '75-60': 28.3, '75-61': 27.5, '75-62': 26.8, '75-63': 26.1, '75-64': 25.3, '75-65': 24.6,
        // Owner Age 76
        '76-40': 45.9, '76-41': 45.0, '76-42': 44.0, '76-43': 43.1, '76-44': 42.2, '76-45': 41.2, '76-46': 40.3, '76-47': 39.4, '76-48': 38.5,
        '76-49': 37.5, '76-50': 36.6, '76-51': 35.7, '76-52': 34.8, '76-53': 33.9, '76-54': 33.1, '76-55': 32.2, '76-56': 31.4, '76-57': 30.5,
        '76-58': 29.7, '76-59': 28.9, '76-60': 28.1, '76-61': 27.3, '76-62': 26.5, '76-63': 25.8, '76-64': 25.1, '76-65': 24.3, '76-66': 23.6,
        // Owner Age 77
        '77-40': 45.9, '77-41': 45.0, '77-42': 44.0, '77-43': 43.1, '77-44': 42.1, '77-45': 41.2, '77-46': 40.3, '77-47': 39.3, '77-48': 38.4,
        '77-49': 37.5, '77-50': 36.6, '77-51': 35.6, '77-52': 34.8, '77-53': 33.9, '77-54': 33.0, '77-55': 32.1, '77-56': 31.2, '77-57': 30.4,
        '77-58': 29.6, '77-59': 28.7, '77-60': 27.9, '77-61': 27.1, '77-62': 26.4, '77-63': 25.6, '77-64': 24.8, '77-65': 24.1, '77-66': 23.4, '77-67': 22.7,
        // Owner Age 78
        '78-40': 45.9, '78-41': 44.9, '78-42': 44.0, '78-43': 43.0, '78-44': 42.1, '78-45': 41.2, '78-46': 40.2, '78-47': 39.3, '78-48': 38.4,
        '78-49': 37.5, '78-50': 36.5, '78-51': 35.6, '78-52': 34.7, '78-53': 33.8, '78-54': 32.9, '78-55': 32.0, '78-56': 31.2, '78-57': 30.3,
        '78-58': 29.5, '78-59': 28.7, '78-60': 27.9, '78-61': 27.1, '78-62': 26.2, '78-63': 25.5, '78-64': 24.7, '78-65': 23.9, '78-66': 23.2, '78-67': 22.5, '78-68': 21.8,
        // Owner Age 79
        '79-40': 45.9, '79-41': 44.9, '79-42': 44.0, '79-43': 43.0, '79-44': 42.1, '79-45': 41.1, '79-46': 40.2, '79-47': 39.3, '79-48': 38.3,
        '79-49': 37.4, '79-50': 36.5, '79-51': 35.6, '79-52': 34.7, '79-53': 33.8, '79-54': 32.9, '79-55': 32.0, '79-56': 31.1, '79-57': 30.3,
        '79-58': 29.5, '79-59': 28.6, '79-60': 27.8, '79-61': 27.0, '79-62': 26.2, '79-63': 25.5, '79-64': 24.7, '79-65': 23.9, '79-66': 23.2, '79-67': 22.5, '79-68': 21.8, '79-69': 21.1,
        // Owner Age 80
        '80-40': 45.9, '80-41': 44.9, '80-42': 43.9, '80-43': 43.0, '80-44': 42.1, '80-45': 41.1, '80-46': 40.2, '80-47': 39.2, '80-48': 38.3,
        '80-49': 37.4, '80-50': 36.5, '80-51': 35.5, '80-52': 34.6, '80-53': 33.7, '80-54': 32.9, '80-55': 32.0, '80-56': 31.1, '80-57': 30.3,
        '80-58': 29.4, '80-59': 28.6, '80-60': 27.8, '80-61': 26.9, '80-62': 26.1, '80-63': 25.3, '80-64': 24.6, '80-65': 23.8, '80-66': 23.1, '80-67': 22.3, '80-68': 21.6, '80-69': 20.9, '80-70': 20.2,
        // Owner Age 81
        '81-40': 45.8, '81-41': 44.9, '81-42': 43.9, '81-43': 43.0, '81-44': 42.0, '81-45': 41.1, '81-46': 40.1, '81-47': 39.2, '81-48': 38.3,
        '81-49': 37.3, '81-50': 36.4, '81-51': 35.5, '81-52': 34.6, '81-53': 33.7, '81-54': 32.8, '81-55': 31.9, '81-56': 31.1, '81-57': 30.2,
        '81-58': 29.3, '81-59': 28.5, '81-60': 27.7, '81-61': 26.9, '81-62': 26.0, '81-63': 25.2, '81-64': 24.5, '81-65': 23.7, '81-66': 22.9, '81-67': 22.2, '81-68': 21.5, '81-69': 20.7, '81-70': 20.0, '81-71': 19.3,
        // Owner Age 82
        '82-40': 45.8, '82-41': 44.9, '82-42': 43.9, '82-43': 43.0, '82-44': 42.0, '82-45': 41.1, '82-46': 40.1, '82-47': 39.2, '82-48': 38.3,
        '82-49': 37.3, '82-50': 36.4, '82-51': 35.5, '82-52': 34.6, '82-53': 33.7, '82-54': 32.8, '82-55': 31.9, '82-56': 31.0, '82-57': 30.1,
        '82-58': 29.3, '82-59': 28.4, '82-60': 27.6, '82-61': 26.8, '82-62': 26.0, '82-63': 25.2, '82-64': 24.4, '82-65': 23.6, '82-66': 22.8, '82-67': 22.1, '82-68': 21.3, '82-69': 20.6, '82-70': 19.9, '82-71': 19.2, '82-72': 18.5,
        // Owner Age 83-92
        '83-50': 36.4, '83-51': 35.4, '83-52': 34.5, '83-53': 33.6, '83-54': 32.7, '83-55': 31.8, '83-56': 31.0, '83-57': 30.1,
        '83-58': 29.2, '83-59': 28.4, '83-60': 27.5, '83-61': 26.7, '83-62': 25.9, '83-63': 25.1, '83-64': 24.3, '83-65': 23.5, '83-66': 22.7, '83-67': 22.0, '83-68': 21.2, '83-69': 20.5, '83-70': 19.7, '83-71': 19.0, '83-72': 18.3, '83-73': 17.7,
        '84-50': 36.3, '84-51': 35.4, '84-52': 34.5, '84-53': 33.6, '84-54': 32.7, '84-55': 31.8, '84-56': 30.9, '84-57': 30.0,
        '84-58': 29.2, '84-59': 28.3, '84-60': 27.5, '84-61': 26.7, '84-62': 25.8, '84-63': 25.0, '84-64': 24.2, '84-65': 23.4, '84-66': 22.6, '84-67': 21.9, '84-68': 21.1, '84-69': 20.4, '84-70': 19.6, '84-71': 18.9, '84-72': 18.2, '84-73': 17.5, '84-74': 16.8,
        '85-50': 36.3, '85-51': 35.4, '85-52': 34.5, '85-53': 33.6, '85-54': 32.7, '85-55': 31.8, '85-56': 30.9, '85-57': 30.0,
        '85-58': 29.1, '85-59': 28.3, '85-60': 27.4, '85-61': 26.6, '85-62': 25.8, '85-63': 24.9, '85-64': 24.1, '85-65': 23.3, '85-66': 22.5, '85-67': 21.8, '85-68': 21.0, '85-69': 20.3, '85-70': 19.5, '85-71': 18.8, '85-72': 18.1, '85-73': 17.4, '85-74': 16.7, '85-75': 16.0,
        '86-50': 36.3, '86-51': 35.4, '86-52': 34.5, '86-53': 33.5, '86-54': 32.6, '86-55': 31.7, '86-56': 30.8, '86-57': 30.0,
        '86-58': 29.1, '86-59': 28.2, '86-60': 27.4, '86-61': 26.5, '86-62': 25.7, '86-63': 24.9, '86-64': 24.1, '86-65': 23.3, '86-66': 22.5, '86-67': 21.7, '86-68': 20.9, '86-69': 20.2, '86-70': 19.4, '86-71': 18.7, '86-72': 17.9, '86-73': 17.2, '86-74': 16.5, '86-75': 15.9, '86-76': 15.2,
        '87-50': 36.3, '87-51': 35.4, '87-52': 34.4, '87-53': 33.5, '87-54': 32.6, '87-55': 31.7, '87-56': 30.8, '87-57': 29.9,
        '87-58': 29.1, '87-59': 28.2, '87-60': 27.4, '87-61': 26.5, '87-62': 25.7, '87-63': 24.9, '87-64': 24.0, '87-65': 23.2, '87-66': 22.4, '87-67': 21.6, '87-68': 20.8, '87-69': 20.1, '87-70': 19.3, '87-71': 18.6, '87-72': 17.8, '87-73': 17.1, '87-74': 16.4, '87-75': 15.7, '87-76': 15.1, '87-77': 14.4,
        '88-50': 36.3, '88-51': 35.3, '88-52': 34.4, '88-53': 33.5, '88-54': 32.6, '88-55': 31.7, '88-56': 30.8, '88-57': 29.9,
        '88-58': 29.0, '88-59': 28.2, '88-60': 27.3, '88-61': 26.5, '88-62': 25.6, '88-63': 24.8, '88-64': 24.0, '88-65': 23.2, '88-66': 22.4, '88-67': 21.6, '88-68': 20.8, '88-69': 20.0, '88-70': 19.2, '88-71': 18.5, '88-72': 17.7, '88-73': 17.0, '88-74': 16.3, '88-75': 15.6, '88-76': 14.9, '88-77': 14.3, '88-78': 13.7,
        '89-50': 36.3, '89-51': 35.3, '89-52': 34.4, '89-53': 33.5, '89-54': 32.6, '89-55': 31.7, '89-56': 30.8, '89-57': 29.9,
        '89-58': 29.0, '89-59': 28.1, '89-60': 27.3, '89-61': 26.4, '89-62': 25.6, '89-63': 24.8, '89-64': 23.9, '89-65': 23.1, '89-66': 22.3, '89-67': 21.5, '89-68': 20.7, '89-69': 20.0, '89-70': 19.2, '89-71': 18.4, '89-72': 17.7, '89-73': 16.9, '89-74': 16.2, '89-75': 15.5, '89-76': 14.8, '89-77': 14.2, '89-78': 13.5, '89-79': 12.9,
        '90-50': 36.3, '90-51': 35.3, '90-52': 34.4, '90-53': 33.5, '90-54': 32.6, '90-55': 31.7, '90-56': 30.8, '90-57': 29.9,
        '90-58': 29.0, '90-59': 28.1, '90-60': 27.3, '90-61': 26.4, '90-62': 25.6, '90-63': 24.7, '90-64': 23.9, '90-65': 23.1, '90-66': 22.3, '90-67': 21.5, '90-68': 20.7, '90-69': 19.9, '90-70': 19.1, '90-71': 18.4, '90-72': 17.6, '90-73': 16.9, '90-74': 16.1, '90-75': 15.4, '90-76': 14.8, '90-77': 14.1, '90-78': 13.4, '90-79': 12.8, '90-80': 12.2,
        '91-50': 36.2, '91-51': 35.3, '91-52': 34.4, '91-53': 33.5, '91-54': 32.5, '91-55': 31.6, '91-56': 30.7, '91-57': 29.9,
        '91-58': 29.0, '91-59': 28.1, '91-60': 27.3, '91-61': 26.4, '91-62': 25.6, '91-63': 24.7, '91-64': 23.9, '91-65': 23.1, '91-66': 22.3, '91-67': 21.5, '91-68': 20.7, '91-69': 19.9, '91-70': 19.1, '91-71': 18.3, '91-72': 17.5, '91-73': 16.8, '91-74': 16.1, '91-75': 15.3, '91-76': 14.6, '91-77': 14.0, '91-78': 13.3, '91-79': 12.7, '91-80': 12.1, '91-81': 11.5,
        '92-50': 36.2, '92-51': 35.3, '92-52': 34.4, '92-53': 33.5, '92-54': 32.5, '92-55': 31.6, '92-56': 30.7, '92-57': 29.8,
        '92-58': 28.9, '92-59': 28.1, '92-60': 27.2, '92-61': 26.4, '92-62': 25.5, '92-63': 24.7, '92-64': 23.9, '92-65': 23.0, '92-66': 22.2, '92-67': 21.4, '92-68': 20.6, '92-69': 19.8, '92-70': 19.0, '92-71': 18.3, '92-72': 17.5, '92-73': 16.7, '92-74': 16.0, '92-75': 15.3, '92-76': 14.6, '92-77': 13.9, '92-78': 13.2, '92-79': 12.6, '92-80': 11.9,
        // Owner Age 93
        '93-60': 27.2, '93-61': 26.4, '93-62': 25.5, '93-63': 24.7, '93-64': 23.8, '93-65': 23.0, '93-66': 22.2, '93-67': 21.4, '93-68': 20.6, '93-69': 19.8, '93-70': 19.0, '93-71': 18.2, '93-72': 17.4, '93-73': 16.7, '93-74': 15.9, '93-75': 15.2, '93-76': 14.5, '93-77': 13.8, '93-78': 13.1, '93-79': 12.5, '93-80': 11.9, '93-81': 11.3, '93-82': 10.7, '93-83': 10.1,
        // Owner Age 94
        '94-60': 27.2, '94-61': 26.3, '94-62': 25.5, '94-63': 24.7, '94-64': 23.8, '94-65': 23.0, '94-66': 22.2, '94-67': 21.4, '94-68': 20.6, '94-69': 19.8, '94-70': 19.0, '94-71': 18.2, '94-72': 17.4, '94-73': 16.6, '94-74': 15.9, '94-75': 15.2, '94-76': 14.4, '94-77': 13.7, '94-78': 13.1, '94-79': 12.4, '94-80': 11.8, '94-81': 11.2, '94-82': 10.6, '94-83': 10.0, '94-84': 9.5,
        // Owner Age 95
        '95-60': 27.2, '95-61': 26.3, '95-62': 25.5, '95-63': 24.6, '95-64': 23.8, '95-65': 23.0, '95-66': 22.2, '95-67': 21.4, '95-68': 20.6, '95-69': 19.7, '95-70': 18.9, '95-71': 18.2, '95-72': 17.4, '95-73': 16.6, '95-74': 15.9, '95-75': 15.1, '95-76': 14.4, '95-77': 13.7, '95-78': 13.0, '95-79': 12.3, '95-80': 11.7, '95-81': 11.1, '95-82': 10.5, '95-83': 9.9, '95-84': 9.4, '95-85': 8.9,
        // Owner Age 96
        '96-60': 27.2, '96-61': 26.3, '96-62': 25.5, '96-63': 24.6, '96-64': 23.8, '96-65': 23.0, '96-66': 22.2, '96-67': 21.3, '96-68': 20.5, '96-69': 19.7, '96-70': 18.9, '96-71': 18.1, '96-72': 17.4, '96-73': 16.6, '96-74': 15.8, '96-75': 15.1, '96-76': 14.3, '96-77': 13.6, '96-78': 12.9, '96-79': 12.3, '96-80': 11.6, '96-81': 11.0, '96-82': 10.4, '96-83': 9.9, '96-84': 9.3, '96-85': 8.8, '96-86': 8.4,
        // Owner Age 97
        '97-60': 27.2, '97-61': 26.3, '97-62': 25.5, '97-63': 24.6, '97-64': 23.8, '97-65': 23.0, '97-66': 22.1, '97-67': 21.3, '97-68': 20.5, '97-69': 19.7, '97-70': 18.9, '97-71': 18.1, '97-72': 17.3, '97-73': 16.6, '97-74': 15.8, '97-75': 15.0, '97-76': 14.3, '97-77': 13.6, '97-78': 12.9, '97-79': 12.2, '97-80': 11.6, '97-81': 11.0, '97-82': 10.4, '97-83': 9.8, '97-84': 9.2, '97-85': 8.7, '97-86': 8.3, '97-87': 7.8,
        // Owner Age 98
        '98-60': 27.2, '98-61': 26.3, '98-62': 25.5, '98-63': 24.6, '98-64': 23.8, '98-65': 22.9, '98-66': 22.1, '98-67': 21.3, '98-68': 20.5, '98-69': 19.7, '98-70': 18.9, '98-71': 18.1, '98-72': 17.3, '98-73': 16.5, '98-74': 15.8, '98-75': 15.0, '98-76': 14.3, '98-77': 13.6, '98-78': 12.9, '98-79': 12.2, '98-80': 11.5, '98-81': 10.9, '98-82': 10.3, '98-83': 9.7, '98-84': 9.2, '98-85': 8.7, '98-86': 8.2, '98-87': 7.7, '98-88': 7.3,
        // Owner Age 99
        '99-60': 27.2, '99-61': 26.3, '99-62': 25.4, '99-63': 24.6, '99-64': 23.8, '99-65': 22.9, '99-66': 22.1, '99-67': 21.3, '99-68': 20.5, '99-69': 19.7, '99-70': 18.9, '99-71': 18.1, '99-72': 17.3, '99-73': 16.5, '99-74': 15.7, '99-75': 15.0, '99-76': 14.3, '99-77': 13.5, '99-78': 12.8, '99-79': 12.2, '99-80': 11.5, '99-81': 10.9, '99-82': 10.2, '99-83': 9.7, '99-84': 9.1, '99-85': 8.6, '99-86': 8.1, '99-87': 7.6, '99-88': 7.2, '99-89': 6.8,
        // Owner Age 100
        '100-70': 18.9, '100-71': 18.1, '100-72': 17.3, '100-73': 16.5, '100-74': 15.7, '100-75': 15.0, '100-76': 14.2, '100-77': 13.5, '100-78': 12.8, '100-79': 12.1, '100-80': 11.5, '100-81': 10.8, '100-82': 10.2, '100-83': 9.6, '100-84': 9.1, '100-85': 8.5, '100-86': 8.0, '100-87': 7.6, '100-88': 7.2, '100-89': 6.8, '100-90': 6.4,
        // Owner Age 101
        '101-70': 18.9, '101-71': 18.1, '101-72': 17.3, '101-73': 16.5, '101-74': 15.7, '101-75': 15.0, '101-76': 14.2, '101-77': 13.5, '101-78': 12.8, '101-79': 12.1, '101-80': 11.4, '101-81': 10.8, '101-82': 10.2, '101-83': 9.6, '101-84': 9.0, '101-85': 8.5, '101-86': 8.0, '101-87': 7.5, '101-88': 7.1, '101-89': 6.7, '101-90': 6.3, '101-91': 6.0,
        // Owner Age 102
        '102-70': 18.8, '102-71': 18.0, '102-72': 17.3, '102-73': 16.5, '102-74': 15.7, '102-75': 14.9, '102-76': 14.2, '102-77': 13.5, '102-78': 12.8, '102-79': 12.1, '102-80': 11.4, '102-81': 10.8, '102-82': 10.1, '102-83': 9.6, '102-84': 9.0, '102-85': 8.5, '102-86': 8.0, '102-87': 7.5, '102-88': 7.0, '102-89': 6.6, '102-90': 6.3, '102-91': 5.9, '102-92': 5.6,
        // Owner Age 103
        '103-70': 18.8, '103-71': 18.0, '103-72': 17.3, '103-73': 16.5, '103-74': 15.7, '103-75': 14.9, '103-76': 14.2, '103-77': 13.5, '103-78': 12.8, '103-79': 12.1, '103-80': 11.4, '103-81': 10.7, '103-82': 10.1, '103-83': 9.5, '103-84': 9.0, '103-85': 8.4, '103-86': 7.9, '103-87': 7.4, '103-88': 7.0, '103-89': 6.6, '103-90': 6.2, '103-91': 5.9, '103-92': 5.5, '103-93': 5.2,
        // Owner Age 104
        '104-70': 18.8, '104-71': 18.0, '104-72': 17.2, '104-73': 16.5, '104-74': 15.7, '104-75': 14.9, '104-76': 14.2, '104-77': 13.5, '104-78': 12.7, '104-79': 12.0, '104-80': 11.4, '104-81': 10.7, '104-82': 10.1, '104-83': 9.5, '104-84': 8.9, '104-85': 8.4, '104-86': 7.9, '104-87': 7.4, '104-88': 7.0, '104-89': 6.6, '104-90': 6.2, '104-91': 5.8, '104-92': 5.5, '104-93': 5.2, '104-94': 4.9,
        // Owner Age 105
        '105-70': 18.8, '105-71': 18.0, '105-72': 17.2, '105-73': 16.5, '105-74': 15.7, '105-75': 14.9, '105-76': 14.2, '105-77': 13.4, '105-78': 12.7, '105-79': 12.0, '105-80': 11.4, '105-81': 10.7, '105-82': 10.1, '105-83': 9.5, '105-84': 8.9, '105-85': 8.4, '105-86': 7.9, '105-87': 7.4, '105-88': 6.9, '105-89': 6.5, '105-90': 6.1, '105-91': 5.8, '105-92': 5.4, '105-93': 5.1, '105-94': 4.9, '105-95': 4.6,
        // Owner Age 106
        '106-70': 18.8, '106-71': 18.0, '106-72': 17.2, '106-73': 16.5, '106-74': 15.7, '106-75': 14.9, '106-76': 14.2, '106-77': 13.4, '106-78': 12.7, '106-79': 12.0, '106-80': 11.4, '106-81': 10.7, '106-82': 10.1, '106-83': 9.5, '106-84': 8.9, '106-85': 8.4, '106-86': 7.9, '106-87': 7.4, '106-88': 6.9, '106-89': 6.5, '106-90': 6.1, '106-91': 5.8, '106-92': 5.4, '106-93': 5.1, '106-94': 4.8, '106-95': 4.6, '106-96': 4.3,
        // Owner Age 107
        '107-70': 18.8, '107-71': 18.0, '107-72': 17.2, '107-73': 16.5, '107-74': 15.7, '107-75': 14.9, '107-76': 14.2, '107-77': 13.4, '107-78': 12.7, '107-79': 12.0, '107-80': 11.4, '107-81': 10.7, '107-82': 10.1, '107-83': 9.5, '107-84': 8.9, '107-85': 8.4, '107-86': 7.9, '107-87': 7.4, '107-88': 6.9, '107-89': 6.5, '107-90': 6.1, '107-91': 5.8, '107-92': 5.4, '107-93': 5.1, '107-94': 4.8, '107-95': 4.6, '107-96': 4.3, '107-97': 4.1,
        // Owner Age 108
        '108-70': 18.8, '108-71': 18.0, '108-72': 17.2, '108-73': 16.5, '108-74': 15.7, '108-75': 14.9, '108-76': 14.2, '108-77': 13.4, '108-78': 12.7, '108-79': 12.0, '108-80': 11.4, '108-81': 10.7, '108-82': 10.1, '108-83': 9.5, '108-84': 8.9, '108-85': 8.4, '108-86': 7.8, '108-87': 7.4, '108-88': 6.9, '108-89': 6.5, '108-90': 6.1, '108-91': 5.7, '108-92': 5.4, '108-93': 5.1, '108-94': 4.8, '108-95': 4.5, '108-96': 4.3, '108-97': 4.1, '108-98': 3.9,
        // Owner Age 109
        '109-70': 18.8, '109-71': 18.0, '109-72': 17.2, '109-73': 16.4, '109-74': 15.7, '109-75': 14.9, '109-76': 14.2, '109-77': 13.4, '109-78': 12.7, '109-79': 12.0, '109-80': 11.3, '109-81': 10.7, '109-82': 10.1, '109-83': 9.5, '109-84': 8.9, '109-85': 8.4, '109-86': 7.8, '109-87': 7.4, '109-88': 6.9, '109-89': 6.5, '109-90': 6.1, '109-91': 5.7, '109-92': 5.4, '109-93': 5.1, '109-94': 4.8, '109-95': 4.5, '109-96': 4.3, '109-97': 4.1, '109-98': 3.9, '109-99': 3.7
    },

    rmdStartAge: 73,

    // Helper: Get RMD start age based on birth year (SECURE 2.0)
    getRMDStartAge: function (birthYear) {
        return birthYear >= 1960 ? 75 : 73;
    },

    // Helper: Look up Joint and Last Survivor factor
    getJointRMDFactor: function (ownerAge, spouseAge) {
        const key = `${ownerAge}-${spouseAge}`;
        if (this.rmdJointFactors[key]) {
            return this.rmdJointFactors[key];
        }
        // If exact match not found, try nearest spouse age
        for (let offset = 1; offset <= 10; offset++) {
            if (this.rmdJointFactors[`${ownerAge}-${spouseAge - offset}`]) {
                return this.rmdJointFactors[`${ownerAge}-${spouseAge - offset}`];
            }
            if (this.rmdJointFactors[`${ownerAge}-${spouseAge + offset}`]) {
                return this.rmdJointFactors[`${ownerAge}-${spouseAge + offset}`];
            }
        }
        return null;
    },

    // ===========================================
    // SELF-EMPLOYMENT TAX 2026
    // ===========================================
    selfEmployment: {
        ssTaxRate: 0.124,           // 12.4% Social Security
        medicareTaxRate: 0.029,      // 2.9% Medicare
        totalRate: 0.153,            // 15.3% combined
        netEarningsFactor: 0.9235,   // 92.35% of gross is taxable
        deductionFactor: 0.5         // 50% of SE tax is deductible
    },

    // ===========================================
    // NIIT (Net Investment Income Tax)
    // ===========================================
    niit: {
        rate: 0.038,
        threshold: { single: 200000, mfj: 250000, mfs: 125000, hoh: 200000 }
    },

    // ===========================================
    // MILEAGE RATES 2026
    // ===========================================
    mileage: {
        business: null,     // TBD per RBC
        medical: null,      // TBD per RBC
        charitable: 0.14,
        moving: null        // TBD per RBC
    },

    // ===========================================
    // SALT DEDUCTION LIMITS (OBBBA 2026)
    // ===========================================
    salt: {
        limit: 40400,           // Standard SALT cap
        limitMFS: 20200,        // Married Filing Separately
        phasedownThreshold: 500000,
        phasedownRate: 0.30,
        phasedownFloor: 10000
    },

    // ===========================================
    // CHILD TAX CREDIT (OBBBA 2026)
    // ===========================================
    childTaxCredit: {
        amount: 2200,
        phaseoutThresholdMFJ: 400000,   // Statutory, not indexed
        phaseoutThresholdOther: 200000, // Statutory, not indexed
        phaseoutRatePer1000: 50
    },

    // ===========================================
    // IRMAA THRESHOLDS 2026 (Medicare Part B)
    // ===========================================
    irmaa: {
        standardPremium: 202.90,
        thresholds: {
            single: [
                { magiMax: 109000, surcharge: 0.0, totalPremium: 202.9 },
                { magiMax: 137000, surcharge: 81.2, totalPremium: 284.1 },
                { magiMax: 171000, surcharge: 202.9, totalPremium: 405.8 },
                { magiMax: 205000, surcharge: 324.6, totalPremium: 527.5 },
                { magiMax: 500000, surcharge: 446.3, totalPremium: 649.2 },
                { magiMax: Infinity, surcharge: 487.0, totalPremium: 689.9 }
            ],
            mfj: [
                { magiMax: 218000, surcharge: 0.0, totalPremium: 202.9 },
                { magiMax: 274000, surcharge: 81.2, totalPremium: 284.1 },
                { magiMax: 342000, surcharge: 202.9, totalPremium: 405.8 },
                { magiMax: 410000, surcharge: 324.6, totalPremium: 527.5 },
                { magiMax: 750000, surcharge: 446.3, totalPremium: 649.2 },
                { magiMax: Infinity, surcharge: 487.0, totalPremium: 689.9 }
            ],
            mfs: [
                { magiMax: 109000, surcharge: 0.0, totalPremium: 202.9 },
                { magiMax: 391000, surcharge: 446.3, totalPremium: 649.2 },
                { magiMax: Infinity, surcharge: 487.0, totalPremium: 689.9 }
            ]
        }
    },

    // ===========================================
    // SOCIAL SECURITY EARNINGS TEST 2026
    // ===========================================
    ssEarningsTest: {
        underFRALimit: 24480,       // Earnings limit for full year under FRA
        fraYearLimit: 65160,        // Earnings limit in year reaching FRA
        reductionRateUnderFRA: 2,   // $1 withheld per $2 over limit
        reductionRateFRAYear: 3     // $1 withheld per $3 over limit
    },

    // ===========================================
    // OBBBA DEDUCTIONS 2026 (One Big Beautiful Bill Act)
    // ===========================================
    obbba: {
        // Senior (65+) Additional Deduction
        senior65Plus: {
            amount: 6000,
            phaseoutThresholdSingle: 75000,
            phaseoutThresholdMFJ: 150000,
            phaseoutRate: 0.06
        },
        // Tips Deduction
        tips: {
            maxDeduction: 25000,
            phaseoutThresholdSingleHOH: 150000,
            phaseoutThresholdMFJ: 300000,
            phaseoutRate: 0.10
        },
        // Overtime Deduction
        overtime: {
            maxSingleHOH: 12500,
            maxMFJ: 25000,
            phaseoutThresholdSingleHOH: 150000,
            phaseoutThresholdMFJ: 300000,
            phaseoutRate: 0.10
        },
        // Auto Loan Interest Deduction
        autoLoanInterest: {
            maxDeduction: 10000,
            phaseoutThresholdSingle: 100000,
            phaseoutThresholdMFJ: 200000,
            phaseoutRate: 0.20
        }
    },

    // ===========================================
    // SECTION 415 LIMITS 2026
    // ===========================================
    section415: {
        totalDCLimit: 72000,        // 415(c) total defined contribution limit
        compensationLimit: 360000   // 401(a)(17) compensation limit
    },

    // ===========================================
    // PAYROLL WITHHOLDING TABLES 2026 (IRS Pub 15-T Worksheet 1A)
    // Used by Cash Flow Calculator for federal withholding estimates
    // Source: IRS Publication 15-T (2026), Pages 10-12
    // ===========================================
    payrollWithholding2026: {
        // Standard deduction adjustment for withholding (Worksheet 1A, Line 1g)
        // If Step 2 box is NOT checked, subtract this from annualized wages
        standardDeductionAdjustment: {
            mfj: 12900,
            single: 8600,
            mfs: 8600,
            hoh: 8600
        },

        // Tax Brackets: { limit, base, rate, excess }
        // limit = "But less than" column (use Infinity for last row)
        // base = Base tax amount
        // rate = Marginal rate as decimal
        // excess = "Excess over" amount
        tables: {
            // Standard tables (Step 2 NOT checked)
            standard: {
                mfj: [
                    { limit: 16100, base: 0, rate: 0.00, excess: 0 },
                    { limit: 44100, base: 0, rate: 0.10, excess: 16100 },
                    { limit: 120100, base: 2800, rate: 0.12, excess: 44100 },
                    { limit: 230700, base: 11920, rate: 0.22, excess: 120100 },
                    { limit: 422850, base: 36252, rate: 0.24, excess: 230700 },
                    { limit: 531750, base: 82368, rate: 0.32, excess: 422850 },
                    { limit: 788000, base: 117216, rate: 0.35, excess: 531750 },
                    { limit: Infinity, base: 206903.50, rate: 0.37, excess: 788000 }
                ],
                single: [
                    { limit: 7500, base: 0, rate: 0.00, excess: 0 },
                    { limit: 19900, base: 0, rate: 0.10, excess: 7500 },
                    { limit: 57900, base: 1240, rate: 0.12, excess: 19900 },
                    { limit: 113200, base: 5800, rate: 0.22, excess: 57900 },
                    { limit: 209275, base: 17966, rate: 0.24, excess: 113200 },
                    { limit: 263725, base: 41024, rate: 0.32, excess: 209275 },
                    { limit: 648100, base: 58448, rate: 0.35, excess: 263725 },
                    { limit: Infinity, base: 192979.25, rate: 0.37, excess: 648100 }
                ],
                hoh: [
                    { limit: 12075, base: 0, rate: 0.00, excess: 0 },
                    { limit: 33250, base: 0, rate: 0.10, excess: 12075 },
                    { limit: 83000, base: 2117.50, rate: 0.12, excess: 33250 },
                    { limit: 121250, base: 8087.50, rate: 0.22, excess: 83000 },
                    { limit: 217300, base: 16502.50, rate: 0.24, excess: 121250 },
                    { limit: 271750, base: 39554.50, rate: 0.32, excess: 217300 },
                    { limit: 656150, base: 56978.50, rate: 0.35, excess: 271750 },
                    { limit: Infinity, base: 191518.50, rate: 0.37, excess: 656150 }
                ]
            },
            // Step 2 Checkbox tables (higher withholding for multiple jobs/spouse works)
            // Source: IRS Pub 15-T 2026, Page 12
            checkbox: {
                mfj: [
                    { limit: 8050, base: 0, rate: 0.00, excess: 0 },
                    { limit: 22050, base: 0, rate: 0.10, excess: 8050 },
                    { limit: 60050, base: 1400, rate: 0.12, excess: 22050 },
                    { limit: 115350, base: 5960, rate: 0.22, excess: 60050 },
                    { limit: 211425, base: 18126, rate: 0.24, excess: 115350 },
                    { limit: 265875, base: 41184, rate: 0.32, excess: 211425 },
                    { limit: 394000, base: 58608, rate: 0.35, excess: 265875 },
                    { limit: Infinity, base: 103451.75, rate: 0.37, excess: 394000 }
                ],
                single: [
                    { limit: 3750, base: 0, rate: 0.00, excess: 0 },
                    { limit: 9950, base: 0, rate: 0.10, excess: 3750 },
                    { limit: 28950, base: 620, rate: 0.12, excess: 9950 },
                    { limit: 56600, base: 2900, rate: 0.22, excess: 28950 },
                    { limit: 104637, base: 8983, rate: 0.24, excess: 56600 },
                    { limit: 131862, base: 20512, rate: 0.32, excess: 104637 },
                    { limit: 324050, base: 29224, rate: 0.35, excess: 131862 },
                    { limit: Infinity, base: 96489.63, rate: 0.37, excess: 324050 }
                ],
                hoh: [
                    { limit: 6037, base: 0, rate: 0.00, excess: 0 },
                    { limit: 16625, base: 0, rate: 0.10, excess: 6037 },
                    { limit: 41500, base: 1058.75, rate: 0.12, excess: 16625 },
                    { limit: 60625, base: 4043.75, rate: 0.22, excess: 41500 },
                    { limit: 108650, base: 8251.25, rate: 0.24, excess: 60625 },
                    { limit: 135875, base: 19777.25, rate: 0.32, excess: 108650 },
                    { limit: 328075, base: 28489.25, rate: 0.35, excess: 135875 },
                    { limit: Infinity, base: 95759.25, rate: 0.37, excess: 328075 }
                ]
            }
        }
    },

    // ===========================================
    // TAX CALCULATION CONSTANTS
    // ===========================================
    taxCalculationRates: {
        medicalExpenseAGIFloor: 0.075,      // 7.5% of AGI
        charitableContributionLimit: 0.60,  // 60% of AGI max
        seNetEarningsFactor: 0.9235,        // 92.35% of gross SE income
        seDeductionFactor: 0.5,             // 50% of SE tax deductible
        sepIraContributionRate: 0.20,       // 20% of net earnings
        amtPhaseoutRate: 0.25               // 25 cents per dollar over threshold
    },

    // ===========================================
    // QBI DEDUCTION (Section 199A) 2026
    // ===========================================
    qbi: {
        deductionRate: 0.20,  // 20% deduction
        thresholds: {
            single: { min: 201750, max: 276750 },
            mfj: { min: 403500, max: 553500 },
            mfs: { min: 201775, max: 276775 },
            hoh: { min: 201750, max: 276750 }
        }
    },

    // ===========================================
    // PASSIVE ACTIVITY LOSS LIMITS (Statutory)
    // ===========================================
    passiveActivityLoss: {
        agiPhaseout: { min: 100000, max: 150000 },
        maxDeduction: 25000
    }
};

// ===========================================
// UTILITY FUNCTIONS
// ===========================================
const TaxCalculator = {
    calculateFederalTax: function (taxableIncome, filingStatus) {
        // Validate input
        if (typeof taxableIncome !== 'number' || isNaN(taxableIncome)) return 0;
        if (taxableIncome < 0) taxableIncome = 0;

        filingStatus = filingStatus || 'mfj';
        const brackets = FinancialConstants.federalBrackets[filingStatus] || FinancialConstants.federalBrackets.mfj;
        let tax = 0, remaining = taxableIncome;
        for (const bracket of brackets) {
            const taxableInBracket = Math.min(remaining, bracket.max - bracket.min);
            tax += taxableInBracket * bracket.rate;
            remaining -= taxableInBracket;
            if (remaining <= 0) break;
        }
        return Math.round(tax * 100) / 100; // Round to cents
    },

    getMarginalRate: function (taxableIncome, filingStatus) {
        filingStatus = filingStatus || 'mfj';
        const brackets = FinancialConstants.federalBrackets[filingStatus] || FinancialConstants.federalBrackets.mfj;
        for (const bracket of brackets) {
            if (taxableIncome <= bracket.max) return bracket.rate;
        }
        return 0.37;
    },

    calculateCapitalGainsTax: function (gain, ordinaryIncome, filingStatus) {
        // Validate inputs
        if (typeof gain !== 'number' || isNaN(gain) || gain < 0) return 0;
        if (typeof ordinaryIncome !== 'number' || isNaN(ordinaryIncome)) ordinaryIncome = 0;

        filingStatus = filingStatus || 'mfj';
        const brackets = FinancialConstants.capitalGainsBrackets[filingStatus] || FinancialConstants.capitalGainsBrackets.mfj;

        // Verify brackets are sorted (defensive check)
        for (let i = 1; i < brackets.length; i++) {
            if (brackets[i].min < brackets[i - 1].min) {
                console.error('Capital gains brackets not sorted correctly');
            }
        }

        let tax = 0, gainRemaining = gain;

        for (const bracket of brackets) {
            if (ordinaryIncome >= bracket.max) continue;
            const spaceInBracket = bracket.max - Math.max(ordinaryIncome, bracket.min);
            const taxableInBracket = Math.min(gainRemaining, spaceInBracket);
            tax += taxableInBracket * bracket.rate;
            gainRemaining -= taxableInBracket;
            if (gainRemaining <= 0) break;
        }
        return Math.round(tax * 100) / 100; // Round to cents
    },

    calculateFICA: function (wages, ytdWages) {
        ytdWages = ytdWages || 0;
        const fica = FinancialConstants.fica;
        const ssWages = Math.min(wages, Math.max(0, fica.socialSecurityWageBase - ytdWages));
        const ssTax = ssWages * fica.socialSecurityRate;
        const medicareTax = wages * fica.medicareRate;
        return { socialSecurity: ssTax, medicare: medicareTax, total: ssTax + medicareTax };
    },

    calculateRMD: function (age, balance) {
        if (age < FinancialConstants.rmdStartAge) return 0;
        // Validate balance - must be non-negative number
        if (typeof balance !== 'number' || isNaN(balance) || balance < 0) {
            console.error('calculateRMD: Invalid balance:', balance);
            return 0;
        }
        // Use factor for age, clamped to 72-120 range
        const clampedAge = Math.max(72, Math.min(age, 120));
        const factor = FinancialConstants.rmdFactors[clampedAge];
        // Guard against missing or invalid factor - fail loudly
        if (!factor || factor <= 0 || isNaN(factor)) {
            console.error(`calculateRMD: Invalid RMD factor for age ${age}:`, factor);
            throw new Error(`Invalid RMD factor for age ${age}. Check rmdFactors table.`);
        }
        return Math.round((balance / factor) * 100) / 100; // Round to cents
    },

    adjustSSBenefit: function (fraBenefit, claimingAge) {
        const factor = FinancialConstants.socialSecurity.claimingFactors[claimingAge] || 1.0;
        return fraBenefit * factor;
    },

    getBracketRoom: function (taxableIncome, targetRate, filingStatus) {
        filingStatus = filingStatus || 'mfj';
        const brackets = FinancialConstants.federalBrackets[filingStatus] || FinancialConstants.federalBrackets.mfj;
        for (const bracket of brackets) {
            if (bracket.rate === targetRate) {
                return Math.max(0, bracket.max - taxableIncome);
            }
        }
        return 0;
    },

    getStandardDeduction: function (filingStatus, age65Plus, blind, numOver65) {
        filingStatus = filingStatus || 'mfj';
        numOver65 = numOver65 || (age65Plus ? 1 : 0);

        let deduction = FinancialConstants.standardDeduction[filingStatus] || FinancialConstants.standardDeduction.mfj;

        // Additional for age 65+ or blind
        const additional = (filingStatus === 'single' || filingStatus === 'hoh')
            ? FinancialConstants.standardDeduction.additionalSingleHOH
            : FinancialConstants.standardDeduction.additionalMFJ;

        deduction += additional * numOver65;
        if (blind) deduction += additional;

        return deduction;
    },

    calculateNIIT: function (magi, netInvestmentIncome, filingStatus) {
        // Validate inputs
        if (typeof magi !== 'number' || isNaN(magi)) return 0;
        if (typeof netInvestmentIncome !== 'number' || isNaN(netInvestmentIncome) || netInvestmentIncome < 0) return 0;

        filingStatus = filingStatus || 'mfj';
        const threshold = FinancialConstants.niit.threshold[filingStatus] || 250000;
        const excessMAGI = Math.max(0, magi - threshold);
        const taxableAmount = Math.min(excessMAGI, netInvestmentIncome);
        return Math.round(taxableAmount * FinancialConstants.niit.rate * 100) / 100;
    }
};

// Make available globally
if (typeof window !== 'undefined') {
    window.FinancialConstants = FinancialConstants;
    window.TaxCalculator = TaxCalculator;
}
